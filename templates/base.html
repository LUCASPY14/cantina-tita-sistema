<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Cantina Tita - POS{% endblock %}</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Sistema de Punto de Venta para Cantina Escolar Tita">
    <meta name="theme-color" content="#FF6B35">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Cantina POS">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="192x192" href="/static/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/icon-16x16.png">
    
    <!-- Tailwind CSS + DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    
    <!-- Howler.js para sonidos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
    
    <!-- Iconos (Heroicons) -->
    <script src="https://unpkg.com/@heroicons/react@2.0.18/outline"></script>
    
    <!-- ConfiguraciÃ³n de Tailwind personalizada -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF6B35',      // Naranja vibrante
                        secondary: '#4ECDC4',    // Turquesa
                        success: '#2ECC71',      // Verde
                        warning: '#F39C12',      // Amarillo/Naranja
                        danger: '#E74C3C',       // Rojo coral
                        neutral: '#34495E',      // Gris azulado
                        'light-bg': '#F8F9FA'    // Fondo claro
                    }
                }
            }
        }
    </script>
    
    <!-- Estilos personalizados -->
    <style>
        /* Botones touch-optimized */
        .btn-touch {
            min-height: 80px;
            min-width: 80px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        /* Grid de productos optimizado */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
        }
        
        /* Carrito sticky */
        .cart-sidebar {
            position: sticky;
            top: 1rem;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }
        
        /* Animaciones suaves */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Loading state */
        .htmx-request .htmx-indicator {
            display: inline;
        }
        
        .htmx-indicator {
            display: none;
        }
        
        /* BÃºsqueda highlight */
        .search-highlight {
            background-color: #FEF3C7;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        /* Scroll suave */
        html {
            scroll-behavior: smooth;
        }
        
        /* Touch feedback */
        .btn-touch:active {
            transform: scale(0.95);
            transition: transform 0.1s;
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body class="bg-light-bg" x-data="posApp()">
    
    <!-- Navbar -->
    <div class="navbar bg-primary text-white shadow-lg">
        <div class="flex-1">
            <a href="{% url 'pos:venta' %}" class="btn btn-ghost text-xl font-bold">
                ğŸ• Cantina Tita POS
            </a>
        </div>
        <div class="flex-none gap-2">
            <!-- Usuario actual -->
            <div class="dropdown dropdown-end">
                <label tabindex="0" class="btn btn-ghost btn-circle avatar placeholder">
                    <div class="bg-secondary text-white rounded-full w-10">
                        <span class="text-xl">{{ request.user.username|first|upper }}</span>
                    </div>
                </label>
                <ul tabindex="0" class="mt-3 z-[1] p-2 shadow menu menu-sm dropdown-content bg-white text-neutral rounded-box w-52">
                    <li class="menu-title">
                        <span class="text-primary">{{ request.user.username }}</span>
                    </li>
                    <li><a href="{% url 'pos:venta' %}">ğŸª Punto de Venta</a></li>
                    <li><a href="{% url 'pos:recargas' %}">ğŸ’³ Recargas</a></li>
                    <li><a href="{% url 'pos:cuenta_corriente' %}">ğŸ“‹ Cuenta Corriente</a></li>
                    <li><a href="{% url 'pos:proveedores' %}">ğŸ­ Proveedores</a></li>
                    <li><a href="{% url 'pos:inventario_dashboard' %}">ğŸ“¦ Inventario</a></li>
                    <li><a href="{% url 'pos:cajas_dashboard' %}">ğŸ’° Cajas</a></li>
                    <li><a href="{% url 'pos:compras_dashboard' %}">ğŸ›’ Compras</a></li>
                    <li><a href="{% url 'pos:comisiones_dashboard' %}">ğŸ’³ Comisiones</a></li>
                    <li><a href="{% url 'pos:almuerzos_dashboard' %}">ğŸ½ï¸ Almuerzos</a></li>
                    <li><a href="{% url 'pos:alertas_sistema' %}">ğŸ”” Alertas</a></li>
                    <li><a href="{% url 'pos:dashboard' %}">ğŸ“Š Dashboard</a></li>
                    <li><a href="{% url 'pos:historial' %}">ğŸ“œ Historial Ventas</a></li>
                    <li><a href="{% url 'pos:reportes' %}">ğŸ“ˆ Reportes</a></li>
                    <li><a href="{% url 'admin:index' %}">âš™ï¸ AdministraciÃ³n</a></li>
                    <li>
                        <form method="post" action="{% url 'logout' %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="text-left w-full" style="background: none; border: none; cursor: pointer; padding: 0;">
                                ğŸšª Cerrar SesiÃ³n
                            </button>
                        </form>
                    </li>
                </ul>
            </div>
            
            <!-- Reloj -->
            <div class="text-sm" x-data="clock()" x-text="time"></div>
        </div>
    </div>
    
    <!-- Contenido principal -->
    <main class="container mx-auto p-4">
        {% block content %}{% endblock %}
    </main>
    
    <!-- Toast de notificaciones -->
    <div class="toast toast-top toast-end z-50" x-show="notification.show" x-transition>
        <div class="alert" :class="{
            'alert-success': notification.type === 'success',
            'alert-error': notification.type === 'error',
            'alert-warning': notification.type === 'warning',
            'alert-info': notification.type === 'info'
        }">
            <span x-text="notification.message"></span>
        </div>
    </div>
    
    <!-- Scripts de Alpine.js -->
    <script>
        // Sonidos
        const sounds = {
            beep: new Howl({ src: ['/static/sounds/beep.mp3'], volume: 0.5 }),
            success: new Howl({ src: ['/static/sounds/success.mp3'], volume: 0.5 }),
            error: new Howl({ src: ['/static/sounds/error.mp3'], volume: 0.5 }),
            scan: new Howl({ src: ['/static/sounds/scan.mp3'], volume: 0.5 })
        };
        
        // FunciÃ³n para reproducir sonidos
        function playSound(type) {
            if (sounds[type]) {
                sounds[type].play();
            }
        }
        
        // Reloj en tiempo real
        function clock() {
            return {
                time: new Date().toLocaleTimeString('es-PY', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                }),
                init() {
                    setInterval(() => {
                        this.time = new Date().toLocaleTimeString('es-PY', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                    }, 1000);
                }
            }
        }
        
        // Estado global de la aplicaciÃ³n POS
        function posApp() {
            return {
                // Carrito de compras
                cart: [],
                
                // Tarjeta seleccionada
                selectedCard: null,
                
                // Notificaciones
                notification: {
                    show: false,
                    message: '',
                    type: 'info'
                },
                
                // Agregar producto al carrito
                addToCart(product) {
                    const existingItem = this.cart.find(item => item.id === product.id);
                    
                    if (existingItem) {
                        existingItem.quantity++;
                    } else {
                        this.cart.push({
                            id: product.id,
                            name: product.name,
                            price: product.price,
                            quantity: 1
                        });
                    }
                    
                    playSound('beep');
                    this.showNotification('Producto agregado', 'success');
                },
                
                // Quitar producto del carrito
                removeFromCart(index) {
                    this.cart.splice(index, 1);
                    playSound('error');
                },
                
                // Incrementar cantidad
                increaseQuantity(index) {
                    this.cart[index].quantity++;
                    playSound('beep');
                },
                
                // Decrementar cantidad
                decreaseQuantity(index) {
                    if (this.cart[index].quantity > 1) {
                        this.cart[index].quantity--;
                        playSound('beep');
                    } else {
                        this.removeFromCart(index);
                    }
                },
                
                // Calcular total
                get total() {
                    return this.cart.reduce((sum, item) => {
                        return sum + (item.price * item.quantity);
                    }, 0);
                },
                
                // Limpiar carrito
                clearCart() {
                    this.cart = [];
                    this.selectedCard = null;
                },
                
                // Mostrar notificaciÃ³n
                showNotification(message, type = 'info') {
                    this.notification = { show: true, message, type };
                    setTimeout(() => {
                        this.notification.show = false;
                    }, 3000);
                },
                
                // Atajos de teclado
                init() {
                    document.addEventListener('keydown', (e) => {
                        // F1 - Cliente genÃ©rico
                        if (e.key === 'F1') {
                            e.preventDefault();
                            this.selectGenericCard();
                        }
                        // F2 - Buscar
                        if (e.key === 'F2') {
                            e.preventDefault();
                            document.getElementById('search-input')?.focus();
                        }
                        // F4 - Cobrar
                        if (e.key === 'F4') {
                            e.preventDefault();
                            this.processSale();
                        }
                        // ESC - Cancelar
                        if (e.key === 'Escape') {
                            e.preventDefault();
                            this.clearCart();
                        }
                    });
                }
            }
        }
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(registration => {
                        console.log('âœ… Service Worker registrado:', registration.scope);
                        
                        // Verificar actualizaciones periÃ³dicamente
                        setInterval(() => {
                            registration.update();
                        }, 60000); // Cada 1 minuto
                        
                        // Solicitar sincronizaciÃ³n en background
                        if ('sync' in registration) {
                            registration.sync.register('sync-sales').catch(err => {
                                console.error('Error al registrar sync:', err);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('âŒ Error al registrar Service Worker:', error);
                    });
                
                // Detectar cambios de conexiÃ³n
                window.addEventListener('online', () => {
                    console.log('ğŸŒ ConexiÃ³n restaurada');
                    showNetworkStatus('Conectado', 'success');
                    
                    // Intentar sincronizar ventas pendientes
                    if (navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({
                            type: 'SYNC_SALES'
                        });
                    }
                });
                
                window.addEventListener('offline', () => {
                    console.log('ğŸ“´ Sin conexiÃ³n');
                    showNetworkStatus('Modo Offline', 'warning');
                });
                
                // Estado inicial
                if (!navigator.onLine) {
                    showNetworkStatus('Modo Offline', 'warning');
                }
            });
        }
        
        function showNetworkStatus(message, type) {
            // Usar sistema de notificaciones de Alpine.js
            if (window.Alpine && window.Alpine.store && window.Alpine.store.notification) {
                const notification = window.Alpine.store.notification;
                notification.show = true;
                notification.message = message;
                notification.type = type;
                
                setTimeout(() => {
                    notification.show = false;
                }, 3000);
            }
        }
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
