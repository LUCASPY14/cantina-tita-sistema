<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Cantina Tita - POS{% endblock %}</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Sistema de Punto de Venta para Cantina Escolar Tita">
    <meta name="theme-color" content="#FF6B35">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Cantina POS">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="192x192" href="/static/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/icon-16x16.png">
    
    <!-- Tailwind CSS + DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    
    <!-- Howler.js para sonidos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
    
    <!-- Iconos (Heroicons) -->
    <script src="https://unpkg.com/@heroicons/react@2.0.18/outline"></script>
    
    <!-- Configuraci√≥n de Tailwind personalizada -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF6B35',      // Naranja vibrante
                        secondary: '#4ECDC4',    // Turquesa
                        success: '#2ECC71',      // Verde
                        warning: '#F39C12',      // Amarillo/Naranja
                        danger: '#E74C3C',       // Rojo coral
                        neutral: '#34495E',      // Gris azulado
                        'light-bg': '#F8F9FA'    // Fondo claro
                    }
                }
            }
        }
    </script>
    
    <!-- Estilos personalizados -->
    <style>
        /* Botones touch-optimized */
        .btn-touch {
            min-height: 80px;
            min-width: 80px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        /* Grid de productos optimizado */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
        }
        
        /* Carrito sticky */
        .cart-sidebar {
            position: sticky;
            top: 1rem;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }
        
        /* Animaciones suaves */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Loading state */
        .htmx-request .htmx-indicator {
            display: inline;
        }
        
        .htmx-indicator {
            display: none;
        }
        
        /* B√∫squeda highlight */
        .search-highlight {
            background-color: #FEF3C7;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        /* Scroll suave */
        html {
            scroll-behavior: smooth;
        }
        
        /* Touch feedback */
        .btn-touch:active {
            transform: scale(0.95);
            transition: transform 0.1s;
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body class="bg-light-bg" x-data="posApp()">
    
    <!-- Navbar -->
    <div class="navbar bg-primary text-white shadow-lg">
        <div class="flex-1">
            <a href="{% url 'pos:venta' %}" class="btn btn-ghost text-xl font-bold">
                üçï Cantina Tita POS
            </a>
        </div>
        <div class="flex-none gap-2">
            <!-- Usuario actual -->
            <div class="dropdown dropdown-end">
                <label tabindex="0" class="btn btn-ghost btn-circle avatar placeholder">
                    <div class="bg-secondary text-white rounded-full w-10">
                        <span class="text-xl">{{ request.user.username|first|upper }}</span>
                    </div>
                </label>
                <ul tabindex="0" class="mt-3 z-[1] p-2 shadow menu menu-sm dropdown-content bg-white text-neutral rounded-box w-52">
                    <li class="menu-title">
                        <span class="text-primary">{{ request.user.username }}</span>
                    </li>
                    <li><a href="{% url 'pos:venta' %}">üè™ Punto de Venta</a></li>
                    <li><a href="{% url 'pos:pos_almuerzo' %}">üçΩÔ∏è POS Almuerzo</a></li>
                    <li><a href="{% url 'pos:recargas' %}">üí≥ Recargas</a></li>
                    <li><a href="{% url 'pos:cuenta_corriente' %}">üìã Cuenta Corriente</a></li>
                    <li><a href="{% url 'pos:proveedores' %}">üè≠ Proveedores</a></li>
                    <li><a href="{% url 'pos:inventario_dashboard' %}">üì¶ Inventario</a></li>
                    <li><a href="{% url 'pos:cajas_dashboard' %}">üí∞ Cajas</a></li>
                    <li><a href="{% url 'pos:compras_dashboard' %}">üõí Compras</a></li>
                    <li><a href="{% url 'pos:comisiones_dashboard' %}">üí≥ Comisiones</a></li>
                    <li><a href="{% url 'pos:almuerzos_dashboard' %}">üçΩÔ∏è Almuerzos</a></li>
                    <li><a href="{% url 'pos:almuerzo_reportes' %}">üìä Reportes Almuerzo</a></li>
                    <li><a href="{% url 'pos:alertas_sistema' %}">üîî Alertas</a></li>
                    <li><a href="{% url 'pos:dashboard' %}">üìä Dashboard</a></li>
                    <li><a href="{% url 'pos:historial' %}">üìú Historial Ventas</a></li>
                    <li><a href="{% url 'pos:reportes' %}">üìà Reportes</a></li>
                    <li><a href="{% url 'admin:index' %}">‚öôÔ∏è Administraci√≥n</a></li>
                    <li>
                        <form method="post" action="{% url 'logout' %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="text-left w-full" style="background: none; border: none; cursor: pointer; padding: 0;">
                                üö™ Cerrar Sesi√≥n
                            </button>
                        </form>
                    </li>
                </ul>
            </div>
            
            <!-- Reloj -->
            <div class="text-sm" x-data="clock()" x-text="time"></div>
        </div>
    </div>
    
    <!-- Contenido principal -->
    <main class="container mx-auto p-4">
        {% block content %}{% endblock %}
    </main>
    
    <!-- Toast de notificaciones -->
    <div class="toast toast-top toast-end z-50" x-show="notification.show" x-transition>
        <div class="alert" :class="{
            'alert-success': notification.type === 'success',
            'alert-error': notification.type === 'error',
            'alert-warning': notification.type === 'warning',
            'alert-info': notification.type === 'info'
        }">
            <span x-text="notification.message"></span>
        </div>
    </div>
    
    <!-- Scripts de Alpine.js -->
    <script>
        // Sonidos
        const sounds = {
            beep: new Howl({ src: ['/static/sounds/beep.mp3'], volume: 0.5 }),
            success: new Howl({ src: ['/static/sounds/success.mp3'], volume: 0.5 }),
            error: new Howl({ src: ['/static/sounds/error.mp3'], volume: 0.5 }),
            scan: new Howl({ src: ['/static/sounds/scan.mp3'], volume: 0.5 })
        };
        
        // Funci√≥n para reproducir sonidos
        function playSound(type) {
            if (sounds[type]) {
                sounds[type].play();
            }
        }
        
        // Reloj en tiempo real
        function clock() {
            return {
                time: new Date().toLocaleTimeString('es-PY', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                }),
                init() {
                    setInterval(() => {
                        this.time = new Date().toLocaleTimeString('es-PY', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                    }, 1000);
                }
            }
        }
        
        // Estado global de la aplicaci√≥n POS
        function posApp() {
            return {
                // Carrito de compras
                cart: [],
                
                // Tarjeta seleccionada
                selectedCard: null,
                
                // Flag para evitar doble procesamiento
                procesandoVenta: false,
                
                // N√∫mero de tarjeta temporal
                cardNumber: '',
                
                // Para productos por kilo
                pesoIndex: null,
                tempProduct: null,
                
                // Para monto personalizado (recargas)
                esRecarga: false,
                
                // Notificaciones
                notification: {
                    show: false,
                    message: '',
                    type: 'info'
                },
                
                // Agregar producto al carrito
                addToCart(product) {
                    // Verificar si es un producto de recarga (precio 0 o nombre contiene "recarga")
                    const esRecarga = product.price === 0 || product.name.toLowerCase().includes('recarga');
                    
                    if (esRecarga) {
                        // Abrir modal para ingresar monto personalizado
                        this.tempProduct = product;
                        this.esRecarga = true;
                        
                        setTimeout(() => {
                            const inputMonto = document.getElementById('input-monto-recarga');
                            if (inputMonto) {
                                inputMonto.value = '10000';
                                inputMonto.focus();
                                inputMonto.select();
                            }
                        }, 100);
                        
                        document.getElementById('modal-monto-recarga').showModal();
                        return;
                    }
                    
                    const existingItem = this.cart.find(item => item.id === product.id && !item.esPorKilo && !item.esRecarga);
                    
                    if (existingItem) {
                        existingItem.quantity++;
                    } else {
                        this.cart.push({
                            id: product.id,
                            name: product.name,
                            price: product.price,
                            quantity: 1,
                            esPorKilo: false,
                            esRecarga: false
                        });
                    }
                    
                    playSound('beep');
                    this.showNotification('Producto agregado', 'success');
                },
                
                // Agregar producto por kilo al carrito
                addProductoPorKilo(product) {
                    // Abrir modal para ingresar peso
                    this.pesoIndex = -1; // -1 indica que es un nuevo producto
                    this.tempProduct = product; // Guardar producto temporalmente
                    
                    // Resetear input de peso
                    setTimeout(() => {
                        const inputPeso = document.getElementById('input-peso');
                        if (inputPeso) {
                            inputPeso.value = '1.0';
                            inputPeso.focus();
                            inputPeso.select();
                        }
                    }, 100);
                    
                    document.getElementById('modal-peso').showModal();
                },
                
                // Editar peso de un producto en el carrito
                editPeso(index) {
                    this.pesoIndex = index;
                    const item = this.cart[index];
                    
                    setTimeout(() => {
                        const inputPeso = document.getElementById('input-peso');
                        if (inputPeso) {
                            inputPeso.value = item.peso || 1.0;
                            inputPeso.focus();
                            inputPeso.select();
                        }
                    }, 100);
                    
                    document.getElementById('modal-peso').showModal();
                },
                
                // Establecer peso r√°pido
                setPeso(peso) {
                    const inputPeso = document.getElementById('input-peso');
                    if (inputPeso) {
                        inputPeso.value = peso;
                    }
                },
                
                // Confirmar peso
                confirmarPeso() {
                    const inputPeso = document.getElementById('input-peso');
                    const peso = parseFloat(inputPeso.value);
                    
                    if (!peso || peso <= 0) {
                        this.showNotification('Ingrese un peso v√°lido', 'error');
                        return;
                    }
                    
                    if (this.pesoIndex === -1) {
                        // Es un producto nuevo
                        const product = this.tempProduct;
                        this.cart.push({
                            id: product.id,
                            name: product.name,
                            price: product.price,
                            peso: peso,
                            quantity: 1, // Siempre 1 para productos por kilo
                            esPorKilo: true
                        });
                        playSound('beep');
                        this.showNotification(`Agregado ${peso}kg`, 'success');
                    } else {
                        // Est√° editando un producto existente
                        this.cart[this.pesoIndex].peso = peso;
                        playSound('beep');
                        this.showNotification(`Peso actualizado: ${peso}kg`, 'success');
                    }
                    
                    // Cerrar modal
                    document.getElementById('modal-peso').close();
                    this.pesoIndex = null;
                    this.tempProduct = null;
                },
                
                // Confirmar monto de recarga
                confirmarMontoRecarga() {
                    const inputMonto = document.getElementById('input-monto-recarga');
                    const monto = parseFloat(inputMonto.value);
                    
                    if (!monto || monto <= 0) {
                        this.showNotification('Ingrese un monto v√°lido', 'error');
                        return;
                    }
                    
                    if (monto < 1000) {
                        this.showNotification('El monto m√≠nimo es Gs. 1.000', 'warning');
                        return;
                    }
                    
                    // Agregar al carrito con el monto personalizado
                    const product = this.tempProduct;
                    this.cart.push({
                        id: product.id,
                        name: product.name,
                        price: monto,  // Usar el monto ingresado como precio
                        quantity: 1,
                        esPorKilo: false,
                        esRecarga: true
                    });
                    
                    playSound('beep');
                    this.showNotification(`Recarga agregada: Gs. ${Math.round(monto).toLocaleString('es-PY')}`, 'success');
                    
                    // Cerrar modal
                    document.getElementById('modal-monto-recarga').close();
                    this.tempProduct = null;
                    this.esRecarga = false;
                },
                
                // Establecer monto r√°pido para recarga
                setMontoRecarga(monto) {
                    const inputMonto = document.getElementById('input-monto-recarga');
                    if (inputMonto) {
                        inputMonto.value = monto;
                    }
                },
                
                // Quitar producto del carrito
                removeFromCart(index) {
                    this.cart.splice(index, 1);
                    playSound('error');
                },
                
                // Incrementar cantidad
                increaseQuantity(index) {
                    this.cart[index].quantity++;
                    playSound('beep');
                },
                
                // Decrementar cantidad
                decreaseQuantity(index) {
                    if (this.cart[index].quantity > 1) {
                        this.cart[index].quantity--;
                        playSound('beep');
                    } else {
                        this.removeFromCart(index);
                    }
                },
                
                // Calcular total
                get total() {
                    return this.cart.reduce((sum, item) => {
                        const precio = parseFloat(item.price) || 0;
                        if (item.esPorKilo) {
                            return sum + (precio * (item.peso || 1));
                        } else {
                            return sum + (precio * (item.quantity || 1));
                        }
                    }, 0);
                },
                
                // Limpiar carrito
                clearCart() {
                    this.cart = [];
                    this.selectedCard = null;
                },
                
                // Mostrar notificaci√≥n
                showNotification(message, type = 'info') {
                    this.notification = { show: true, message, type };
                    setTimeout(() => {
                        this.notification.show = false;
                    }, 3000);
                },
                
                // Escanear tarjeta
                scanCard() {
                    playSound('scan');
                },
                
                // Seleccionar cliente gen√©rico
                selectGenericCard() {
                    this.selectedCard = {
                        id: null,
                        nombre: 'Cliente Gen√©rico',
                        saldo: 999999999
                    };
                    playSound('beep');
                    this.showNotification('Cliente gen√©rico seleccionado', 'info');
                },
                
                // Procesar venta
                processSale() {
                    if (!this.cart || this.cart.length === 0) {
                        this.showNotification('El carrito est√° vac√≠o', 'warning');
                        return;
                    }
                    
                    // Abrir modal de checkout para seleccionar tipo de pago
                    document.getElementById('modal-checkout').showModal();
                },
                
                // Confirmar y procesar venta con el tipo de pago seleccionado
                confirmarCheckout() {
                    // Prevenir doble procesamiento
                    if (this.procesandoVenta) {
                        return;
                    }
                    
                    this.procesandoVenta = true;
                    
                    // Obtener tipo de pago seleccionado
                    const tipoPagoSelect = document.getElementById('tipo-pago-select');
                    const tipoPagoId = tipoPagoSelect ? parseInt(tipoPagoSelect.value) : 1;
                    
                    // Preparar datos de la venta
                    const ventaData = {
                        items: this.cart,
                        tarjeta: this.selectedCard,
                        total: this.total,
                        tipo_pago_id: tipoPagoId
                    };
                    
                    // Cerrar modal
                    document.getElementById('modal-checkout').close();
                    
                    // Enviar al backend
                    fetch('/pos/procesar-venta/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCookie('csrftoken')
                        },
                        body: JSON.stringify(ventaData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        this.procesandoVenta = false;  // Liberar el lock
                        
                        if (data.success) {
                            playSound('success');
                            this.showNotification('¬°Venta exitosa!', 'success');
                            
                            // Guardar ID de venta para el ticket
                            const ventaId = data.venta_id;
                            
                            this.clearCart();
                            
                            // Abrir ticket en nueva ventana
                            if (ventaId) {
                                const ticketWindow = window.open(
                                    `/pos/ticket/${ventaId}/`,
                                    'ticket',
                                    'width=400,height=600,scrollbars=yes'
                                );
                            }
                            
                            // Resetear tarjeta
                            this.selectedCard = null;
                            const nroTarjetaInput = document.querySelector('input[name="nro_tarjeta"]');
                            if (nroTarjetaInput) nroTarjetaInput.value = '';
                            const tarjetaInfo = document.getElementById('tarjeta-info');
                            if (tarjetaInfo) tarjetaInfo.innerHTML = '<div class="alert alert-info"><span>üëÜ Escanee la tarjeta del estudiante</span></div>';
                            
                        } else {
                            this.procesandoVenta = false;  // Liberar el lock
                            playSound('error');
                            this.showNotification(data.error || 'Error al procesar venta', 'error');
                        }
                    })
                    .catch(error => {
                        this.procesandoVenta = false;  // Liberar el lock en caso de error
                        playSound('error');
                        this.showNotification('Error de conexi√≥n', 'error');
                        console.error('Error:', error);
                    });
                },
                
                // Obtener cookie CSRF
                getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                },
                
                // Atajos de teclado
                init() {
                    // Exponer instancia globalmente para acceso desde HTMX
                    window.posAppInstance = this;
                    
                    // Listener para actualizar selectedCard despu√©s del swap de HTMX
                    document.body.addEventListener('htmx:afterSwap', (event) => {
                        if (event.detail.target.id === 'tarjeta-info') {
                            const tarjetaData = document.querySelector('#tarjeta-info [data-tarjeta-id]');
                            
                            if (tarjetaData) {
                                this.selectedCard = {
                                    id: tarjetaData.dataset.tarjetaId,
                                    nombre: tarjetaData.dataset.tarjetaNombre,
                                    saldo: parseFloat(tarjetaData.dataset.tarjetaSaldo),
                                    hijo_id: tarjetaData.dataset.tarjetaHijoId ? parseInt(tarjetaData.dataset.tarjetaHijoId) : null
                                };
                            } else {
                                this.selectedCard = null;
                            }
                        }
                    });
                    
                    document.addEventListener('keydown', (e) => {
                        // F1 - Cliente gen√©rico
                        if (e.key === 'F1') {
                            e.preventDefault();
                            this.selectGenericCard();
                        }
                        // F2 - Buscar
                        if (e.key === 'F2') {
                            e.preventDefault();
                            document.getElementById('search-input')?.focus();
                        }
                        // F4 - Cobrar
                        if (e.key === 'F4') {
                            e.preventDefault();
                            this.processSale();
                        }
                        // ESC - Cancelar
                        if (e.key === 'Escape') {
                            e.preventDefault();
                            this.clearCart();
                        }
                    });
                }
            }
        }
        
        // Funci√≥n helper para agregar productos desde onclick
        function agregarProductoAlCarrito(element) {
            if (!window.posAppInstance) {
                console.error('posAppInstance no est√° disponible');
                return;
            }
            
            const precio = parseFloat(element.dataset.productoPrice) || 0;
            console.log('Precio desde data attribute:', element.dataset.productoPrice);
            console.log('Precio parseado:', precio);
            
            const producto = {
                id: parseInt(element.dataset.productoId),
                name: element.dataset.productoName,
                price: precio
            };
            
            const esPorKilo = element.dataset.esPorKilo === 'true';
            
            if (esPorKilo) {
                window.posAppInstance.addProductoPorKilo(producto);
            } else {
                window.posAppInstance.addToCart(producto);
            }
        }
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registrado:', registration.scope);
                        
                        // Verificar actualizaciones peri√≥dicamente
                        setInterval(() => {
                            registration.update();
                        }, 60000); // Cada 1 minuto
                        
                        // Solicitar sincronizaci√≥n en background
                        if ('sync' in registration) {
                            registration.sync.register('sync-sales').catch(err => {
                                console.error('Error al registrar sync:', err);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå Error al registrar Service Worker:', error);
                    });
                
                // Detectar cambios de conexi√≥n
                window.addEventListener('online', () => {
                    console.log('üåê Conexi√≥n restaurada');
                    showNetworkStatus('Conectado', 'success');
                    
                    // Intentar sincronizar ventas pendientes
                    if (navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({
                            type: 'SYNC_SALES'
                        });
                    }
                });
                
                window.addEventListener('offline', () => {
                    console.log('üì¥ Sin conexi√≥n');
                    showNetworkStatus('Modo Offline', 'warning');
                });
                
                // Estado inicial
                if (!navigator.onLine) {
                    showNetworkStatus('Modo Offline', 'warning');
                }
            });
        }
        
        function showNetworkStatus(message, type) {
            // Usar sistema de notificaciones de Alpine.js
            if (window.Alpine && window.Alpine.store && window.Alpine.store.notification) {
                const notification = window.Alpine.store.notification;
                notification.show = true;
                notification.message = message;
                notification.type = type;
                
                setTimeout(() => {
                    notification.show = false;
                }, 3000);
            }
        }
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
