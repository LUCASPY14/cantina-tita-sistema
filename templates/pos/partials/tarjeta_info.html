{% load paraguay_filters l10n %}
<!-- InformaciÃ³n de la tarjeta escaneada -->
{% if tarjeta %}
<div class="bg-gradient-to-br from-success to-green-600 text-white p-4 rounded-lg fade-in shadow-lg"
     data-tarjeta-id="{{ tarjeta.nro_tarjeta }}"
     data-tarjeta-nombre="{{ tarjeta.estudiante_nombre|escapejs }}"
     data-tarjeta-saldo="{{ tarjeta.saldo_actual|unlocalize }}"
     data-tarjeta-hijo-id="{% if tarjeta.id_hijo %}{{ tarjeta.id_hijo.id_hijo }}{% endif %}">
    <!-- InformaciÃ³n del estudiante -->
    <div class="flex items-start gap-3 mb-3">
        <span class="text-3xl">ğŸ‘¤</span>
        <div class="flex-1">
            <p class="font-bold text-lg">{{ tarjeta.estudiante_nombre }}</p>
            <p class="text-xs opacity-90">Tarjeta: #{{ tarjeta.nro_tarjeta }}</p>
            {% if tarjeta.id_hijo %}
                <p class="text-xs opacity-90 mt-1">
                    ğŸ“š Grado: {{ tarjeta.id_hijo.grado|default:"N/A" }}
                </p>
                {% if tarjeta.id_hijo.id_cliente_responsable %}
                <p class="text-xs opacity-90">
                    ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Responsable: {{ tarjeta.id_hijo.id_cliente_responsable.nombres }} {{ tarjeta.id_hijo.id_cliente_responsable.apellidos }}
                </p>
                {% endif %}
            {% endif %}
        </div>
    </div>
    
    <!-- Saldo disponible -->
    <div class="bg-white/20 backdrop-blur-sm rounded-lg p-3 mb-2">
        <div class="flex justify-between items-center">
            <span class="text-sm font-medium">Saldo Disponible:</span>
            <span class="text-2xl font-bold">
                {{ tarjeta.saldo_actual|guaranies }}
            </span>
        </div>
    </div>
    
    <!-- Saldo despuÃ©s de la venta (Alpine.js calcularÃ¡) -->
    <div class="bg-white/10 rounded-lg p-2" x-data="{ get saldoDespues() { return {{ tarjeta.saldo_actual|unlocalize }} - (window.posAppInstance ? window.posAppInstance.total : 0) } }">
        <div class="flex justify-between items-center text-xs">
            <span>Saldo despuÃ©s de venta:</span>
            <span class="font-bold" :class="saldoDespues >= 0 ? 'text-white' : 'text-red-300'">
                Gs. <span x-text="Math.round(saldoDespues).toLocaleString('es-PY')"></span>
            </span>
        </div>
    </div>
    
    <!-- Alertas -->
    {% if tarjeta.saldo_actual < 5000 %}
    <div class="alert alert-warning mt-3 text-xs py-2">
        <span>âš ï¸ Saldo bajo - Considere recargar</span>
    </div>
    {% endif %}
    
    {% if tarjeta.estado == 'BLOQUEADA' %}
    <div class="alert alert-error mt-3 text-xs py-2">
        <span>ğŸš« Tarjeta bloqueada</span>
    </div>
    {% endif %}
</div>

<script>
    // Actualizar la tarjeta seleccionada en Alpine
    console.log('DEBUG Frontend: Ejecutando script de tarjeta');
    console.log('DEBUG Frontend: window.posAppInstance existe?', !!window.posAppInstance);
    
    if (window.posAppInstance) {
        window.posAppInstance.selectedCard = {
            id: '{{ tarjeta.nro_tarjeta }}',
            nombre: '{{ tarjeta.estudiante_nombre|escapejs }}',
            saldo: {{ tarjeta.saldo_actual }},
            hijo_id: {{ tarjeta.id_hijo.id_hijo|default:'null' }}
        };
        console.log('DEBUG Frontend: selectedCard establecido:', window.posAppInstance.selectedCard);
        if (typeof playSound === 'function') playSound('scan');
    } else {
        console.error('DEBUG Frontend: window.posAppInstance NO estÃ¡ disponible');
    }
</script>

{% else %}
<div class="alert alert-error">
    <span>âŒ Tarjeta no encontrada o inactiva</span>
</div>

<script>
    playSound('error');
</script>
{% endif %}
