{% load paraguay_filters l10n %}
<!-- Informaci√≥n de la tarjeta escaneada -->
{% if tarjeta %}
<div class="bg-gradient-to-br from-success to-green-600 text-white p-4 rounded-lg fade-in shadow-lg"
     data-tarjeta-id="{{ tarjeta.nro_tarjeta }}"
     data-tarjeta-nombre="{{ tarjeta.estudiante_nombre|escapejs }}"
     data-tarjeta-saldo="{{ tarjeta.saldo_actual|unlocalize }}"
     data-tarjeta-hijo-id="{% if tarjeta.id_hijo %}{{ tarjeta.id_hijo.id_hijo }}{% endif %}">
    
    <!-- Informaci√≥n del estudiante con foto -->
    <div class="flex items-start gap-4 mb-3">
        <!-- Foto de perfil -->
        {% if tarjeta.tiene_foto %}
        <div class="flex-shrink-0">
            <img src="{{ tarjeta.foto_url }}" 
                 alt="{{ tarjeta.estudiante_nombre }}"
                 class="w-24 h-24 rounded-lg object-cover border-4 border-white/30 shadow-lg">
        </div>
        {% else %}
        <div class="flex-shrink-0 w-24 h-24 bg-white/20 rounded-lg flex items-center justify-center text-4xl border-4 border-white/30">
            üë§
        </div>
        {% endif %}
        
        <!-- Datos del estudiante -->
        <div class="flex-1">
            <p class="font-bold text-xl">{{ tarjeta.estudiante_nombre }}</p>
            <p class="text-sm opacity-90">Tarjeta: #{{ tarjeta.nro_tarjeta }}</p>
            {% if tarjeta.id_hijo %}
                <p class="text-sm opacity-90 mt-1">
                    üìö Grado: {{ tarjeta.id_hijo.grado|default:"N/A" }}
                </p>
                {% if tarjeta.id_hijo.id_cliente_responsable %}
                <p class="text-sm opacity-90">
                    üë®‚Äçüë©‚Äçüëß Responsable: {{ tarjeta.id_hijo.id_cliente_responsable.nombres }} {{ tarjeta.id_hijo.id_cliente_responsable.apellidos }}
                </p>
                {% endif %}
                
                <!-- Alerta si no tiene foto -->
                {% if not tarjeta.tiene_foto %}
                <p class="text-xs bg-warning text-warning-content px-2 py-1 rounded mt-2 inline-block">
                    ‚ö†Ô∏è Sin foto de identificaci√≥n
                </p>
                {% endif %}
            {% endif %}
        </div>
    </div>
    
    <!-- Saldo disponible -->
    <div class="bg-white/20 backdrop-blur-sm rounded-lg p-3 mb-2">
        <div class="flex justify-between items-center">
            <span class="text-sm font-medium">Saldo Disponible:</span>
            <span class="text-2xl font-bold">
                {{ tarjeta.saldo_actual|guaranies }}
            </span>
        </div>
    </div>
    
    <!-- Saldo despu√©s de la venta (Alpine.js calcular√°) -->
    <div class="bg-white/10 rounded-lg p-2" x-data="{ get saldoDespues() { return {{ tarjeta.saldo_actual|unlocalize }} - (window.posAppInstance ? window.posAppInstance.total : 0) } }">
        <div class="flex justify-between items-center text-xs">
            <span>Saldo despu√©s de venta:</span>
            <span class="font-bold" :class="saldoDespues >= 0 ? 'text-white' : 'text-red-300'">
                Gs. <span x-text="Math.round(saldoDespues).toLocaleString('es-PY')"></span>
            </span>
        </div>
    </div>
    
    <!-- Restricciones de compra -->
    
    <!-- Restricciones de compra -->
    {% if tarjeta.id_hijo.restricciones_compra %}
    <div class="alert alert-warning mt-3 text-sm py-3 bg-red-100 border-2 border-red-400">
        <div class="flex gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-red-600 shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
            <div>
                <div class="font-bold text-red-800 mb-1">‚ö†Ô∏è RESTRICCIONES DE COMPRA:</div>
                <div class="text-red-700 whitespace-pre-wrap text-xs">{{ tarjeta.id_hijo.restricciones_compra }}</div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Alertas -->
    {% if tarjeta.saldo_actual < 5000 %}
    <div class="alert alert-warning mt-3 text-xs py-2">
        <span>‚ö†Ô∏è Saldo bajo - Considere recargar</span>
    </div>
    {% endif %}
    
    {% if tarjeta.estado == 'BLOQUEADA' %}
    <div class="alert alert-error mt-3 text-xs py-2">
        <span>üö´ Tarjeta bloqueada</span>
    </div>
    {% endif %}
</div>

<script>
    // Actualizar la tarjeta seleccionada en Alpine
    console.log('DEBUG Frontend: Ejecutando script de tarjeta');
    console.log('DEBUG Frontend: window.posAppInstance existe?', !!window.posAppInstance);
    
    if (window.posAppInstance) {
        window.posAppInstance.selectedCard = {
            id: '{{ tarjeta.nro_tarjeta }}',
            nombre: '{{ tarjeta.estudiante_nombre|escapejs }}',
            saldo: {{ tarjeta.saldo_actual|unlocalize }},
            hijo_id: {{ tarjeta.id_hijo.id_hijo|default:'null' }},
            tiene_restricciones: {% if tarjeta.id_hijo.restricciones_compra %}true{% else %}false{% endif %},
            restricciones: `{{ tarjeta.id_hijo.restricciones_compra|escapejs }}`,
            nombre_completo: '{{ tarjeta.id_hijo.nombre|escapejs }} {{ tarjeta.id_hijo.apellido|escapejs }}',
            grado: '{{ tarjeta.id_hijo.grado|default:"" }}'
        };
        console.log('‚úÖ Tarjeta cargada:', window.posAppInstance.selectedCard);
        
        {% if tarjeta.id_hijo.restricciones_compra %}
        console.log('‚ö†Ô∏è RESTRICCIONES DETECTADAS para tarjeta {{ tarjeta.nro_tarjeta }}');
        window.posAppInstance.showNotification('‚ö†Ô∏è Esta tarjeta tiene restricciones alimentarias', 'warning');
        {% else %}
        window.posAppInstance.showNotification('‚úÖ Tarjeta cargada: {{ tarjeta.estudiante_nombre|escapejs }}', 'success');
        {% endif %}
        
        if (typeof playSound === 'function') playSound('scan');
    } else {
        console.error('‚ùå ERROR: window.posAppInstance NO est√° disponible');
    }
</script>

{% else %}
<div class="alert alert-error">
    <span>‚ùå Tarjeta no encontrada o inactiva</span>
</div>

<script>
    if (window.posAppInstance) {
        window.posAppInstance.showNotification('‚ùå Tarjeta no encontrada o inactiva', 'error');
    }
    if (typeof playSound === 'function') playSound('error');
</script>
{% endif %}
