{% extends 'base.html' %}
{% load static %}

{% block title %}Gesti√≥n de Fotos - Hijos{% endblock %}

{% block extra_css %}
<style>
    .foto-preview {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 8px;
    }
    .sin-foto {
        width: 120px;
        height: 120px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        color: white;
    }
    #videoPreview {
        width: 100%;
        max-width: 640px;
        height: auto;
        border-radius: 8px;
    }
    #canvasCaptura {
        display: none;
    }
    .hijo-card {
        transition: all 0.3s ease;
    }
    .hijo-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-7xl">
    
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">üì∏ Gesti√≥n de Fotos de Identificaci√≥n</h1>
            <p class="text-gray-600 mt-2">Administre las fotos de los estudiantes para verificaci√≥n en el POS</p>
        </div>
        <a href="{% url 'pos:venta' %}" class="btn btn-outline">
            ‚Üê Volver al POS
        </a>
    </div>

    <!-- Estad√≠sticas -->
    <div class="stats stats-vertical lg:stats-horizontal shadow mb-8 w-full">
        <div class="stat">
            <div class="stat-figure text-primary">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
            </div>
            <div class="stat-title">Total Estudiantes</div>
            <div class="stat-value text-primary">{{ total_hijos }}</div>
        </div>
        
        <div class="stat">
            <div class="stat-figure text-success">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </div>
            <div class="stat-title">Con Foto</div>
            <div class="stat-value text-success">{{ con_foto }}</div>
            <div class="stat-desc">{{ con_foto|floatformat:0 }}% del total</div>
        </div>
        
        <div class="stat">
            <div class="stat-figure text-warning">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <div class="stat-title">Sin Foto</div>
            <div class="stat-value text-warning">{{ sin_foto_count }}</div>
            <div class="stat-desc">Pendientes de captura</div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card bg-base-100 shadow-lg mb-6">
        <div class="card-body">
            <form method="get" class="flex flex-wrap gap-4 items-end">
                <div class="form-control flex-1 min-w-[200px]">
                    <label class="label">
                        <span class="label-text">üîç Buscar estudiante</span>
                    </label>
                    <input type="text" name="buscar" value="{{ buscar }}" 
                           placeholder="Nombre, apellido o n√∫mero de tarjeta..." 
                           class="input input-bordered w-full">
                </div>
                
                <div class="form-control">
                    <label class="label cursor-pointer gap-2">
                        <input type="checkbox" name="sin_foto" value="1" 
                               class="checkbox checkbox-warning"
                               {% if filtro_sin_foto %}checked{% endif %}>
                        <span class="label-text">Solo sin foto</span>
                    </label>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    Buscar
                </button>
                
                {% if buscar or filtro_sin_foto %}
                <a href="{% url 'gestionar_fotos_hijos' %}" class="btn btn-ghost">
                    Limpiar
                </a>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Lista de Hijos -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {% for hijo in hijos %}
        <div class="card bg-base-100 shadow-lg hijo-card">
            <div class="card-body p-4">
                <!-- Foto -->
                <div class="flex justify-center mb-4">
                    {% if hijo.foto_perfil %}
                        <img src="{{ hijo.foto_perfil.url }}" alt="{{ hijo.nombre_completo }}" 
                             class="foto-preview">
                    {% else %}
                        <div class="sin-foto">
                            {{ hijo.nombre.0 }}{{ hijo.apellido.0 }}
                        </div>
                    {% endif %}
                </div>
                
                <!-- Info -->
                <h3 class="font-bold text-lg text-center">{{ hijo.nombre_completo }}</h3>
                
                {% if hijo.tarjeta %}
                <div class="badge badge-outline w-full justify-center mt-2">
                    üé´ {{ hijo.tarjeta.nro_tarjeta }}
                </div>
                {% endif %}
                
                {% if hijo.fecha_foto %}
                <p class="text-xs text-center text-gray-500 mt-2">
                    üìÖ {{ hijo.fecha_foto|date:"d/m/Y H:i" }}
                </p>
                {% endif %}
                
                <!-- Botones -->
                <div class="card-actions justify-center mt-4 gap-2">
                    <button onclick="abrirCamara({{ hijo.id_hijo }}, '{{ hijo.nombre_completo }}')" 
                            class="btn btn-sm btn-primary">
                        {% if hijo.foto_perfil %}
                            üîÑ Recapturar
                        {% else %}
                            üì∑ Capturar
                        {% endif %}
                    </button>
                    
                    {% if hijo.foto_perfil %}
                    <button onclick="eliminarFoto({{ hijo.id_hijo }}, '{{ hijo.nombre_completo }}')" 
                            class="btn btn-sm btn-error btn-outline">
                        üóëÔ∏è
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-span-full">
            <div class="alert alert-info">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>No se encontraron estudiantes con los filtros aplicados.</span>
            </div>
        </div>
        {% endfor %}
    </div>

</div>

<!-- Modal de Captura de Webcam -->
<dialog id="modalCamara" class="modal">
    <div class="modal-box max-w-3xl">
        <h3 class="font-bold text-2xl mb-4">üì∑ Capturar Foto</h3>
        <p class="text-lg mb-6">Estudiante: <span id="nombreHijo" class="font-semibold"></span></p>
        
        <div class="flex flex-col items-center gap-4">
            <!-- Video Preview -->
            <video id="videoPreview" autoplay playsinline class="border-4 border-primary rounded-lg"></video>
            
            <!-- Canvas oculto para captura -->
            <canvas id="canvasCaptura"></canvas>
            
            <!-- Botones -->
            <div class="flex gap-4">
                <button id="btnCapturar" class="btn btn-primary btn-lg">
                    üì∏ Capturar Foto
                </button>
                <button onclick="cerrarCamara()" class="btn btn-outline btn-lg">
                    Cancelar
                </button>
            </div>
            
            <!-- Mensaje -->
            <div id="mensajeCamara" class="hidden"></div>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button onclick="detenerCamara()">close</button>
    </form>
</dialog>

{% endblock %}

{% block extra_js %}
<script>
let stream = null;
let hijoIdActual = null;

// Abrir c√°mara
async function abrirCamara(hijoId, nombreCompleto) {
    hijoIdActual = hijoId;
    document.getElementById('nombreHijo').textContent = nombreCompleto;
    document.getElementById('modalCamara').showModal();
    
    try {
        // Solicitar acceso a la c√°mara
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: 'user'
            } 
        });
        
        const video = document.getElementById('videoPreview');
        video.srcObject = stream;
        
    } catch (error) {
        console.error('Error al acceder a la c√°mara:', error);
        mostrarMensaje('‚ùå No se pudo acceder a la c√°mara: ' + error.message, 'error');
    }
}

// Capturar foto
document.getElementById('btnCapturar').addEventListener('click', async function() {
    const video = document.getElementById('videoPreview');
    const canvas = document.getElementById('canvasCaptura');
    const ctx = canvas.getContext('2d');
    
    // Configurar canvas con tama√±o del video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    // Dibujar frame actual del video en canvas
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Convertir a base64
    const imagenBase64 = canvas.toDataURL('image/png');
    
    // Enviar al servidor
    try {
        mostrarMensaje('‚è≥ Guardando foto...', 'info');
        
        const formData = new FormData();
        formData.append('imagen', imagenBase64);
        
        const response = await fetch(`/pos/hijo/${hijoIdActual}/capturar-foto/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarMensaje('‚úÖ ' + data.message, 'success');
            setTimeout(() => {
                cerrarCamara();
                location.reload(); // Recargar para ver foto actualizada
            }, 1500);
        } else {
            mostrarMensaje('‚ùå ' + data.message, 'error');
        }
        
    } catch (error) {
        console.error('Error:', error);
        mostrarMensaje('‚ùå Error al guardar foto', 'error');
    }
});

// Cerrar y detener c√°mara
function cerrarCamara() {
    detenerCamara();
    document.getElementById('modalCamara').close();
}

function detenerCamara() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
}

// Eliminar foto
async function eliminarFoto(hijoId, nombreCompleto) {
    if (!confirm(`¬øEliminar la foto de ${nombreCompleto}?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/pos/hijo/${hijoId}/eliminar-foto/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ ' + data.message);
            location.reload();
        } else {
            alert('‚ùå ' + data.message);
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al eliminar foto');
    }
}

// Mostrar mensaje en modal
function mostrarMensaje(texto, tipo) {
    const div = document.getElementById('mensajeCamara');
    div.className = `alert alert-${tipo === 'error' ? 'error' : tipo === 'success' ? 'success' : 'info'}`;
    div.textContent = texto;
    div.classList.remove('hidden');
    
    if (tipo === 'success' || tipo === 'error') {
        setTimeout(() => div.classList.add('hidden'), 3000);
    }
}

// Obtener cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Limpiar al cerrar ventana
window.addEventListener('beforeunload', detenerCamara);
</script>
{% endblock %}
