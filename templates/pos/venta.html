{% extends 'base.html' %}

{% block title %}POS - Punto de Venta | Cantina Tita{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    
    <!-- Columna izquierda: Productos (2/3) -->
    <div class="lg:col-span-2">
        
        <!-- B√∫squeda de productos -->
        <div class="card bg-white shadow-xl mb-4">
            <div class="card-body p-4">
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        id="search-input"
                        placeholder="üîç Buscar producto o escanear c√≥digo... (F2)" 
                        class="input input-bordered input-lg w-full text-lg"
                        hx-post="{% url 'pos:buscar_productos' %}"
                        hx-trigger="keyup changed delay:300ms"
                        hx-target="#productos-grid"
                        hx-indicator="#search-loading"
                        name="q"
                        autocomplete="off"
                        autofocus
                    >
                    <button class="btn btn-secondary btn-lg">
                        <span id="search-loading" class="loading loading-spinner htmx-indicator"></span>
                        <span>üîç</span>
                    </button>
                </div>
                
                <!-- Filtros r√°pidos -->
                <div class="flex gap-2 mt-3 flex-wrap">
                    <button 
                        class="btn btn-sm btn-outline"
                        hx-get="{% url 'pos:productos_categoria' %}?categoria=todos"
                        hx-target="#productos-grid"
                    >
                        Todos
                    </button>
                    <button 
                        class="btn btn-sm btn-outline"
                        hx-get="{% url 'pos:productos_categoria' %}?categoria=bebidas"
                        hx-target="#productos-grid"
                    >
                        ü•§ Bebidas
                    </button>
                    <button 
                        class="btn btn-sm btn-outline"
                        hx-get="{% url 'pos:productos_categoria' %}?categoria=snacks"
                        hx-target="#productos-grid"
                    >
                        üçø Snacks
                    </button>
                    <button 
                        class="btn btn-sm btn-outline"
                        hx-get="{% url 'pos:productos_categoria' %}?categoria=almuerzos"
                        hx-target="#productos-grid"
                    >
                        üç± Almuerzos
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Grid de productos -->
        <div id="productos-grid" class="product-grid">
            {% include 'pos/partials/productos_grid.html' %}
        </div>
        
    </div>
    
    <!-- Columna derecha: Carrito y cobro (1/3) -->
    <div class="lg:col-span-1">
        <div class="cart-sidebar">
            
            <!-- Tarjeta del estudiante -->
            <div class="card bg-white shadow-xl mb-4">
                <div class="card-body p-4">
                    <h3 class="font-bold text-lg mb-3">üí≥ Tarjeta</h3>
                    
                    <input 
                        type="text" 
                        placeholder="Escanear o escribir N¬∞ tarjeta..."
                        class="input input-bordered w-full mb-2"
                        x-model="cardNumber"
                        @keyup.enter="scanCard()"
                        hx-post="{% url 'pos:buscar_tarjeta' %}"
                        hx-trigger="keyup[key=='Enter']"
                        hx-target="#tarjeta-info"
                        hx-include="[name='csrfmiddlewaretoken']"
                        name="nro_tarjeta"
                    >
                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                    
                    <div id="tarjeta-info">
                        <div class="alert alert-info">
                            <span>üëÜ Escanee la tarjeta del estudiante</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-sm btn-outline w-full mt-2" @click="selectGenericCard()">
                        Cliente Gen√©rico (F1)
                    </button>
                </div>
            </div>
            
            <!-- Carrito de compras -->
            <div class="card bg-white shadow-xl mb-4">
                <div class="card-body p-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg">üõí Carrito</h3>
                        <button 
                            class="btn btn-xs btn-ghost text-danger"
                            @click="clearCart()"
                            x-show="cart.length > 0"
                        >
                            Limpiar
                        </button>
                    </div>
                    
                    <!-- Items del carrito -->
                    <div class="space-y-2 mb-4 max-h-96 overflow-y-auto">
                        <template x-for="(item, index) in cart" :key="index">
                            <div class="flex items-center gap-2 p-2 bg-base-200 rounded-lg fade-in">
                                <div class="flex-1">
                                    <p class="font-semibold text-sm" x-text="item.name"></p>
                                    <p class="text-xs text-gray-600">
                                        <span x-show="!item.esPorKilo">
                                            Gs. <span x-text="Math.round(item.price || 0).toLocaleString('es-PY')"></span>
                                        </span>
                                        <span x-show="item.esPorKilo">
                                            Gs. <span x-text="Math.round(item.price || 0).toLocaleString('es-PY')"></span>/kg
                                            √ó <span x-text="item.peso"></span>kg
                                            = Gs. <span x-text="Math.round((item.price || 0) * (item.peso || 1)).toLocaleString('es-PY')"></span>
                                        </span>
                                    </p>
                                </div>
                                <div class="flex items-center gap-1">
                                    <!-- Mostrar peso editable en vez de cantidad si es por kilo -->
                                    <template x-if="item.esPorKilo">
                                        <button 
                                            class="btn btn-xs btn-outline"
                                            @click="editPeso(index)"
                                        >
                                            ‚öñÔ∏è <span x-text="item.peso"></span>kg
                                        </button>
                                    </template>
                                    
                                    <!-- Controles de cantidad normal -->
                                    <template x-if="!item.esPorKilo">
                                        <div class="flex items-center gap-1">
                                            <button 
                                                class="btn btn-xs btn-circle" 
                                                @click="decreaseQuantity(index)"
                                            >
                                                -
                                            </button>
                                            <span class="w-8 text-center font-bold" x-text="item.quantity"></span>
                                            <button 
                                                class="btn btn-xs btn-circle" 
                                                @click="increaseQuantity(index)"
                                            >
                                                +
                                            </button>
                                        </div>
                                    </template>
                                </div>
                                <button 
                                    class="btn btn-xs btn-circle btn-error"
                                    @click="removeFromCart(index)"
                                >
                                    √ó
                                </button>
                            </div>
                        </template>
                        
                        <!-- Carrito vac√≠o -->
                        <div class="text-center py-8 text-gray-400" x-show="cart.length === 0">
                            <p class="text-4xl mb-2">üõí</p>
                            <p>El carrito est√° vac√≠o</p>
                        </div>
                    </div>
                    
                    <!-- Total -->
                    <div class="border-t pt-3">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-lg font-bold">TOTAL:</span>
                            <span class="text-2xl font-bold text-primary">
                                Gs. <span x-text="Math.round(total).toLocaleString('es-PY')"></span>
                            </span>
                        </div>
                        
                        <!-- Bot√≥n de cobro -->
                        <button 
                            class="btn btn-primary btn-lg w-full btn-touch"
                            @click="processSale()"
                            :disabled="cart.length === 0"
                            x-show="cart.length > 0"
                        >
                            üí∞ COBRAR (F4)
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Accesos r√°pidos -->
            <div class="card bg-white shadow-xl">
                <div class="card-body p-4">
                    <h3 class="font-bold text-sm mb-2">‚ö° Atajos</h3>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="bg-base-200 p-2 rounded">
                            <kbd class="kbd kbd-xs">F1</kbd> Gen√©rico
                        </div>
                        <div class="bg-base-200 p-2 rounded">
                            <kbd class="kbd kbd-xs">F2</kbd> Buscar
                        </div>
                        <div class="bg-base-200 p-2 rounded">
                            <kbd class="kbd kbd-xs">F4</kbd> Cobrar
                        </div>
                        <div class="bg-base-200 p-2 rounded">
                            <kbd class="kbd kbd-xs">ESC</kbd> Cancelar
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
</div>

<!-- Modal de peso -->
<dialog id="modal-peso" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">‚öñÔ∏è Ingresar Peso</h3>
        <div class="form-control">
            <label class="label">
                <span class="label-text font-semibold">Peso en kilogramos:</span>
            </label>
            <input 
                type="number" 
                id="input-peso"
                step="0.1" 
                min="0.1" 
                value="1.0"
                class="input input-bordered input-lg text-center text-2xl"
                @keyup.enter="confirmarPeso()"
            >
            <label class="label">
                <span class="label-text-alt">Ejemplos: 0.2, 0.5, 1.0, 1.5</span>
            </label>
        </div>
        
        <!-- Botones r√°pidos -->
        <div class="grid grid-cols-4 gap-2 mt-4">
            <button class="btn btn-outline" @click="setPeso(0.2)">0.2 kg</button>
            <button class="btn btn-outline" @click="setPeso(0.5)">0.5 kg</button>
            <button class="btn btn-outline" @click="setPeso(1.0)">1.0 kg</button>
            <button class="btn btn-outline" @click="setPeso(1.5)">1.5 kg</button>
        </div>
        
        <div class="modal-action">
            <button class="btn" onclick="document.getElementById('modal-peso').close()">
                Cancelar
            </button>
            <button class="btn btn-primary" @click="confirmarPeso()">
                Aceptar
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Modal de confirmaci√≥n de venta -->
<dialog id="modal-confirmar-venta" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg text-success">‚úÖ ¬°Venta Exitosa!</h3>
        <p class="py-4">La venta se registr√≥ correctamente.</p>
        <div class="modal-action">
            <button class="btn" onclick="document.getElementById('modal-confirmar-venta').close()">
                Cerrar
            </button>
            <button class="btn btn-primary" onclick="window.print()">
                üñ®Ô∏è Imprimir Ticket
            </button>
        </div>
    </div>
</dialog>
{% endblock %}

{% block extra_js %}
<script>
    // Funci√≥n para procesar la venta
    function processSale() {
        const app = Alpine.store || window;
        
        if (!this.cart || this.cart.length === 0) {
            this.showNotification('El carrito est√° vac√≠o', 'warning');
            return;
        }
        
        // Preparar datos de la venta
        const ventaData = {
            items: this.cart,
            tarjeta: this.selectedCard,
            total: this.total
        };
        
        // Enviar al backend
        fetch('{% url "pos:procesar_venta" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(ventaData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                playSound('success');
                this.showNotification('¬°Venta exitosa!', 'success');
                
                // Guardar ID de venta para el ticket
                const ventaId = data.venta_id;
                
                this.clearCart();
                
                // Abrir ticket en nueva ventana
                if (ventaId) {
                    const ticketWindow = window.open(
                        `/pos/ticket/${ventaId}/`,
                        'ticket',
                        'width=400,height=600,scrollbars=yes'
                    );
                    
                    // Auto-imprimir despu√©s de 1 segundo (opcional)
                    // setTimeout(() => {
                    //     if (ticketWindow) ticketWindow.print();
                    // }, 1000);
                }
                
                // Resetear tarjeta
                this.selectedCard = null;
                document.getElementById('nro_tarjeta').value = '';
                document.getElementById('tarjeta-info').innerHTML = '';
                
            } else {
                playSound('error');
                this.showNotification(data.error || 'Error al procesar venta', 'error');
            }
        })
        .catch(error => {
            playSound('error');
            this.showNotification('Error de conexi√≥n', 'error');
            console.error('Error:', error);
        });
        });
    }
    
    // Funci√≥n para escanear tarjeta
    function scanCard() {
        playSound('scan');
    }
    
    // Funci√≥n para cliente gen√©rico
    function selectGenericCard() {
        this.selectedCard = {
            id: null,
            nombre: 'Cliente Gen√©rico',
            saldo: 999999999
        };
        playSound('beep');
        this.showNotification('Cliente gen√©rico seleccionado', 'info');
    }
    
    // Obtener cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
