{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard Administrativo | Cantina Tita{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
<style>
    :root {
        --primary: #667eea;
        --secondary: #764ba2;
        --success: #2ecc71;
        --warning: #f39c12;
        --danger: #e74c3c;
        --info: #3498db;
    }
    
    /* Cards con gradientes */
    .stat-card {
        border-radius: 15px;
        padding: 1.5rem;
        transition: all 0.3s ease;
        border: none;
        position: relative;
        overflow: hidden;
    }
    
    .stat-card:before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    
    .stat-card.primary:before {
        background: linear-gradient(90deg, #667eea, #764ba2);
    }
    
    .stat-card.success:before {
        background: linear-gradient(90deg, #2ecc71, #27ae60);
    }
    
    .stat-card.warning:before {
        background: linear-gradient(90deg, #f39c12, #e67e22);
    }
    
    .stat-card.danger:before {
        background: linear-gradient(90deg, #e74c3c, #c0392b);
    }
    
    .stat-card.info:before {
        background: linear-gradient(90deg, #3498db, #2980b9);
    }
    
    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0.5rem 0;
        color: #2c3e50;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #7f8c8d;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .stat-icon {
        font-size: 3rem;
        opacity: 0.2;
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
    }
    
    .stat-change {
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .stat-change.positive {
        color: var(--success);
    }
    
    .stat-change.negative {
        color: var(--danger);
    }
    
    /* Tabla mejorada */
    .modern-table {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .modern-table thead {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
    }
    
    .modern-table tbody tr {
        transition: background 0.2s;
    }
    
    .modern-table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    /* Gr√°ficos */
    .chart-container {
        position: relative;
        height: 300px;
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    /* Acciones r√°pidas */
    .quick-action {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s;
        border: 2px solid transparent;
        cursor: pointer;
    }
    
    .quick-action:hover {
        transform: translateY(-3px);
        border-color: var(--primary);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
    }
    
    .quick-action i {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    /* Alertas */
    .alert-custom {
        border-radius: 10px;
        border-left: 4px solid;
        background: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .alert-custom.alert-warning {
        border-left-color: var(--warning);
    }
    
    .alert-custom.alert-danger {
        border-left-color: var(--danger);
    }
    
    /* Badge mejorado */
    .badge-modern {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    /* Header del dashboard */
    .dashboard-header {
        background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }
    
    /* Loading skeleton */
    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 4px;
    }
    
    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .stat-value {
            font-size: 2rem;
        }
        .stat-icon {
            font-size: 2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4" x-data="dashboardApp()">
    
    <!-- Header del Dashboard -->
    <div class="dashboard-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">üìä Dashboard Administrativo</h1>
                <p class="mb-0 opacity-75">
                    <i class="far fa-calendar"></i> {{ hoy|date:"l, d 'de' F 'de' Y" }}
                    <span class="mx-3">|</span>
                    <i class="far fa-clock"></i> <span x-text="currentTime"></span>
                    <span class="mx-3">|</span>
                    <i class="fas fa-user"></i> {{ request.user.username|upper }}
                </p>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <button class="btn btn-light me-2" @click="refreshData">
                    <i class="fas fa-sync-alt" :class="{'fa-spin': loading}"></i> Actualizar
                </button>
                <a href="{% url 'pos:venta' %}" class="btn btn-outline-light">
                    <i class="fas fa-arrow-left"></i> Volver al POS
                </a>
            </div>
        </div>
    </div>

    <!-- Estad√≠sticas Principales -->
    <div class="row mb-4">
        <!-- Total Ventas Hoy -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card primary">
                <div class="stat-icon">üí∞</div>
                <div class="stat-label">Ventas Hoy</div>
                <div class="stat-value">{{ total_ventas|default:0 }}</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i> {{ total_ventas|default:0 }} transacciones
                </div>
            </div>
        </div>
        
        <!-- Ingresos del D√≠a -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card success">
                <div class="stat-icon">üíµ</div>
                <div class="stat-label">Ingresos Hoy</div>
                <div class="stat-value">‚Ç≤{{ monto_total|floatformat:0|intcomma|default:"0" }}</div>
                <div class="stat-change">
                    Promedio: ‚Ç≤{{ promedio_venta|floatformat:0|intcomma|default:"0" }}
                </div>
            </div>
        </div>
        
        <!-- Productos Vendidos -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card warning">
                <div class="stat-icon">üì¶</div>
                <div class="stat-label">Productos Vendidos</div>
                <div class="stat-value">{{ total_productos_vendidos|default:0 }}</div>
                <div class="stat-change">
                    {{ productos_diferentes|default:0 }} productos diferentes
                </div>
            </div>
        </div>
        
        <!-- Almuerzos Registrados -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card info">
                <div class="stat-icon">üçΩÔ∏è</div>
                <div class="stat-label">Almuerzos Hoy</div>
                <div class="stat-value">{{ total_almuerzos|default:0 }}</div>
                <div class="stat-change">
                    Activo: {{ almuerzos_activos|default:0 }}
                </div>
            </div>
        </div>
    </div>

    <!-- Estad√≠sticas Secundarias -->
    <div class="row mb-4">
        <!-- Cargas de Saldo -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card">
                <div class="stat-icon">üí≥</div>
                <div class="stat-label">Cargas de Saldo</div>
                <div class="stat-value">{{ total_cargas|default:0 }}</div>
                <div class="stat-change">
                    ‚Ç≤{{ monto_cargas|floatformat:0|intcomma|default:"0" }}
                </div>
            </div>
        </div>
        
        <!-- Stock Bajo -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card danger">
                <div class="stat-icon">‚ö†Ô∏è</div>
                <div class="stat-label">Productos Bajo Stock</div>
                <div class="stat-value">{{ productos_bajo_stock|default:0 }}</div>
                <div class="stat-change negative">
                    <i class="fas fa-exclamation-triangle"></i> Requiere atenci√≥n
                </div>
            </div>
        </div>
        
        <!-- Clientes Activos -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-label">Clientes Hoy</div>
                <div class="stat-value">{{ clientes_unicos|default:0 }}</div>
                <div class="stat-change">
                    Clientes √∫nicos
                </div>
            </div>
        </div>
        
        <!-- Pendientes -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card warning">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-label">Pagos Pendientes</div>
                <div class="stat-value">{{ pagos_pendientes|default:0 }}</div>
                <div class="stat-change">
                    ‚Ç≤{{ monto_pendiente|floatformat:0|intcomma|default:"0" }}
                </div>
            </div>
        </div>
    </div>

    <!-- Gr√°ficos y Tablas -->
    <div class="row mb-4">
        <!-- Gr√°fico de Ventas por Hora -->
        <div class="col-lg-8 mb-4">
            <div class="chart-container">
                <canvas id="ventasHoraChart"></canvas>
            </div>
        </div>
        
        <!-- Distribuci√≥n de Medios de Pago -->
        <div class="col-lg-4 mb-4">
            <div class="chart-container">
                <canvas id="mediosPagoChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Acciones R√°pidas -->
    <div class="row mb-4">
        <div class="col-12">
            <h4 class="mb-3">‚ö° Acciones R√°pidas</h4>
        </div>
        <div class="col-lg-2 col-md-4 col-6 mb-3">
            <a href="{% url 'pos:venta' %}" class="quick-action text-decoration-none">
                <i class="fas fa-cash-register" style="color: #667eea;"></i>
                <div>Nueva Venta</div>
            </a>
        </div>
        <div class="col-lg-2 col-md-4 col-6 mb-3">
            <a href="{% url 'pos:pos_almuerzo' %}" class="quick-action text-decoration-none">
                <i class="fas fa-utensils" style="color: #f39c12;"></i>
                <div>Almuerzos</div>
            </a>
        </div>
        <div class="col-lg-2 col-md-4 col-6 mb-3">
            <a href="{% url 'pos:recargas' %}" class="quick-action text-decoration-none">
                <i class="fas fa-wallet" style="color: #2ecc71;"></i>
                <div>Cargar Saldo</div>
            </a>
        </div>
        <div class="col-lg-2 col-md-4 col-6 mb-3">
            <a href="{% url 'pos:inventario_productos' %}" class="quick-action text-decoration-none">
                <i class="fas fa-boxes" style="color: #3498db;"></i>
                <div>Inventario</div>
            </a>
        </div>
        <div class="col-lg-2 col-md-4 col-6 mb-3">
            <a href="{% url 'pos:reportes' %}" class="quick-action text-decoration-none">
                <i class="fas fa-chart-line" style="color: #9b59b6;"></i>
                <div>Reportes</div>
            </a>
        </div>
        <div class="col-lg-2 col-md-4 col-6 mb-3">
            <a href="{% url 'admin:index' %}" class="quick-action text-decoration-none">
                <i class="fas fa-cog" style="color: #e74c3c;"></i>
                <div>Configuraci√≥n</div>
            </a>
        </div>
    </div>

    <!-- Productos M√°s Vendidos y √öltimas Ventas -->
    <div class="row mb-4">
        <!-- Top Productos -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">üèÜ Top 10 Productos M√°s Vendidos</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table modern-table mb-0">
                            <thead>
                                <tr>
                                    <th width="5%">#</th>
                                    <th>Producto</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-end">Ingresos</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for producto in productos_vendidos|slice:":10" %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>
                                        <strong>{{ producto.id_producto__descripcion }}</strong>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge badge-modern bg-primary">
                                            {{ producto.cantidad_total }}
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <strong>‚Ç≤{{ producto.ingresos|floatformat:0|intcomma }}</strong>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">
                                        No hay ventas registradas hoy
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- √öltimas Ventas -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">üïí √öltimas Ventas</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table modern-table mb-0">
                            <thead>
                                <tr>
                                    <th>Hora</th>
                                    <th>Cliente</th>
                                    <th class="text-end">Monto</th>
                                    <th class="text-center">Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for venta in ultimas_ventas|slice:":10" %}
                                <tr>
                                    <td>{{ venta.fecha|date:"H:i" }}</td>
                                    <td>
                                        {% if venta.id_cliente %}
                                            {{ venta.id_cliente.nombres }} {{ venta.id_cliente.apellidos }}
                                        {% elif venta.id_hijo %}
                                            {{ venta.id_hijo.nombre_completo }}
                                        {% else %}
                                            Cliente General
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        <strong>‚Ç≤{{ venta.monto_total|floatformat:0|intcomma }}</strong>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge badge-modern bg-success">
                                            <i class="fas fa-check"></i> Completado
                                        </span>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">
                                        No hay ventas registradas hoy
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertas y Notificaciones -->
    {% if productos_bajo_stock > 0 or pagos_pendientes > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <h4 class="mb-3">üîî Alertas y Notificaciones</h4>
        </div>
        
        {% if productos_bajo_stock > 0 %}
        <div class="col-lg-6 mb-3">
            <div class="alert alert-custom alert-warning">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">Stock Bajo</h6>
                        <p class="mb-0">
                            Hay {{ productos_bajo_stock }} producto{{ productos_bajo_stock|pluralize }} con stock bajo.
                            <a href="{% url 'pos:inventario_productos' %}" class="alert-link">Ver detalles ‚Üí</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if pagos_pendientes > 0 %}
        <div class="col-lg-6 mb-3">
            <div class="alert alert-custom alert-danger">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">Pagos Pendientes</h6>
                        <p class="mb-0">
                            Tienes {{ pagos_pendientes }} pago{{ pagos_pendientes|pluralize }} pendiente{{ pagos_pendientes|pluralize }} de validar.
                            <a href="{% url 'pos:lista_pagos_pendientes' %}" class="alert-link">Validar ahora ‚Üí</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
function dashboardApp() {
    return {
        loading: false,
        currentTime: new Date().toLocaleTimeString('es-PY'),
        
        init() {
            // Actualizar reloj cada segundo
            setInterval(() => {
                this.currentTime = new Date().toLocaleTimeString('es-PY');
            }, 1000);
            
            // Inicializar gr√°ficos
            this.initCharts();
        },
        
        refreshData() {
            this.loading = true;
            setTimeout(() => {
                location.reload();
            }, 500);
        },
        
        initCharts() {
            // Gr√°fico de Ventas por Hora
            const ventasCtx = document.getElementById('ventasHoraChart');
            if (ventasCtx) {
                new Chart(ventasCtx, {
                    type: 'line',
                    data: {
                        labels: [{% for item in evolucion_hora %}'{{ item.hora }}:00'{% if not forloop.last %},{% endif %}{% endfor %}],
                        datasets: [{
                            label: 'Ventas',
                            data: [{% for item in evolucion_hora %}{{ item.ventas }}{% if not forloop.last %},{% endif %}{% endfor %}],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Ventas por Hora',
                                font: { size: 16, weight: 'bold' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { precision: 0 }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico de Medios de Pago
            const pagoCtx = document.getElementById('mediosPagoChart');
            if (pagoCtx) {
                new Chart(pagoCtx, {
                    type: 'doughnut',
                    data: {
                        labels: [{% for item in ingresos_pago %}'{{ item.id_medio_pago__descripcion }}'{% if not forloop.last %},{% endif %}{% endfor %}],
                        datasets: [{
                            data: [{% for item in ingresos_pago %}{{ item.total }}{% if not forloop.last %},{% endif %}{% endfor %}],
                            backgroundColor: [
                                '#667eea',
                                '#f39c12',
                                '#2ecc71',
                                '#e74c3c',
                                '#3498db'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            title: {
                                display: true,
                                text: 'Medios de Pago',
                                font: { size: 16, weight: 'bold' }
                            }
                        }
                    }
                });
            }
        }
    }
}
</script>
{% endblock %}
