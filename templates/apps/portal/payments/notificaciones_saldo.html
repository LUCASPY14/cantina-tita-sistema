{% extends 'portal/base_portal.html' %}
{% load static %}
{% load custom_filters %}
{% load humanize %}

{% block title %}Notificaciones - Portal Padres{% endblock %}

{% block extra_css %}
<style>
    .notificacion-card {
        border-left: 4px solid #6c757d;
        transition: all 0.3s ease;
    }
    
    .notificacion-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .notificacion-card.saldo-bajo {
        border-left-color: #ffc107;
        background-color: #fff9e6;
    }
    
    .notificacion-card.saldo-negativo {
        border-left-color: #dc3545;
        background-color: #ffe6e6;
    }
    
    .notificacion-card.saldo-critico {
        border-left-color: #ff6b6b;
        background-color: #ffebee;
    }
    
    .notificacion-card.regularizado {
        border-left-color: #28a745;
        background-color: #e6ffe6;
    }
    
    .notificacion-card.leida {
        opacity: 0.7;
        background-color: #f8f9fa;
    }
    
    .badge-tipo {
        font-size: 0.75rem;
        padding: 0.35rem 0.65rem;
    }
    
    .icono-notificacion {
        font-size: 2rem;
        opacity: 0.8;
    }
    
    .saldo-monto {
        font-size: 1.5rem;
        font-weight: 700;
    }
    
    .stats-card {
        border-radius: 12px;
        padding: 1.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .stats-icon {
        font-size: 3rem;
        opacity: 0.3;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- Encabezado -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-bell text-primary me-2"></i>
                        Notificaciones de Saldo
                    </h2>
                    <p class="text-muted mb-0">Alertas sobre el saldo de las tarjetas de sus hijos</p>
                </div>
                <div>
                    <button class="btn btn-outline-primary" onclick="marcarTodasLeidas()">
                        <i class="fas fa-check-double me-2"></i>
                        Marcar todas como leídas
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas Rápidas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card text-center">
                <i class="fas fa-bell stats-icon"></i>
                <div class="mt-2">
                    <h3 class="mb-0">{{ total_notificaciones }}</h3>
                    <small>Total Notificaciones</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <i class="fas fa-envelope-open stats-icon"></i>
                <div class="mt-2">
                    <h3 class="mb-0">{{ no_leidas }}</h3>
                    <small>No Leídas</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                <i class="fas fa-exclamation-triangle stats-icon"></i>
                <div class="mt-2">
                    <h3 class="mb-0">{{ saldo_bajo_count }}</h3>
                    <small>Saldo Bajo</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center" style="background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%);">
                <i class="fas fa-credit-card stats-icon"></i>
                <div class="mt-2">
                    <h3 class="mb-0">{{ saldo_negativo_count }}</h3>
                    <small>Saldo Negativo</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Tipo de Notificación</label>
                            <select name="tipo" class="form-select" onchange="this.form.submit()">
                                <option value="">Todas</option>
                                <option value="SALDO_BAJO" {% if filtro_tipo == 'SALDO_BAJO' %}selected{% endif %}>Saldo Bajo</option>
                                <option value="SALDO_NEGATIVO" {% if filtro_tipo == 'SALDO_NEGATIVO' %}selected{% endif %}>Saldo Negativo</option>
                                <option value="SALDO_CRITICO" {% if filtro_tipo == 'SALDO_CRITICO' %}selected{% endif %}>Saldo Crítico</option>
                                <option value="REGULARIZADO" {% if filtro_tipo == 'REGULARIZADO' %}selected{% endif %}>Regularizado</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Tarjeta</label>
                            <select name="tarjeta" class="form-select" onchange="this.form.submit()">
                                <option value="">Todas</option>
                                {% for tarjeta in tarjetas_hijos %}
                                <option value="{{ tarjeta.nro_tarjeta }}" {% if filtro_tarjeta == tarjeta.nro_tarjeta %}selected{% endif %}>
                                    {{ tarjeta.id_hijo.nombre_completo }} - {{ tarjeta.nro_tarjeta }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Estado</label>
                            <select name="leida" class="form-select" onchange="this.form.submit()">
                                <option value="">Todas</option>
                                <option value="0" {% if filtro_leida == '0' %}selected{% endif %}>No leídas</option>
                                <option value="1" {% if filtro_leida == '1' %}selected{% endif %}>Leídas</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <a href="{% url 'gestion:portal_notificaciones_saldo' %}" class="btn btn-secondary w-100">
                                <i class="fas fa-redo me-2"></i>
                                Limpiar Filtros
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Notificaciones -->
    <div class="row">
        <div class="col-12">
            {% if notificaciones %}
                {% for notif in notificaciones %}
                <div class="card notificacion-card mb-3 {{ notif.tipo_notificacion|lower }} {% if notif.leida %}leida{% endif %}" 
                     data-notif-id="{{ notif.id_notificacion }}">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <!-- Icono según tipo -->
                                <div class="icono-notificacion">
                                    {% if notif.tipo_notificacion == 'SALDO_BAJO' %}
                                        <i class="fas fa-exclamation-circle text-warning"></i>
                                    {% elif notif.tipo_notificacion == 'SALDO_NEGATIVO' %}
                                        <i class="fas fa-times-circle text-danger"></i>
                                    {% elif notif.tipo_notificacion == 'SALDO_CRITICO' %}
                                        <i class="fas fa-radiation text-danger"></i>
                                    {% else %}
                                        <i class="fas fa-check-circle text-success"></i>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <span class="badge badge-tipo {% if notif.tipo_notificacion == 'SALDO_BAJO' %}bg-warning text-dark{% elif notif.tipo_notificacion == 'SALDO_NEGATIVO' %}bg-danger{% elif notif.tipo_notificacion == 'REGULARIZADO' %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ notif.get_tipo_notificacion_display }}
                                        </span>
                                        {% if not notif.leida %}
                                        <span class="badge bg-primary ms-2">NUEVA</span>
                                        {% endif %}
                                    </div>
                                    <div class="text-end">
                                        <small class="text-muted">
                                            <i class="far fa-clock me-1"></i>
                                            {{ notif.fecha_creacion|date:"d/m/Y H:i" }}
                                        </small>
                                    </div>
                                </div>
                                
                                <h5 class="mb-2">
                                    <i class="fas fa-id-card me-2"></i>
                                    Tarjeta {{ notif.nro_tarjeta.nro_tarjeta }}
                                    <small class="text-muted">- {{ notif.nro_tarjeta.id_hijo.nombre_completo }}</small>
                                </h5>
                                
                                <div class="mb-2">
                                    <strong>Saldo al momento:</strong>
                                    <span class="saldo-monto {% if notif.saldo_actual < 0 %}text-danger{% elif notif.saldo_actual < notif.nro_tarjeta.saldo_alerta %}text-warning{% else %}text-success{% endif %}">
                                        {% if notif.saldo_actual < 0 %}-{% endif %}Gs. {{ notif.saldo_actual|abs|floatformat:0|stringformat:"d"|intcomma:"." }}
                                    </span>
                                </div>
                                
                                <p class="mb-2">{{ notif.mensaje }}</p>
                                
                                <div class="d-flex gap-2">
                                    {% if notif.saldo_actual < 0 or notif.saldo_actual < notif.nro_tarjeta.saldo_alerta %}
                                    <a href="{% url 'gestion:portal_recargar_tarjeta' notif.nro_tarjeta.nro_tarjeta %}" class="btn btn-sm btn-success">
                                        <i class="fas fa-plus-circle me-1"></i>
                                        Recargar Ahora
                                    </a>
                                    {% endif %}
                                    
                                    {% if not notif.leida %}
                                    <button class="btn btn-sm btn-outline-primary" onclick="marcarLeida({{ notif.id_notificacion }})">
                                        <i class="fas fa-check me-1"></i>
                                        Marcar como leída
                                    </button>
                                    {% endif %}
                                    
                                    <a href="{% url 'gestion:portal_mis_hijos' %}" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-chart-line me-1"></i>
                                        Ver Movimientos
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}

                <!-- Paginación -->
                {% if is_paginated %}
                <nav aria-label="Paginación de notificaciones">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% if filtro_tipo %}&tipo={{ filtro_tipo }}{% endif %}{% if filtro_tarjeta %}&tarjeta={{ filtro_tarjeta }}{% endif %}{% if filtro_leida %}&leida={{ filtro_leida }}{% endif %}">Primera</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if filtro_tipo %}&tipo={{ filtro_tipo }}{% endif %}{% if filtro_tarjeta %}&tarjeta={{ filtro_tarjeta }}{% endif %}{% if filtro_leida %}&leida={{ filtro_leida }}{% endif %}">Anterior</a>
                        </li>
                        {% endif %}

                        <li class="page-item active">
                            <span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
                        </li>

                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if filtro_tipo %}&tipo={{ filtro_tipo }}{% endif %}{% if filtro_tarjeta %}&tarjeta={{ filtro_tarjeta }}{% endif %}{% if filtro_leida %}&leida={{ filtro_leida }}{% endif %}">Siguiente</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if filtro_tipo %}&tipo={{ filtro_tipo }}{% endif %}{% if filtro_tarjeta %}&tarjeta={{ filtro_tarjeta }}{% endif %}{% if filtro_leida %}&leida={{ filtro_leida }}{% endif %}">Última</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}

            {% else %}
                <div class="card shadow-sm">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">No hay notificaciones</h4>
                        <p class="text-muted mb-0">No se encontraron notificaciones con los filtros seleccionados.</p>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
async function marcarLeida(idNotificacion) {
    try {
        const response = await fetch(`/api/portal/notificaciones/${idNotificacion}/marcar-leida/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });

        const data = await response.json();

        if (data.success) {
            // Actualizar UI
            const card = document.querySelector(`[data-notif-id="${idNotificacion}"]`);
            if (card) {
                card.classList.add('leida');
                const badgeNueva = card.querySelector('.badge.bg-primary');
                if (badgeNueva) badgeNueva.remove();
                
                const btnMarcar = card.querySelector('button[onclick*="marcarLeida"]');
                if (btnMarcar) btnMarcar.remove();
            }
            
            // Recargar para actualizar contadores
            setTimeout(() => location.reload(), 1000);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al marcar notificación como leída');
    }
}

async function marcarTodasLeidas() {
    if (!confirm('¿Marcar todas las notificaciones como leídas?')) return;

    try {
        const notificaciones = document.querySelectorAll('[data-notif-id]');
        for (const card of notificaciones) {
            const id = card.dataset.notifId;
            if (!card.classList.contains('leida')) {
                await marcarLeida(id);
            }
        }
        
        location.reload();
    } catch (error) {
        console.error('Error:', error);
        alert('Error al marcar notificaciones');
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
