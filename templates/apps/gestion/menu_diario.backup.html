{% extends 'base.html' %}
{% load static %}

{% block title %}Menú Diario{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6" x-data="menuDiario()">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800">
            <i class="fas fa-calendar-alt text-orange-500 mr-2"></i>
            Menú Diario de Almuerzos
        </h1>
        <p class="text-gray-600 mt-2">Visualiza el menú del día y próximos almuerzos</p>
    </div>

    <!-- Selector de Fecha -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="card bg-base-100 shadow-md md:col-span-1">
            <div class="card-body">
                <h3 class="font-semibold mb-2">Seleccionar Fecha</h3>
                <input type="date" 
                       x-model="fechaSeleccionada"
                       @change="cargarMenu()"
                       class="input input-bordered" />
                <div class="flex gap-2 mt-2">
                    <button @click="diaAnterior()" class="btn btn-sm btn-outline flex-1">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button @click="seleccionarHoy()" class="btn btn-sm btn-primary flex-1">
                        Hoy
                    </button>
                    <button @click="diaSiguiente()" class="btn btn-sm btn-outline flex-1">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Información del Día -->
        <div class="md:col-span-3">
            <div class="card bg-gradient-to-br from-orange-500 to-orange-600 text-white shadow-xl">
                <div class="card-body">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-3xl font-bold mb-2" x-text="fechaFormateada"></h2>
                            <p class="text-lg opacity-90" x-text="diaSemana"></p>
                            <div class="badge badge-lg bg-white/20 border-0 mt-2">
                                <i class="fas fa-users mr-2"></i>
                                <span x-text="suscripcionesActivas"></span> estudiantes activos
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm opacity-80">Consumo Esperado</div>
                            <div class="text-4xl font-bold" x-text="consumoEsperado + '%'"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Menú del Día -->
    <div class="card bg-base-100 shadow-md mb-6">
        <div class="card-body">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">
                    <i class="fas fa-utensils mr-2 text-orange-500"></i>
                    Menú del Día
                </h2>
                <button @click="editarMenu()" class="btn btn-primary btn-sm">
                    <i class="fas fa-edit mr-2"></i>Editar Menú
                </button>
            </div>

            <div x-show="!menuCargado" class="text-center py-12">
                <span class="loading loading-spinner loading-lg text-primary"></span>
                <p class="mt-4 text-gray-500">Cargando menú...</p>
            </div>

            <div x-show="menuCargado && !tieneMenu" class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <h3 class="font-bold">No hay menú configurado</h3>
                    <div class="text-sm">No se ha definido el menú para esta fecha. Haz clic en "Editar Menú" para configurarlo.</div>
                </div>
            </div>

            <div x-show="menuCargado && tieneMenu" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Entrada -->
                <div class="border rounded-lg p-4 bg-gradient-to-br from-green-50 to-green-100">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="avatar placeholder">
                            <div class="bg-green-500 text-white rounded-full w-12">
                                <i class="fas fa-leaf text-xl"></i>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg">Entrada</h3>
                            <p class="text-sm text-gray-600">Primer plato</p>
                        </div>
                    </div>
                    <p class="text-gray-800 font-medium" x-text="menu.entrada || 'No especificado'"></p>
                </div>

                <!-- Plato Principal -->
                <div class="border rounded-lg p-4 bg-gradient-to-br from-orange-50 to-orange-100">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="avatar placeholder">
                            <div class="bg-orange-500 text-white rounded-full w-12">
                                <i class="fas fa-drumstick-bite text-xl"></i>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg">Plato Principal</h3>
                            <p class="text-sm text-gray-600">Segundo plato</p>
                        </div>
                    </div>
                    <p class="text-gray-800 font-medium" x-text="menu.principal || 'No especificado'"></p>
                </div>

                <!-- Acompañamiento -->
                <div class="border rounded-lg p-4 bg-gradient-to-br from-yellow-50 to-yellow-100">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="avatar placeholder">
                            <div class="bg-yellow-500 text-white rounded-full w-12">
                                <i class="fas fa-bread-slice text-xl"></i>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg">Acompañamiento</h3>
                            <p class="text-sm text-gray-600">Guarnición</p>
                        </div>
                    </div>
                    <p class="text-gray-800 font-medium" x-text="menu.acompanamiento || 'No especificado'"></p>
                </div>

                <!-- Bebida -->
                <div class="border rounded-lg p-4 bg-gradient-to-br from-blue-50 to-blue-100">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="avatar placeholder">
                            <div class="bg-blue-500 text-white rounded-full w-12">
                                <i class="fas fa-glass-water text-xl"></i>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg">Bebida</h3>
                            <p class="text-sm text-gray-600">Líquido</p>
                        </div>
                    </div>
                    <p class="text-gray-800 font-medium" x-text="menu.bebida || 'No especificado'"></p>
                </div>

                <!-- Postre (opcional) -->
                <div class="border rounded-lg p-4 bg-gradient-to-br from-pink-50 to-pink-100 md:col-span-2">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="avatar placeholder">
                            <div class="bg-pink-500 text-white rounded-full w-12">
                                <i class="fas fa-ice-cream text-xl"></i>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg">Postre</h3>
                            <p class="text-sm text-gray-600">Opcional</p>
                        </div>
                    </div>
                    <p class="text-gray-800 font-medium" x-text="menu.postre || 'No incluido'"></p>
                </div>
            </div>

            <!-- Notas Adicionales -->
            <div x-show="menu.notas" class="alert alert-info mt-4">
                <i class="fas fa-info-circle"></i>
                <div>
                    <h4 class="font-bold">Notas</h4>
                    <p class="text-sm" x-text="menu.notas"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Menú Semanal -->
    <div class="card bg-base-100 shadow-md">
        <div class="card-body">
            <h2 class="text-2xl font-bold mb-4">
                <i class="fas fa-calendar-week mr-2 text-blue-500"></i>
                Menú de la Semana
            </h2>

            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Día</th>
                            <th>Entrada</th>
                            <th>Principal</th>
                            <th>Acompañamiento</th>
                            <th>Bebida</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="dia in menuSemanal" :key="dia.fecha">
                            <tr :class="{ 'bg-primary/10': dia.esHoy }">
                                <td>
                                    <div class="font-bold" x-text="dia.diaNombre"></div>
                                    <div class="text-sm opacity-50" x-text="dia.fechaCorta"></div>
                                    <span x-show="dia.esHoy" class="badge badge-primary badge-sm mt-1">Hoy</span>
                                </td>
                                <td x-text="dia.entrada || '-'"></td>
                                <td x-text="dia.principal || '-'"></td>
                                <td x-text="dia.acompanamiento || '-'"></td>
                                <td x-text="dia.bebida || '-'"></td>
                                <td>
                                    <button @click="editarMenuDia(dia.fecha)" class="btn btn-xs btn-ghost">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Editar Menú -->
    <dialog id="modalEditarMenu" class="modal" x-show="modalAbierto" x-cloak>
        <div class="modal-box max-w-2xl">
            <h3 class="font-bold text-lg mb-4">
                Editar Menú - <span x-text="fechaSeleccionadaFormato"></span>
            </h3>
            
            <form @submit.prevent="guardarMenu()">
                <div class="space-y-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Entrada</span>
                        </label>
                        <textarea x-model="formMenu.entrada" 
                                  class="textarea textarea-bordered" 
                                  placeholder="Ej: Ensalada mixta"></textarea>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Plato Principal *</span>
                        </label>
                        <textarea x-model="formMenu.principal" 
                                  class="textarea textarea-bordered" 
                                  placeholder="Ej: Pollo al horno con papas" 
                                  required></textarea>
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Acompañamiento</span>
                        </label>
                        <input type="text" 
                               x-model="formMenu.acompanamiento" 
                               class="input input-bordered" 
                               placeholder="Ej: Arroz blanco" />
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Bebida *</span>
                        </label>
                        <input type="text" 
                               x-model="formMenu.bebida" 
                               class="input input-bordered" 
                               placeholder="Ej: Jugo natural de naranja" 
                               required />
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Postre (Opcional)</span>
                        </label>
                        <input type="text" 
                               x-model="formMenu.postre" 
                               class="input input-bordered" 
                               placeholder="Ej: Gelatina de fresa" />
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Notas Adicionales</span>
                        </label>
                        <textarea x-model="formMenu.notas" 
                                  class="textarea textarea-bordered" 
                                  placeholder="Alergias, sustituciones, etc."></textarea>
                    </div>
                </div>

                <div class="modal-action">
                    <button type="button" @click="cerrarModal()" class="btn btn-ghost">Cancelar</button>
                    <button type="submit" class="btn btn-primary" :disabled="guardando">
                        <span x-show="!guardando">
                            <i class="fas fa-save mr-2"></i>Guardar
                        </span>
                        <span x-show="guardando" class="loading loading-spinner"></span>
                    </button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button @click="cerrarModal()">close</button>
        </form>
    </dialog>
</div>

<script>
function menuDiario() {
    return {
        fechaSeleccionada: new Date().toISOString().split('T')[0],
        menuCargado: false,
        tieneMenu: false,
        modalAbierto: false,
        guardando: false,
        suscripcionesActivas: 0,
        consumoEsperado: 85,
        menu: {
            entrada: '',
            principal: '',
            acompanamiento: '',
            bebida: '',
            postre: '',
            notas: ''
        },
        formMenu: {},
        menuSemanal: [],

        get fechaFormateada() {
            const fecha = new Date(this.fechaSeleccionada + 'T00:00:00');
            return fecha.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        },

        get diaSemana() {
            const fecha = new Date(this.fechaSeleccionada + 'T00:00:00');
            return fecha.toLocaleDateString('es-ES', { weekday: 'long' }).toUpperCase();
        },

        get fechaSeleccionadaFormato() {
            return new Date(this.fechaSeleccionada + 'T00:00:00').toLocaleDateString('es-ES');
        },

        init() {
            this.cargarMenu();
            this.cargarMenuSemanal();
        },

        seleccionarHoy() {
            this.fechaSeleccionada = new Date().toISOString().split('T')[0];
            this.cargarMenu();
        },

        diaAnterior() {
            const fecha = new Date(this.fechaSeleccionada);
            fecha.setDate(fecha.getDate() - 1);
            this.fechaSeleccionada = fecha.toISOString().split('T')[0];
            this.cargarMenu();
        },

        diaSiguiente() {
            const fecha = new Date(this.fechaSeleccionada);
            fecha.setDate(fecha.getDate() + 1);
            this.fechaSeleccionada = fecha.toISOString().split('T')[0];
            this.cargarMenu();
        },

        async cargarMenu() {
            this.menuCargado = false;
            
            try {
                // Aquí harías el fetch real
                // Simulación:
                await new Promise(resolve => setTimeout(resolve, 500));
                
                this.menu = {
                    entrada: 'Ensalada César',
                    principal: 'Pollo a la plancha con vegetales',
                    acompanamiento: 'Arroz integral',
                    bebida: 'Jugo natural de naranja',
                    postre: 'Fruta de estación',
                    notas: ''
                };
                
                this.tieneMenu = true;
                this.suscripcionesActivas = 45;
            } catch (error) {
                console.error('Error cargando menú:', error);
                this.tieneMenu = false;
            } finally {
                this.menuCargado = true;
            }
        },

        async cargarMenuSemanal() {
            // Aquí cargarías los menús de la semana
            const hoy = new Date(this.fechaSeleccionada);
            const inicioSemana = new Date(hoy);
            inicioSemana.setDate(hoy.getDate() - hoy.getDay() + 1); // Lunes

            this.menuSemanal = [];
            for (let i = 0; i < 7; i++) {
                const fecha = new Date(inicioSemana);
                fecha.setDate(fecha.getDate() + i);
                
                this.menuSemanal.push({
                    fecha: fecha.toISOString().split('T')[0],
                    diaNombre: fecha.toLocaleDateString('es-ES', { weekday: 'long' }),
                    fechaCorta: fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' }),
                    esHoy: fecha.toISOString().split('T')[0] === this.fechaSeleccionada,
                    entrada: i < 5 ? 'Ensalada' : '-',
                    principal: i < 5 ? 'Plato del día ' + (i+1) : '-',
                    acompanamiento: i < 5 ? 'Arroz' : '-',
                    bebida: i < 5 ? 'Jugo natural' : '-'
                });
            }
        },

        editarMenu() {
            this.formMenu = { ...this.menu };
            this.modalAbierto = true;
            document.getElementById('modalEditarMenu').showModal();
        },

        editarMenuDia(fecha) {
            this.fechaSeleccionada = fecha;
            this.cargarMenu();
            setTimeout(() => this.editarMenu(), 500);
        },

        cerrarModal() {
            this.modalAbierto = false;
            document.getElementById('modalEditarMenu').close();
        },

        async guardarMenu() {
            this.guardando = true;

            try {
                // Aquí harías el POST real
                await new Promise(resolve => setTimeout(resolve, 500));
                
                alert('Menú guardado exitosamente');
                this.menu = { ...this.formMenu };
                this.tieneMenu = true;
                this.cerrarModal();
                this.cargarMenuSemanal();
            } catch (error) {
                alert('Error al guardar el menú');
                console.error(error);
            } finally {
                this.guardando = false;
            }
        }
    }
}
</script>
{% endblock %}
