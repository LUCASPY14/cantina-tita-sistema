{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard de Almuerzos{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6" x-data="almuerzosDashboard()">
    <!-- Header mejorado con breadcrumbs -->
    <div class="mb-6">
        <div class="text-sm breadcrumbs mb-2">
            <ul>
                <li><a href="{% url 'pos:dashboard' %}"><i class="fas fa-home"></i> Inicio</a></li> 
                <li><i class="fas fa-utensils"></i> Almuerzos</li>
            </ul>
        </div>
        
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-utensils text-orange-500 mr-3"></i>
                    Sistema de Almuerzos
                </h1>
                <p class="text-gray-600 mt-1">Dashboard de gestión y monitoreo</p>
            </div>
            
            <div class="flex flex-wrap gap-2">
                <a href="{% url 'pos:planes_almuerzo' %}" class="btn btn-primary btn-sm md:btn-md">
                    <i class="fas fa-clipboard-list mr-2"></i>Gestionar Planes
                </a>
                <a href="{% url 'pos:suscripciones_almuerzo' %}" class="btn btn-info btn-sm md:btn-md">
                    <i class="fas fa-user-check mr-2"></i>Suscripciones
                </a>
                <button @click="registrarConsumo()" class="btn btn-success btn-sm md:btn-md">
                    <i class="fas fa-check-circle mr-2"></i>Registrar Consumo
                </button>
            </div>
        </div>
    </div>

    <!-- Estadísticas con mejor visualización -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <!-- Tarjeta de Consumos Hoy -->
        <div class="stats-card bg-gradient-to-br from-white to-blue-50 border border-blue-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Consumos Hoy</p>
                    <p class="text-2xl font-bold text-gray-800 mt-1">{{ stats.consumos_hoy }}</p>
                    <div class="flex items-center mt-2">
                        <span class="text-xs text-gray-500">{{ stats.fecha_hoy }}</span>
                    </div>
                </div>
                <div class="p-3 rounded-full bg-blue-100">
                    <i class="fas fa-calendar-day text-blue-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-3">
                <div class="flex justify-between text-xs text-gray-500">
                    <span>Meta: {{ stats.meta_diaria|default:"100" }}</span>
                    <span>{{ ((stats.consumos_hoy|default:0)/stats.meta_diaria|default:100)*100|floatformat:0 }}%</span>
                </div>
                <progress class="progress progress-info w-full h-2" 
                          value="{{ stats.consumos_hoy|default:0 }}" 
                          max="{{ stats.meta_diaria|default:100 }}">
                </progress>
            </div>
        </div>

        <!-- Tarjeta de Suscripciones -->
        <div class="stats-card bg-gradient-to-br from-white to-green-50 border border-green-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Suscripciones Activas</p>
                    <p class="text-2xl font-bold text-gray-800 mt-1">{{ stats.suscripciones_activas }}</p>
                    <div class="flex items-center mt-2">
                        <span class="badge badge-success badge-sm">{{ stats.nuevas_este_mes|default:"0" }} nuevas</span>
                    </div>
                </div>
                <div class="p-3 rounded-full bg-green-100">
                    <i class="fas fa-users text-green-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Tarjeta de Ingresos -->
        <div class="stats-card bg-gradient-to-br from-white to-purple-50 border border-purple-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Ingresos del Mes</p>
                    <p class="text-2xl font-bold text-gray-800 mt-1">${{ stats.ingresos_mes|floatformat:0 }}</p>
                    <div class="flex items-center mt-2">
                        <span class="text-xs {% if stats.variacion_ingresos >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                            <i class="fas fa-arrow-{% if stats.variacion_ingresos >= 0 %}up{% else %}down{% endif %} mr-1"></i>
                            {{ stats.variacion_ingresos|floatformat:1 }}%
                        </span>
                    </div>
                </div>
                <div class="p-3 rounded-full bg-purple-100">
                    <i class="fas fa-dollar-sign text-purple-600 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Tarjeta de Asistencia -->
        <div class="stats-card bg-gradient-to-br from-white to-orange-50 border border-orange-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Asistencia Semanal</p>
                    <p class="text-2xl font-bold text-gray-800 mt-1">{{ stats.asistencia_semanal|floatformat:1 }}%</p>
                    <div class="flex items-center mt-2">
                        <span class="text-xs text-gray-500">Últimos 7 días</span>
                    </div>
                </div>
                <div class="p-3 rounded-full bg-orange-100">
                    <i class="fas fa-percentage text-orange-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-3">
                <progress class="progress progress-warning w-full h-2" 
                          value="{{ stats.asistencia_semanal|floatformat:0 }}" 
                          max="100">
                </progress>
            </div>
        </div>
    </div>

    <!-- Tabs mejorados con indicador visual -->
    <div class="mb-8">
        <div class="tabs tabs-boxed bg-base-200 p-1 mb-4">
            <a class="tab tab-active !rounded-lg !transition-all" onclick="switchTab('planes')">
                <i class="fas fa-clipboard-list mr-2"></i> Planes Activos
                <span class="badge badge-primary badge-sm ml-2">{{ planes_activos|length }}</span>
            </a>
            <a class="tab !rounded-lg !transition-all" onclick="switchTab('vencimientos')">
                <i class="fas fa-clock mr-2"></i> Próximos Vencimientos
                <span class="badge badge-warning badge-sm ml-2">{{ suscripciones_proximas|length }}</span>
            </a>
            <a class="tab !rounded-lg !transition-all" onclick="switchTab('consumo')">
                <i class="fas fa-chart-line mr-2"></i> Consumo Semanal
            </a>
        </div>

        <!-- Contenido de las tabs -->
        <div id="tab-planes" class="tab-content active">
            <div class="card bg-base-100 shadow">
                <div class="card-body">
                    <h3 class="card-title text-lg font-bold">
                        <i class="fas fa-clipboard-list text-primary mr-2"></i>
                        Planes de Almuerzo Activos
                    </h3>
                    
                    <div class="overflow-x-auto">
                        <table class="table table-hover">
                            <thead>
                                <tr class="bg-base-200">
                                    <th class="!rounded-tl-lg">Plan</th>
                                    <th>Tipo</th>
                                    <th>Precio</th>
                                    <th>Suscriptores</th>
                                    <th class="!rounded-tr-lg">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for plan in planes_activos %}
                                <tr class="hover:bg-base-50 transition-colors">
                                    <td>
                                        <div class="flex items-center">
                                            <div class="avatar placeholder mr-3">
                                                <div class="bg-primary text-white rounded-full w-8">
                                                    <span>{{ plan.nombre_plan|first }}</span>
                                                </div>
                                            </div>
                                            <div>
                                                <div class="font-semibold">{{ plan.nombre_plan }}</div>
                                                <div class="text-xs text-gray-500">{{ plan.dias_incluidos }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge {% if plan.tipo_plan == 'Diario' %}badge-primary{% else %}badge-secondary{% endif %}">
                                            {{ plan.tipo_plan }}
                                        </span>
                                    </td>
                                    <td class="font-bold">${{ plan.precio|floatformat:0 }}</td>
                                    <td>
                                        <div class="flex items-center">
                                            <div class="radial-progress text-primary" 
                                                 style="--value:{{ plan.ocupacion }}; --size:2rem;">
                                                {{ plan.num_suscriptores }}
                                            </div>
                                            <span class="ml-2 text-sm">/ {{ plan.capacidad_max|default:"∞" }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="flex gap-1">
                                            <button class="btn btn-xs btn-outline btn-info">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-xs btn-outline btn-warning">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center py-8">
                                        <div class="text-gray-400">
                                            <i class="fas fa-inbox text-4xl mb-2"></i>
                                            <p>No hay planes activos</p>
                                            <a href="{% url 'pos:planes_almuerzo' %}" class="btn btn-sm btn-primary mt-2">
                                                Crear primer plan
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-vencimientos" class="tab-content">
            <div class="card bg-base-100 shadow">
                <div class="card-body">
                    <h3 class="card-title text-lg font-bold">
                        <i class="fas fa-clock text-warning mr-2"></i>
                        Suscripciones Próximas a Vencer
                    </h3>
                    
                    <div class="overflow-x-auto">
                        <table class="table table-hover">
                            <thead>
                                <tr class="bg-base-200">
                                    <th>Estudiante</th>
                                    <th>Plan</th>
                                    <th>Fecha Fin</th>
                                    <th>Días Restantes</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sus in suscripciones_proximas %}
                                <tr class="hover:bg-base-50 transition-colors">
                                    <td>
                                        <div class="font-bold">{{ sus.id_hijo.nombres }} {{ sus.id_hijo.apellidos }}</div>
                                        <div class="text-xs opacity-50">{{ sus.id_hijo.grado }}</div>
                                    </td>
                                    <td>{{ sus.id_plan_almuerzo.nombre_plan }}</td>
                                    <td>{{ sus.fecha_fin|date:"d/m/Y" }}</td>
                                    <td>
                                        <span class="badge badge-warning">{{ sus.dias_restantes }} días</span>
                                    </td>
                                    <td>
                                        <span class="badge badge-success">{{ sus.estado }}</span>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-gray-500">No hay suscripciones próximas a vencer</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-consumo" class="tab-content">
            <div class="card bg-base-100 shadow">
                <div class="card-body">
                    <h3 class="card-title text-lg font-bold">
                        <i class="fas fa-chart-line text-success mr-2"></i>
                        Consumo de los Últimos 7 Días
                    </h3>
                    
                    <div class="overflow-x-auto">
                        <table class="table table-hover">
                            <thead>
                                <tr class="bg-base-200">
                                    <th>Fecha</th>
                                    <th>Total Consumos</th>
                                    <th>Tasa de Asistencia</th>
                                    <th>Ingreso del Día</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for dia in consumo_semanal %}
                                <tr class="hover:bg-base-50 transition-colors">
                                    <td>{{ dia.fecha|date:"l, d/m/Y" }}</td>
                                    <td>
                                        <div class="badge badge-primary">{{ dia.total }}</div>
                                    </td>
                                    <td>
                                        <progress class="progress progress-success w-32" value="{{ dia.porcentaje }}" max="100"></progress>
                                        <span class="ml-2">{{ dia.porcentaje|floatformat:1 }}%</span>
                                    </td>
                                    <td class="font-semibold">${{ dia.ingreso|floatformat:0 }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-gray-500">No hay datos de consumo</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Acciones rápidas flotantes -->
    <div class="fixed bottom-6 right-6 z-10">
        <div class="dropdown dropdown-top dropdown-end">
            <div tabindex="0" role="button" class="btn btn-primary btn-circle btn-lg shadow-lg animate-bounce">
                <i class="fas fa-plus text-xl"></i>
            </div>
            <ul tabindex="0" class="dropdown-content menu p-2 shadow-lg bg-base-100 rounded-box w-52 mb-2">
                <li><a href="{% url 'pos:nueva_suscripcion' %}"><i class="fas fa-user-plus"></i> Nueva Suscripción</a></li>
                <li><a href="{% url 'pos:registro_consumo_almuerzo' %}"><i class="fas fa-check-circle"></i> Registrar Consumo</a></li>
                <li><a href="{% url 'pos:nuevo_plan' %}"><i class="fas fa-plus-circle"></i> Nuevo Plan</a></li>
                <li><hr class="my-1"></li>
                <li><a href="{% url 'pos:reportes_almuerzos' %}"><i class="fas fa-file-export"></i> Exportar Reporte</a></li>
            </ul>
        </div>
    </div>
</div>

<style>
/* Estilos personalizados */
.stats-card {
    @apply p-4 rounded-xl shadow-sm transition-all duration-300 hover:shadow-md;
}

.tab-content {
    display: none;
    animation: fadeIn 0.3s ease-in;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.table-hover tbody tr {
    transition: background-color 0.2s ease;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
}
</style>

<script>
function almuerzosDashboard() {
    return {
        // Estado inicial
        activeTab: 'planes',
        loading: false,
        
        init() {
            console.log('Dashboard de Almuerzos iniciado');
            this.setupEventListeners();
        },
        
        setupEventListeners() {
            // Puedes agregar listeners adicionales aquí
        },
        
        switchTab(tabName) {
            this.activeTab = tabName;
            // Oculta todas las tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            // Muestra la tab activa
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Actualiza las tabs visuales
            document.querySelectorAll('.tabs-boxed .tab').forEach(t => {
                t.classList.remove('tab-active');
            });
            event.currentTarget.classList.add('tab-active');
        },
        
        async registrarConsumo() {
            this.loading = true;
            // Simulación de API call
            await new Promise(resolve => setTimeout(resolve, 1000));
            window.location.href = "{% url 'pos:registro_consumo_almuerzo' %}";
        },
        
        // Función para búsqueda rápida
        buscarEstudiante() {
            const modal = document.getElementById('search-modal');
            modal.showModal();
        }
    }
}

// Inicialización
document.addEventListener('DOMContentLoaded', function() {
    const dashboard = almuerzosDashboard();
    dashboard.init();
});
</script>
{% endblock %}
