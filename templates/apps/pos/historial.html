{% extends 'base.html' %}

{% block title %}Historial de Ventas | Cantina Tita{% endblock %}

{% block content %}
<div class="space-y-4">
    
    <!-- Encabezado -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-neutral">üìú Historial de Ventas</h1>
            <p class="text-gray-600">√öltimas 100 ventas registradas</p>
        </div>
        <a href="{% url 'pos:dashboard' %}" class="btn btn-outline">
            ‚Üê Volver al Dashboard
        </a>
    </div>
    
    <!-- Tabla de ventas -->
    <div class="card bg-white shadow-xl">
        <div class="card-body">
            <h3 class="card-title text-lg mb-4">üìä Ventas Recientes</h3>
            
            {% if ventas %}
            <div class="overflow-x-auto">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr>
                            <th>ID Venta</th>
                            <th>Fecha</th>
                            <th>Cajero</th>
                            <th>Cliente</th>
                            <th>Tipo Venta</th>
                            <th>Monto Total</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for venta in ventas %}
                        <tr>
                            <td class="font-mono">{{ venta.id_venta }}</td>
                            <td>{{ venta.fecha|date:"d/m/Y H:i" }}</td>
                            <td>
                                {% if venta.id_empleado_cajero %}
                                    {{ venta.id_empleado_cajero.nombre }} {{ venta.id_empleado_cajero.apellido }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                {% if venta.id_cliente %}
                                    {{ venta.id_cliente.nombres }} {{ venta.id_cliente.apellidos }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge badge-sm">{{ venta.tipo_venta }}</span>
                            </td>
                            <td class="font-bold">
                                Gs. {{ venta.monto_total|floatformat:0|default:"0" }}
                            </td>
                            <td>
                                {% if venta.estado == 'PROCESADO' or venta.estado == 'Completada' %}
                                    <span class="badge badge-success">{{ venta.estado }}</span>
                                {% elif venta.estado == 'ANULADA' or venta.estado == 'Cancelada' %}
                                    <span class="badge badge-error">{{ venta.estado }}</span>
                                {% elif venta.estado == 'Pendiente' %}
                                    <span class="badge badge-warning">{{ venta.estado }}</span>
                                {% else %}
                                    <span class="badge">{{ venta.estado }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="flex gap-2">
                                    <button class="btn btn-xs btn-outline" 
                                            onclick="verDetalle({{ venta.id_venta }})">
                                        üëÅÔ∏è Ver
                                    </button>
                                    {% if venta.id_documento %}
                                    <button class="btn btn-xs btn-primary" 
                                            onclick="imprimirTicket({{ venta.id_documento.id_documento }})">
                                        üñ®Ô∏è Ticket
                                    </button>
                                    {% endif %}
                                    {% if venta.estado != 'ANULADA' and venta.estado != 'Cancelada' and forloop.first %}
                                    <button class="btn btn-xs btn-error" 
                                            onclick="anularVenta({{ venta.id_venta }})">
                                        ‚ùå Anular
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span>No hay ventas registradas a√∫n.</span>
            </div>
            {% endif %}
        </div>
    </div>
    
</div>

<!-- Modal de detalle de venta -->
<dialog id="modal_detalle_venta" class="modal">
    <div class="modal-box max-w-4xl">
        <h3 class="font-bold text-lg mb-4">Detalle de Venta</h3>
        <div id="contenido_detalle">
            <!-- Aqu√≠ se cargar√° el detalle v√≠a AJAX -->
        </div>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn">Cerrar</button>
            </form>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Modal de Autorizaci√≥n para Anular Venta -->
<dialog id="modalAutorizacionVenta" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">üîê Autorizaci√≥n Requerida</h3>
        <p class="py-4">Para anular esta venta, debe escanear una tarjeta de autorizaci√≥n:</p>
        
        <form id="formAutorizacionVenta" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" id="ventaAnular" name="venta_id" value="">
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text">C√≥digo de Tarjeta de Autorizaci√≥n</span>
                </label>
                <input 
                    type="text" 
                    id="inputAutorizacionVenta"
                    name="codigo_barra"
                    placeholder="Escanee la tarjeta del administrador" 
                    class="input input-bordered input-lg text-center font-mono"
                    autocomplete="off"
                    required
                >
            </div>

            <div class="form-control">
                <label class="label">
                    <span class="label-text">Motivo de la anulaci√≥n</span>
                </label>
                <textarea 
                    id="motivoAnulacionVenta"
                    name="motivo"
                    class="textarea textarea-bordered" 
                    placeholder="Ej: Error en venta, producto equivocado, etc."
                    rows="2"
                ></textarea>
            </div>

            <div id="mensajeAutorizacionVenta" class="hidden">
                <!-- Mensajes din√°micos -->
            </div>

            <div class="modal-action">
                <button type="button" class="btn" onclick="cerrarModalAutorizacionVenta()">
                    Cancelar
                </button>
                <button type="submit" class="btn btn-primary">
                    Validar y Anular
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
let logAutorizacionVentaId = null;

function anularVenta(ventaId) {
    document.getElementById('ventaAnular').value = ventaId;
    document.getElementById('modalAutorizacionVenta').showModal();
    setTimeout(() => {
        document.getElementById('inputAutorizacionVenta').focus();
    }, 300);
}

function cerrarModalAutorizacionVenta() {
    document.getElementById('modalAutorizacionVenta').close();
    document.getElementById('formAutorizacionVenta').reset();
    document.getElementById('mensajeAutorizacionVenta').classList.add('hidden');
    logAutorizacionVentaId = null;
}

// Proceso de dos pasos: 1) Validar autorizaci√≥n, 2) Anular venta
document.getElementById('formAutorizacionVenta').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const codigoBarra = formData.get('codigo_barra');
    const ventaId = formData.get('venta_id');
    const motivo = formData.get('motivo');
    
    if (!codigoBarra) {
        mostrarMensajeVenta('Por favor escanee una tarjeta de autorizaci√≥n', 'error');
        return;
    }

    // Paso 1: Validar autorizaci√≥n
    if (!logAutorizacionVentaId) {
        try {
            const response = await fetch('{% url "pos:validar_autorizacion" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams({
                    'codigo_barra': codigoBarra,
                    'tipo_operacion': 'ANULAR_VENTA',
                    'id_registro': ventaId
                })
            });

            const data = await response.json();

            if (data.success) {
                logAutorizacionVentaId = data.log_id;
                mostrarMensajeVenta(`‚úÖ ${data.message} - ${data.tarjeta_tipo}`, 'success');
                
                // Paso 2: Anular la venta
                setTimeout(() => ejecutarAnulacionVenta(ventaId, motivo), 500);
            } else {
                mostrarMensajeVenta(`‚ùå ${data.message}`, 'error');
                document.getElementById('inputAutorizacionVenta').value = '';
                document.getElementById('inputAutorizacionVenta').focus();
            }
        } catch (error) {
            mostrarMensajeVenta('‚ùå Error al validar autorizaci√≥n', 'error');
            console.error(error);
        }
    }
});

async function ejecutarAnulacionVenta(ventaId, motivo) {
    try {
        const response = await fetch(`/pos/venta/anular/${ventaId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: new URLSearchParams({
                'log_id': logAutorizacionVentaId,
                'motivo': motivo || 'Sin motivo especificado'
            })
        });

        const data = await response.json();

        if (data.success) {
            mostrarMensajeVenta(`‚úÖ ${data.message}`, 'success');
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            mostrarMensajeVenta(`‚ùå ${data.message}`, 'error');
        }
    } catch (error) {
        mostrarMensajeVenta('‚ùå Error al anular venta', 'error');
        console.error(error);
    }
}

function mostrarMensajeVenta(texto, tipo) {
    const div = document.getElementById('mensajeAutorizacionVenta');
    div.className = tipo === 'success' 
        ? 'alert alert-success' 
        : 'alert alert-error';
    div.textContent = texto;
    div.classList.remove('hidden');
}

function verDetalle(idVenta) {
    // Implementar carga de detalle v√≠a AJAX
    const modal = document.getElementById('modal_detalle_venta');
    const contenido = document.getElementById('contenido_detalle');
    
    // Por ahora mostrar mensaje simple
    contenido.innerHTML = `
        <div class="alert alert-info">
            <span>Venta #${idVenta} - Funcionalidad de detalle pendiente de implementar</span>
        </div>
    `;
    
    modal.showModal();
}

function imprimirTicket(idDocumento) {
    // Abrir ventana de impresi√≥n de ticket
    window.open(`/pos/ticket/${idDocumento}/`, '_blank', 'width=350,height=600');
}
</script>

{% endblock %}
