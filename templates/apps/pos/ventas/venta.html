{% extends 'base.html' %}

{% block title %}POS - Punto de Venta | Cantina Tita{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    
    <!-- Columna izquierda: Productos (2/3) -->
    <div class="lg:col-span-2">
        
        <!-- B√∫squeda de productos -->
        <div class="card bg-white shadow-xl mb-4">
            <div class="card-body p-4">
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        id="search-input"
                        placeholder="üîç Buscar producto o escanear c√≥digo... (F2)" 
                        class="input input-bordered input-lg w-full text-lg"
                        hx-post="{% url 'pos:buscar_productos' %}"
                        hx-trigger="keyup changed delay:300ms"
                        hx-target="#productos-grid"
                        hx-indicator="#search-loading"
                        name="q"
                        autocomplete="off"
                        autofocus
                    >
                    <button class="btn btn-secondary btn-lg">
                        <span id="search-loading" class="loading loading-spinner htmx-indicator"></span>
                        <span>üîç</span>
                    </button>
                </div>
                
                <!-- Filtros r√°pidos -->
                <div class="flex gap-2 mt-3 flex-wrap">
                    <button 
                        class="btn btn-sm btn-outline"
                        hx-get="{% url 'pos:productos_categoria' %}?categoria=todos"
                        hx-target="#productos-grid"
                    >
                        Todos
                    </button>
                    <button 
                        class="btn btn-sm btn-outline"
                        hx-get="{% url 'pos:productos_categoria' %}?categoria=bebidas"
                        hx-target="#productos-grid"
                    >
                        ü•§ Bebidas
                    </button>
                    <button 
                        class="btn btn-sm btn-outline"
                        hx-get="{% url 'pos:productos_categoria' %}?categoria=snacks"
                        hx-target="#productos-grid"
                    >
                        üçø Snacks
                    </button>
                    <button 
                        class="btn btn-sm btn-outline"
                        hx-get="{% url 'pos:productos_categoria' %}?categoria=almuerzos"
                        hx-target="#productos-grid"
                    >
                        üç± Almuerzos
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Grid de productos -->
        <div id="productos-grid" class="product-grid">
            {% include 'pos/partials/productos_grid.html' %}
        </div>
        
    </div>
    
    <!-- Columna derecha: Carrito y cobro (1/3) -->
    <div class="lg:col-span-1">
        <div class="cart-sidebar">
            
            <!-- Tarjeta del estudiante -->
            <div class="card bg-white shadow-xl mb-4">
                <div class="card-body p-4">
                    <h3 class="font-bold text-lg mb-3">üí≥ Tarjeta</h3>
                    
                    <form hx-post="{% url 'pos:buscar_tarjeta' %}"
                          hx-trigger="submit"
                          hx-target="#tarjeta-info"
                          hx-swap="innerHTML"
                          @htmx:after-swap="cardNumber = ''; setTimeout(() => $refs.tarjetaInput.focus(), 100)">
                        {% csrf_token %}
                        <input 
                            type="text" 
                            placeholder="Escanear o escribir N¬∞ tarjeta..."
                            class="input input-bordered w-full mb-2"
                            x-model="cardNumber"
                            x-ref="tarjetaInput"
                            name="nro_tarjeta"
                            id="tarjeta-input"
                            autocomplete="off"
                            autofocus
                        >
                    </form>
                    
                    <div id="tarjeta-info">
                        <div class="alert alert-info">
                            <span>üëÜ Escanee la tarjeta del estudiante</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-sm btn-outline w-full mt-2" @click="selectGenericCard()">
                        Cliente Gen√©rico (F1)
                    </button>
                </div>
            </div>            <!-- Carrito de compras -->
            <div class="card bg-white shadow-xl mb-4">
                <div class="card-body p-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg">üõí Carrito</h3>
                        <button 
                            class="btn btn-xs btn-ghost text-danger"
                            @click="clearCart()"
                            x-show="cart.length > 0"
                        >
                            Limpiar
                        </button>
                    </div>
                    
                    <!-- Items del carrito -->
                    <div class="space-y-2 mb-4 max-h-96 overflow-y-auto">
                        <template x-for="(item, index) in cart" :key="index">
                            <div class="flex items-center gap-2 p-2 bg-base-200 rounded-lg fade-in">
                                <div class="flex-1">
                                    <p class="font-semibold text-sm" x-text="item.name"></p>
                                    <p class="text-xs text-gray-600">
                                        <!-- Producto regular -->
                                        <span x-show="!item.esPorKilo && !item.esRecarga">
                                            Gs. <span x-text="Math.round(item.price || 0).toLocaleString('es-PY')"></span>
                                        </span>
                                        <!-- Producto por kilo -->
                                        <span x-show="item.esPorKilo">
                                            Gs. <span x-text="Math.round(item.price || 0).toLocaleString('es-PY')"></span>/kg
                                            √ó <span x-text="item.peso"></span>kg
                                            = Gs. <span x-text="Math.round((item.price || 0) * (item.peso || 1)).toLocaleString('es-PY')"></span>
                                        </span>
                                        <!-- Producto recarga -->
                                        <span x-show="item.esRecarga" class="badge badge-info badge-sm">
                                            üí≥ Recarga: Gs. <span x-text="Math.round(item.price || 0).toLocaleString('es-PY')"></span>
                                        </span>
                                    </p>
                                </div>
                                <div class="flex items-center gap-1">
                                    <!-- Mostrar peso editable si es por kilo -->
                                    <template x-if="item.esPorKilo">
                                        <button 
                                            class="btn btn-xs btn-outline"
                                            @click="editPeso(index)"
                                        >
                                            ‚öñÔ∏è <span x-text="item.peso"></span>kg
                                        </button>
                                    </template>
                                    
                                    <!-- Controles de cantidad normal (no para kilo ni recarga) -->
                                    <template x-if="!item.esPorKilo && !item.esRecarga">
                                        <div class="flex items-center gap-1">
                                            <button 
                                                class="btn btn-xs btn-circle" 
                                                @click="decreaseQuantity(index)"
                                            >
                                                -
                                            </button>
                                            <span class="w-8 text-center font-bold" x-text="item.quantity"></span>
                                            <button 
                                                class="btn btn-xs btn-circle" 
                                                @click="increaseQuantity(index)"
                                            >
                                                +
                                            </button>
                                        </div>
                                    </template>
                                    
                                    <!-- Para recargas mostrar cantidad fija -->
                                    <template x-if="item.esRecarga">
                                        <span class="badge badge-ghost">x1</span>
                                    </template>
                                </div>
                                <button 
                                    class="btn btn-xs btn-circle btn-error"
                                    @click="removeFromCart(index)"
                                >
                                    √ó
                                </button>
                            </div>
                        </template>
                        
                        <!-- Carrito vac√≠o -->
                        <div class="text-center py-8 text-gray-400" x-show="cart.length === 0">
                            <p class="text-4xl mb-2">üõí</p>
                            <p>El carrito est√° vac√≠o</p>
                        </div>
                    </div>
                    
                    <!-- Total -->
                    <div class="border-t pt-3">
                        <!-- Subtotal y descuentos -->
                        <div class="space-y-2 mb-3">
                            <!-- Subtotal -->
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-600">Subtotal:</span>
                                <span class="font-mono">
                                    Gs. <span x-text="Math.round(subtotal).toLocaleString('es-PY')"></span>
                                </span>
                            </div>
                            
                            <!-- Promoci√≥n aplicada (si hay) -->
                            <div x-show="promocionAplicada" class="flex justify-between items-center text-sm bg-success/10 p-2 rounded">
                                <div class="flex items-center gap-2">
                                    <span class="text-xl">üéâ</span>
                                    <div class="flex flex-col">
                                        <span class="font-semibold text-success" x-text="promocionAplicada?.nombre"></span>
                                        <span class="text-xs text-gray-500" x-text="promocionAplicada?.descripcion"></span>
                                    </div>
                                </div>
                                <span class="font-mono font-bold text-success">
                                    -Gs. <span x-text="Math.round(descuentoPromocion).toLocaleString('es-PY')"></span>
                                </span>
                            </div>
                            
                            <!-- Mensaje si est√° calculando -->
                            <div x-show="calculandoPromocion" class="text-xs text-center text-gray-400 italic">
                                Calculando promociones...
                            </div>
                        </div>
                        
                        <!-- Total final -->
                        <div class="flex justify-between items-center mb-4 pt-2 border-t">
                            <span class="text-lg font-bold">TOTAL:</span>
                            <span class="text-2xl font-bold text-primary">
                                Gs. <span x-text="Math.round(total).toLocaleString('es-PY')"></span>
                            </span>
                        </div>
                        
                        <!-- Bot√≥n de cobro -->
                        <button 
                            class="btn btn-primary btn-lg w-full btn-touch"
                            @click="processSale()"
                            :disabled="cart.length === 0"
                            x-show="cart.length > 0"
                        >
                            üí∞ COBRAR (F4)
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Accesos r√°pidos -->
            <div class="card bg-white shadow-xl">
                <div class="card-body p-4">
                    <h3 class="font-bold text-sm mb-2">‚ö° Atajos</h3>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="bg-base-200 p-2 rounded">
                            <kbd class="kbd kbd-xs">F1</kbd> Gen√©rico
                        </div>
                        <div class="bg-base-200 p-2 rounded">
                            <kbd class="kbd kbd-xs">F2</kbd> Buscar
                        </div>
                        <div class="bg-base-200 p-2 rounded">
                            <kbd class="kbd kbd-xs">F4</kbd> Cobrar
                        </div>
                        <div class="bg-base-200 p-2 rounded">
                            <kbd class="kbd kbd-xs">ESC</kbd> Cancelar
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
</div>

<!-- Modal de peso -->
<dialog id="modal-peso" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">‚öñÔ∏è Ingresar Peso</h3>
        <div class="form-control">
            <label class="label">
                <span class="label-text font-semibold">Peso en kilogramos:</span>
            </label>
            <input 
                type="number" 
                id="input-peso"
                step="0.1" 
                min="0.1" 
                value="1.0"
                class="input input-bordered input-lg text-center text-2xl"
                @keyup.enter="confirmarPeso()"
            >
            <label class="label">
                <span class="label-text-alt">Ejemplos: 0.2, 0.5, 1.0, 1.5</span>
            </label>
        </div>
        
        <!-- Botones r√°pidos -->
        <div class="grid grid-cols-4 gap-2 mt-4">
            <button class="btn btn-outline" @click="setPeso(0.2)">0.2 kg</button>
            <button class="btn btn-outline" @click="setPeso(0.5)">0.5 kg</button>
            <button class="btn btn-outline" @click="setPeso(1.0)">1.0 kg</button>
            <button class="btn btn-outline" @click="setPeso(1.5)">1.5 kg</button>
        </div>
        
        <div class="modal-action">
            <button class="btn" onclick="document.getElementById('modal-peso').close()">
                Cancelar
            </button>
            <button class="btn btn-primary" @click="confirmarPeso()">
                Aceptar
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Modal de Monto de Recarga -->
<dialog id="modal-monto-recarga" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">üí≥ Ingresar Monto de Recarga</h3>
        <div class="form-control">
            <label class="label">
                <span class="label-text font-semibold">Monto en Guaran√≠es:</span>
            </label>
            <input 
                type="number" 
                id="input-monto-recarga"
                step="1000" 
                min="1000" 
                value=""
                class="input input-bordered input-lg text-center text-2xl"
                @keyup.enter="confirmarMontoRecarga()"
            >
            <label class="label">
                <span class="label-text-alt text-warning">üí° Para pagos con comisi√≥n (d√©bito/QR, cr√©dito/QR, Tigo), ingresa el monto total incluyendo la comisi√≥n mostrada arriba.</span>
            <button class="btn btn-outline btn-sm" @click="setMontoRecarga(50000)">Gs. 50.000</button>
            <button class="btn btn-outline btn-sm" @click="setMontoRecarga(100000)">Gs. 100.000</button>
        </div>
        
        <div class="modal-action">
            <button class="btn" onclick="document.getElementById('modal-monto-recarga').close()">
                Cancelar
            </button>
            <button class="btn btn-primary" @click="confirmarMontoRecarga()">
                Agregar Recarga
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Modal de Checkout -->
<dialog id="modal-checkout" class="modal">
    <div class="modal-box max-w-2xl">
        <h3 class="font-bold text-lg mb-4">üí∞ Procesar Pago</h3>
        
        <!-- Resumen de la compra -->
        <div class="bg-base-200 p-4 rounded-lg mb-4">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm">Items:</span>
                <span class="font-bold" x-text="cart.length"></span>
            </div>
            
            <!-- Subtotal y Promoci√≥n -->
            <template x-if="promocionAplicada">
                <div>
                    <div class="flex justify-between items-center text-sm text-gray-600">
                        <span>Subtotal:</span>
                        <span>Gs. <span x-text="Math.round(subtotal).toLocaleString('es-PY')"></span></span>
                    </div>
                    <div class="flex justify-between items-center text-sm text-success">
                        <span>üéâ <span x-text="promocionAplicada.nombre"></span>:</span>
                        <span>-Gs. <span x-text="Math.round(descuentoPromocion).toLocaleString('es-PY')"></span></span>
                    </div>
                </div>
            </template>
            
            <div class="flex justify-between items-center text-2xl font-bold text-primary border-t pt-2 mt-2">
                <span>TOTAL A PAGAR:</span>
                <span>Gs. <span x-text="Math.round(total + pagosMixtos.reduce((sum, p) => sum + (p.id == 3 ? p.monto * 0.03 : p.id == 2 ? p.monto * 0.05 : p.id == 4 ? p.monto * 0.05 : 0), 0)).toLocaleString('es-PY')"></span>
            </div>
            
            <!-- Comisi√≥n estimada -->
            <div class="text-sm text-orange-600 mt-1">
                <span>Comisi√≥n estimada:</span>
                <span>Gs. <span x-text="Math.round(pagosMixtos.reduce((sum, p) => sum + ((p.id || p.medio_id) == 3 ? p.monto * 0.03 : (p.id || p.medio_id) == 2 ? p.monto * 0.05 : (p.id || p.medio_id) == 4 ? p.monto * 0.05 : 0), 0)).toLocaleString('es-PY')"></span>
            </div>
        </div>
        
        <!-- Pagos agregados -->
        <div class="mb-4" x-show="pagosMixtos.length > 0">
            <h4 class="font-semibold mb-2 text-sm">üí≥ Pagos registrados:</h4>
            <div class="space-y-2 max-h-40 overflow-y-auto">
                <template x-for="(pago, index) in pagosMixtos" :key="index">
                    <div class="flex justify-between items-center bg-success/10 p-2 rounded">
                        <div class="flex items-center gap-2">
                            <span class="text-lg">üíµ</span>
                            <span class="font-semibold text-sm" x-text="pago.descripcion"></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-mono text-sm">Gs. <span x-text="Math.round(pago.monto).toLocaleString('es-PY')"></span></span>
                            <button @click="eliminarPago(index)" class="btn btn-xs btn-error">
                                ‚ùå
                            </button>
                        </div>
                    </div>
                </template>
            </div>
            
            <!-- Totalizadores -->
            <div class="border-t pt-2 mt-3 space-y-1">
                <div class="flex justify-between text-sm">
                    <span>Total pagado:</span>
                    <span class="font-mono font-semibold text-success">
                        Gs. <span x-text="Math.round(totalPagado).toLocaleString('es-PY')"></span>
                    </span>
                </div>
                <div class="flex justify-between text-base font-bold" 
                     :class="{'text-error': (total + pagosMixtos.reduce((sum, p) => sum + (p.id == 3 ? p.monto * 0.03 : p.id == 2 ? p.monto * 0.05 : p.id == 4 ? p.monto * 0.05 : 0), 0) - totalPagado) > 0.01, 'text-success': (total + pagosMixtos.reduce((sum, p) => sum + (p.id == 3 ? p.monto * 0.03 : p.id == 2 ? p.monto * 0.05 : p.id == 4 ? p.monto * 0.05 : 0), 0) - totalPagado) <= 0.01}">
                    <span>Pendiente:</span>
                    <span class="font-mono">
                        Gs. <span x-text="Math.round(total + pagosMixtos.reduce((sum, p) => sum + (p.id == 3 ? p.monto * 0.03 : p.id == 2 ? p.monto * 0.05 : p.id == 4 ? p.monto * 0.05 : 0), 0) - totalPagado).toLocaleString('es-PY')"></span>
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Mensaje inicial si no hay pagos -->
        <div x-show="pagosMixtos.length === 0" class="alert alert-info mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span>Seleccione uno o m√°s medios de pago</span>
        </div>
        
        <!-- Botones para agregar pagos -->
        <div class="grid grid-cols-3 gap-2 mb-4">
            <!-- Efectivo -->
            <button @click="agregarPago(1, 'Efectivo')" class="btn btn-lg btn-outline btn-success" type="button">
                üíµ Efectivo
            </button>
            
            <!-- Tarjeta Estudiantil (Exclusiva) -->
            <button @click="agregarPago(6, 'Tarjeta Estudiantil')" class="btn btn-lg btn-outline btn-primary" type="button" x-show="selectedCard && selectedCard.saldo">
                üé´ Tarjeta
            </button>
            
            <!-- Transferencia -->
            <button @click="agregarPago(5, 'Transferencia')" class="btn btn-lg btn-outline btn-info" type="button">
                üè¶ Transferencia
            </button>
            
            <!-- Tarjeta D√©bito/QR -->
            <button @click="agregarPago(3, 'D√©bito/QR')" class="btn btn-lg btn-outline btn-accent" type="button">
                üí≥ D√©bito/QR
            </button>
            
            <!-- Tarjeta Cr√©dito/QR -->
            <button @click="agregarPago(2, 'Cr√©dito/QR')" class="btn btn-lg btn-outline btn-secondary" type="button">
                üíé Cr√©dito/QR
            </button>
            
            <!-- Giros Tigo -->
            <button @click="agregarPago(4, 'Giros Tigo')" class="btn btn-lg btn-outline btn-warning" type="button">
                üì± Giros Tigo
            </button>
        </div>
        
        <!-- Informaci√≥n del cliente/tarjeta -->
        <div class="bg-info bg-opacity-10 p-3 rounded-lg mb-4" x-show="selectedCard">
            <div class="text-sm">
                <strong>Cliente:</strong> <span x-text="selectedCard ? selectedCard.nombre : 'N/A'"></span>
            </div>
            <div class="text-sm" x-show="selectedCard && selectedCard.id">
                <strong>Tarjeta:</strong> #<span x-text="selectedCard ? selectedCard.id : ''"></span>
            </div>
            <div class="text-sm" x-show="selectedCard && selectedCard.saldo != null">
                <strong>Saldo:</strong> Gs. <span x-text="selectedCard && selectedCard.saldo != null ? Math.round(selectedCard.saldo).toLocaleString('es-PY') : '0'"></span>
            </div>
        </div>
        
        <!-- C√≥digo de Transacci√≥n (solo para ciertos medios) -->
        <div class="form-control mb-4">
            <label class="label">
                <span class="label-text font-semibold">üî¢ C√≥digo de Transacci√≥n</span>
            </label>
            <input 
                type="text" 
                x-model="codigoTransaccion"
                placeholder="Ingrese el c√≥digo de transacci√≥n..."
                class="input input-bordered w-full"
                maxlength="100"
            >
            <label class="label">
                <span class="label-text-alt text-error">Requerido para Transferencia, D√©bito/QR, Cr√©dito/QR y Giros Tigo</span>
            </label>
        </div>
        
        <div class="modal-action">
            <button class="btn btn-ghost" onclick="document.getElementById('modal-checkout').close()">
                Cancelar
            </button>
            <button 
                class="btn btn-primary btn-lg" 
                @click="confirmarCheckout()" 
                :disabled="procesandoVenta || !validarPagoCompleto()"
                type="button">
                <span x-show="!procesandoVenta">‚úÖ Confirmar Venta</span>
                <span x-show="procesandoVenta" class="loading loading-spinner loading-sm"></span>
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Modal de RESTRICCIONES ALIMENTARIAS - Confirmaci√≥n del Cajero -->
<dialog id="modal-restricciones" class="modal" x-data="restriccionesModal()">
    <div class="modal-box max-w-2xl">
        <h3 class="font-bold text-2xl text-error mb-4">
            ‚ö†Ô∏è ATENCI√ìN: RESTRICCIONES ALIMENTARIAS
        </h3>
        
        <div class="alert alert-warning mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div>
                <h4 class="font-bold">Este estudiante tiene restricciones de compra registradas</h4>
                <p class="text-sm">Por favor lea cuidadosamente antes de continuar</p>
            </div>
        </div>
        
        <!-- Informaci√≥n del estudiante -->
        <div class="bg-base-200 p-4 rounded-lg mb-4">
            <div class="flex items-center gap-3 mb-2">
                <div class="avatar placeholder">
                    <div class="bg-neutral text-neutral-content rounded-full w-12">
                        <span class="text-xl">üë§</span>
                    </div>
                </div>
                <div>
                    <div class="font-bold text-lg" x-text="datosEstudiante.nombre"></div>
                    <div class="text-sm opacity-70">
                        Tarjeta: #<span x-text="datosEstudiante.tarjeta"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Restricciones -->
        <div class="bg-red-50 border-2 border-red-300 rounded-lg p-4 mb-4">
            <h5 class="font-bold text-red-800 mb-2 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                RESTRICCIONES REGISTRADAS:
            </h5>
            <div class="text-red-700 text-sm whitespace-pre-wrap max-h-64 overflow-y-auto p-2 bg-white rounded" 
                 x-text="datosEstudiante.restricciones"></div>
        </div>
        
        <!-- Checkbox de confirmaci√≥n -->
        <div class="form-control mb-4">
            <label class="label cursor-pointer justify-start gap-3 bg-yellow-50 p-4 rounded-lg border-2 border-yellow-300">
                <input 
                    type="checkbox" 
                    class="checkbox checkbox-warning checkbox-lg" 
                    x-model="confirmado"
                />
                <span class="label-text font-bold text-base">
                    ‚úÖ He le√≠do las restricciones y confirmo que los productos de esta venta son apropiados
                </span>
            </label>
        </div>
        
        <!-- Justificaci√≥n opcional -->
        <div class="form-control mb-4" x-show="confirmado">
            <label class="label">
                <span class="label-text font-semibold">Observaciones (opcional):</span>
            </label>
            <textarea 
                x-model="justificacion"
                class="textarea textarea-bordered h-20" 
                placeholder="Ej: Cliente autoriz√≥ verbalmente, producto no contiene ingrediente restringido, etc."></textarea>
        </div>
        
        <div class="modal-action">
            <button 
                class="btn btn-ghost btn-lg" 
                @click="cancelar()">
                ‚ùå Cancelar Venta
            </button>
            <button 
                class="btn btn-warning btn-lg" 
                @click="procederConVenta()"
                :disabled="!confirmado">
                <span x-show="!confirmado">‚ö†Ô∏è Debe confirmar para continuar</span>
                <span x-show="confirmado">‚úÖ Proceder con Venta</span>
            </button>
        </div>
    </div>
</dialog>

<!-- Modal de confirmaci√≥n de venta -->
<dialog id="modal-confirmar-venta" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg text-success">‚úÖ ¬°Venta Exitosa!</h3>
        <p class="py-4">La venta se registr√≥ correctamente.</p>
        <div class="modal-action">
            <button class="btn" onclick="document.getElementById('modal-confirmar-venta').close()">
                Cerrar
            </button>
            <button class="btn btn-primary" onclick="window.print()">
                üñ®Ô∏è Imprimir Ticket
            </button>
        </div>
    </div>
</dialog>

<!-- Modal de AUTORIZACI√ìN DE SUPERVISOR - Saldo Insuficiente -->
<dialog id="modal-autorizacion-supervisor" class="modal" x-data="autorizacionSupervisorModal()">
    <div class="modal-box max-w-2xl">
        <h3 class="font-bold text-2xl text-warning mb-4">
            üîê AUTORIZACI√ìN REQUERIDA
        </h3>
        
        <div class="alert alert-error mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div>
                <h4 class="font-bold">Saldo Insuficiente en Tarjeta</h4>
                <p class="text-sm">Se require autorizaci√≥n de supervisor para procesar como venta a cr√©dito</p>
            </div>
        </div>
        
        <!-- Informaci√≥n del estudiante y saldo -->
        <div class="bg-base-200 p-4 rounded-lg mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <div class="text-sm opacity-70">Estudiante:</div>
                    <div class="font-bold" x-text="datosEstudiante.nombre"></div>
                </div>
                <div>
                    <div class="text-sm opacity-70">Tarjeta:</div>
                    <div class="font-bold">#<span x-text="datosEstudiante.tarjeta"></span></div>
                </div>
                <div>
                    <div class="text-sm opacity-70">Saldo Disponible:</div>
                    <div class="font-bold text-success">Gs. <span x-text="formatNumber(datosEstudiante.saldo)"></span></div>
                </div>
                <div>
                    <div class="text-sm opacity-70">Total a Pagar:</div>
                    <div class="font-bold text-error">Gs. <span x-text="formatNumber(datosEstudiante.total)"></span></div>
                </div>
            </div>
            <div class="divider"></div>
            <div class="text-center">
                <div class="text-sm opacity-70">Monto Faltante:</div>
                <div class="text-2xl font-bold text-warning">
                    Gs. <span x-text="formatNumber(datosEstudiante.faltante)"></span>
                </div>
            </div>
        </div>
        
        <!-- Escanear tarjeta de supervisor -->
        <div class="form-control mb-4">
            <label class="label">
                <span class="label-text font-bold">Escanear Tarjeta de Supervisor:</span>
            </label>
            <input 
                type="text" 
                x-model="nroTarjetaSupervisor"
                @keyup.enter="validarSupervisor()"
                placeholder="Escanear tarjeta de supervisor..." 
                class="input input-bordered input-lg" 
                x-ref="inputSupervisor"
                autocomplete="off">
            <label class="label" x-show="supervisorValidado">
                <span class="label-text-alt text-success">
                    ‚úÖ Supervisor: <span x-text="nombreSupervisor"></span>
                </span>
            </label>
            <label class="label" x-show="errorSupervisor">
                <span class="label-text-alt text-error" x-text="errorSupervisor"></span>
            </label>
        </div>
        
        <!-- Motivo/Justificaci√≥n -->
        <div class="form-control mb-4">
            <label class="label">
                <span class="label-text font-bold">Motivo del Cr√©dito:</span>
            </label>
            <textarea 
                x-model="motivoCredito"
                class="textarea textarea-bordered h-24" 
                placeholder="Ej: Autorizado por el padre/madre, Emergencia escolar, etc."></textarea>
        </div>
        
        <div class="modal-action">
            <button 
                class="btn btn-ghost btn-lg" 
                @click="cancelar()">
                ‚ùå Cancelar
            </button>
            <button 
                class="btn btn-warning btn-lg" 
                @click="autorizarCredito()"
                :disabled="!supervisorValidado || !motivoCredito">
                <span x-show="!supervisorValidado || !motivoCredito">üîí Complete los datos</span>
                <span x-show="supervisorValidado && motivoCredito">‚úÖ Autorizar Venta a Cr√©dito</span>
            </button>
        </div>
    </div>
</dialog>

<script>
    // App Alpine para modal de autorizaci√≥n de supervisor
    function autorizacionSupervisorModal() {
        return {
            nroTarjetaSupervisor: '',
            supervisorValidado: false,
            nombreSupervisor: '',
            idSupervisor: null,
            errorSupervisor: '',
            motivoCredito: '',
            datosEstudiante: {
                nombre: '',
                tarjeta: '',
                saldo: 0,
                total: 0,
                faltante: 0
            },
            
            mostrar(datos) {
                this.datosEstudiante = datos;
                this.nroTarjetaSupervisor = '';
                this.supervisorValidado = false;
                this.nombreSupervisor = '';
                this.idSupervisor = null;
                this.errorSupervisor = '';
                this.motivoCredito = '';
                
                document.getElementById('modal-autorizacion-supervisor').showModal();
                
                setTimeout(() => {
                    this.$refs.inputSupervisor.focus();
                }, 100);
            },
            
            async validarSupervisor() {
                if (!this.nroTarjetaSupervisor) return;
                
                try {
                    const response = await fetch('{% url "pos:validar_supervisor" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            nro_tarjeta: this.nroTarjetaSupervisor
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.supervisorValidado = true;
                        this.nombreSupervisor = data.nombre;
                        this.idSupervisor = data.id_empleado;
                        this.errorSupervisor = '';
                    } else {
                        this.supervisorValidado = false;
                        this.errorSupervisor = data.error || 'Tarjeta de supervisor no v√°lida';
                    }
                } catch (error) {
                    console.error('Error al validar supervisor:', error);
                    this.errorSupervisor = 'Error al validar supervisor';
                }
            },
            
            cancelar() {
                document.getElementById('modal-autorizacion-supervisor').close();
                // Notificar que se cancel√≥
                const event = new CustomEvent('autorizacionCancelada');
                window.dispatchEvent(event);
            },
            
            autorizarCredito() {
                if (!this.supervisorValidado || !this.motivoCredito) return;
                
                document.getElementById('modal-autorizacion-supervisor').close();
                
                // Notificar que se autoriz√≥
                const event = new CustomEvent('autorizacionAprobada', {
                    detail: {
                        autorizado_por_id: this.idSupervisor,
                        motivo_credito: this.motivoCredito
                    }
                });
                window.dispatchEvent(event);
            },
            
            formatNumber(num) {
                return Math.round(num).toLocaleString('es-PY');
            }
        }
    }
</script>

<script>
    // App Alpine para modal de restricciones
    function restriccionesModal() {
        return {
            confirmado: false,
            justificacion: '',
            datosEstudiante: {
                nombre: '',
                tarjeta: '',
                restricciones: ''
            },
            
            mostrar(datos) {
                this.datosEstudiante = datos;
                this.confirmado = false;
                this.justificacion = '';
                document.getElementById('modal-restricciones').showModal();
            },
            
            cancelar() {
                document.getElementById('modal-restricciones').close();
                // Notificar que se cancel√≥
                const event = new CustomEvent('restriccionesCanceladas');
                window.dispatchEvent(event);
            },
            
            procederConVenta() {
                if (!this.confirmado) return;
                
                document.getElementById('modal-restricciones').close();
                
                // Notificar que se confirm√≥ con datos para auditor√≠a
                const event = new CustomEvent('restriccionesConfirmadas', {
                    detail: {
                        confirmado: true,
                        justificacion: this.justificacion
                    }
                });
                window.dispatchEvent(event);
            }
        }
    }
</script>
{% endblock %}

{% block extra_js %}
<script>
    // Funci√≥n para escanear tarjeta
    function scanCard() {
        playSound('scan');
    }
    
    // Obtener cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
