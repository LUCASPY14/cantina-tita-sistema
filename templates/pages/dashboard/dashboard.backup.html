{% extends "base.html" %}

{% block titulo %}Dashboard de Seguridad{% endblock %}

{% block contenido %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold">üîí Dashboard de Seguridad</h1>
            <p class="text-gray-600 mt-2">Monitoreo y control de seguridad del sistema</p>
        </div>
        <div class="flex gap-2">
            <a href="{% url 'pos:logs_auditoria' %}" class="btn btn-outline">
                üìã Ver Logs Completos
            </a>
            <a href="{% url 'pos:intentos_login' %}" class="btn btn-outline">
                üîë Intentos de Login
            </a>
        </div>
    </div>

    <!-- Estad√≠sticas Generales -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 mb-8">
        <div class="stat bg-base-100 shadow rounded-lg">
            <div class="stat-figure text-success">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <div class="stat-title">Logins Exitosos Hoy</div>
            <div class="stat-value text-success">{{ intentos_exitosos_hoy }}</div>
        </div>

        <div class="stat bg-base-100 shadow rounded-lg">
            <div class="stat-figure text-error">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </div>
            <div class="stat-title">Intentos Fallidos Hoy</div>
            <div class="stat-value text-error">{{ intentos_fallidos_hoy }}</div>
        </div>

        <div class="stat bg-base-100 shadow rounded-lg">
            <div class="stat-figure text-warning">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            </div>
            <div class="stat-title">Cuentas Bloqueadas</div>
            <div class="stat-value text-warning">{{ cuentas_bloqueadas }}</div>
        </div>

        <div class="stat bg-base-100 shadow rounded-lg">
            <div class="stat-figure text-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
            </div>
            <div class="stat-title">2FA Tasa √âxito (30d)</div>
            <div class="stat-value text-secondary text-2xl">{{ stats_2fa.tasa_exito }}%</div>
            <div class="stat-desc">{{ stats_2fa.exitosos }}/{{ stats_2fa.total_intentos }} intentos</div>
        </div>

        <div class="stat bg-base-100 shadow rounded-lg">
            <div class="stat-figure text-info">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path></svg>
            </div>
            <div class="stat-title">Tokens Activos</div>
            <div class="stat-value text-info">{{ tokens_activos }}</div>
        </div>

        <div class="stat bg-base-100 shadow rounded-lg">
            <div class="stat-figure text-primary">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            </div>
            <div class="stat-title">Sesiones Activas</div>
            <div class="stat-value text-primary">{{ sesiones_activas_count }}</div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Gr√°fico de Intentos -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">üìä Intentos de Login (√öltimos 14 d√≠as)</h2>
                <canvas id="chartIntentos" height="200"></canvas>
            </div>
        </div>

        <!-- IPs Sospechosas -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">üåê Top IPs Sospechosas (√öltimos 7 d√≠as)</h2>
                <div class="overflow-x-auto">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>IP Address</th>
                                <th>Ubicaci√≥n</th>
                                <th class="text-right">Intentos Fallidos</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ip in top_ips_sospechosas %}
                            <tr>
                                <td class="font-mono">{{ ip.ip_address }}</td>
                                <td class="text-sm text-gray-600">
                                    {% if ip.ciudad and ip.pais %}
                                        üåç {{ ip.ciudad }}, {{ ip.pais }}
                                    {% else %}
                                        <span class="text-gray-400">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-right">
                                    <span class="badge badge-error">{{ ip.intentos }}</span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center text-gray-500">No hay IPs sospechosas</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Anomal√≠as Detectadas y Sesiones Activas -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Anomal√≠as Recientes -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">‚ö†Ô∏è Anomal√≠as Detectadas (√öltimos 7 d√≠as)</h2>
                <div class="overflow-x-auto">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Tipo</th>
                                <th>Nivel</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for anomalia in anomalias_recientes %}
                            <tr>
                                <td class="font-semibold">{{ anomalia.usuario }}</td>
                                <td>
                                    {% if anomalia.tipo_anomalia == 'IP_NUEVA' %}
                                        <span class="badge badge-warning badge-xs">üÜï IP Nueva</span>
                                    {% elif anomalia.tipo_anomalia == 'HORARIO_INUSUAL' %}
                                        <span class="badge badge-info badge-xs">üïê Horario Inusual</span>
                                    {% elif anomalia.tipo_anomalia == 'MULTIPLES_SESIONES' %}
                                        <span class="badge badge-error badge-xs">üë• M√∫ltiples Sesiones</span>
                                    {% else %}
                                        <span class="badge badge-ghost badge-xs">{{ anomalia.tipo_anomalia }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if anomalia.nivel_riesgo == 'ALTO' %}
                                        <span class="badge badge-error badge-xs">üî¥ Alto</span>
                                    {% elif anomalia.nivel_riesgo == 'MEDIO' %}
                                        <span class="badge badge-warning badge-xs">üü° Medio</span>
                                    {% else %}
                                        <span class="badge badge-info badge-xs">üîµ Bajo</span>
                                    {% endif %}
                                </td>
                                <td class="text-xs">{{ anomalia.fecha_deteccion|date:"d/m H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-gray-500 py-4">
                                    ‚úÖ No hay anomal√≠as detectadas
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if anomalias_recientes %}
                <div class="mt-2 text-xs text-gray-500">
                    üí° Las anomal√≠as se detectan autom√°ticamente seg√∫n patrones de acceso aprendidos
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Sesiones Activas -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">üü¢ Sesiones Activas</h2>
                <div class="stat">
                    <div class="stat-figure text-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-12 h-12 stroke-current">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div class="stat-title">Usuarios conectados</div>
                    <div class="stat-value text-primary">{{ sesiones_activas_count }}</div>
                    <div class="stat-desc">Sesiones activas en tiempo real</div>
                </div>
                <div class="divider"></div>
                <div class="alert alert-info">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <div>
                        <h3 class="font-bold">An√°lisis de Patrones Activo</h3>
                        <div class="text-xs">El sistema aprende comportamientos normales y detecta accesos inusuales autom√°ticamente</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cuentas Bloqueadas -->
    <div class="card bg-base-100 shadow-xl mb-8">
        <div class="card-body">
            <h2 class="card-title">üö´ Cuentas Bloqueadas Actualmente</h2>
            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Tipo</th>
                            <th>Motivo</th>
                            <th>Fecha Bloqueo</th>
                            <th>Auto-Desbloqueo</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bloqueo in ultimos_bloqueos %}
                        <tr>
                            <td class="font-semibold">{{ bloqueo.usuario }}</td>
                            <td><span class="badge badge-sm">{{ bloqueo.tipo_usuario }}</span></td>
                            <td>{{ bloqueo.motivo }}</td>
                            <td>{{ bloqueo.fecha_bloqueo|date:"d/m/Y H:i" }}</td>
                            <td>
                                {% if bloqueo.fecha_desbloqueo %}
                                    {{ bloqueo.fecha_desbloqueo|date:"d/m/Y H:i" }}
                                {% else %}
                                    <span class="text-gray-500">Manual</span>
                                {% endif %}
                            </td>
                            <td>
                                <form method="post" action="{% url 'pos:desbloquear_cuenta' bloqueo.id_bloqueo %}" class="inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-xs btn-success" onclick="return confirm('¬øDesbloquear esta cuenta?')">
                                        üîì Desbloquear
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-gray-500 py-8">
                                ‚úÖ No hay cuentas bloqueadas actualmente
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Intentos 2FA y Anomal√≠as Cr√≠ticas -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Intentos 2FA Recientes -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">üîê Intentos 2FA Recientes (7 d√≠as)</h2>
                <div class="overflow-x-auto">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Ubicaci√≥n</th>
                                <th>Tipo</th>
                                <th>Resultado</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for intento in intentos_2fa_recientes %}
                            <tr>
                                <td class="font-mono text-sm">{{ intento.usuario }}</td>
                                <td class="text-xs">
                                    {% if intento.ciudad and intento.pais %}
                                        üåç {{ intento.ciudad }}, {{ intento.pais }}
                                    {% else %}
                                        <span class="text-gray-400">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge badge-xs {% if intento.tipo_codigo == 'BACKUP' %}badge-warning{% else %}badge-info{% endif %}">
                                        {{ intento.tipo_codigo }}
                                    </span>
                                </td>
                                <td>
                                    {% if intento.exitoso %}
                                        <span class="badge badge-success badge-xs">‚úì</span>
                                    {% else %}
                                        <span class="badge badge-error badge-xs">‚úó</span>
                                    {% endif %}
                                </td>
                                <td class="text-xs whitespace-nowrap">{{ intento.fecha_intento|date:"d/m H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-gray-500">No hay intentos 2FA recientes</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Anomal√≠as Cr√≠ticas -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">‚ö†Ô∏è Anomal√≠as de Seguridad (7 d√≠as)</h2>
                <div class="overflow-x-auto">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Tipo</th>
                                <th>Riesgo</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for anomalia in anomalias_recientes %}
                            <tr>
                                <td class="font-mono text-sm">{{ anomalia.usuario }}</td>
                                <td class="text-xs">{{ anomalia.tipo_anomalia }}</td>
                                <td>
                                    <span class="badge badge-xs 
                                        {% if anomalia.nivel_riesgo == 'ALTO' %}badge-error
                                        {% elif anomalia.nivel_riesgo == 'MEDIO' %}badge-warning
                                        {% else %}badge-info{% endif %}">
                                        {{ anomalia.nivel_riesgo }}
                                    </span>
                                </td>
                                <td class="text-xs whitespace-nowrap">{{ anomalia.fecha_deteccion|date:"d/m H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-gray-500">‚úÖ No hay anomal√≠as detectadas</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- √öltimas Operaciones de Auditor√≠a -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex justify-between items-center mb-4">
                <h2 class="card-title">üìù √öltimas Operaciones</h2>
                <a href="{% url 'pos:exportar_logs' %}" class="btn btn-sm btn-outline">
                    üì• Exportar CSV
                </a>
            </div>
            <div class="overflow-x-auto">
                <table class="table table-zebra table-sm">
                    <thead>
                        <tr>
                            <th>Fecha/Hora</th>
                            <th>Usuario</th>
                            <th>Operaci√≥n</th>
                            <th>Descripci√≥n</th>
                            <th>IP</th>
                            <th>Resultado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for op in ultimas_operaciones %}
                        <tr>
                            <td class="whitespace-nowrap">{{ op.fecha_operacion|date:"d/m H:i:s" }}</td>
                            <td>
                                <span class="badge badge-sm">{{ op.tipo_usuario }}</span>
                                {{ op.usuario }}
                            </td>
                            <td class="font-mono text-xs">{{ op.operacion }}</td>
                            <td class="text-sm">{{ op.descripcion|truncatewords:8 }}</td>
                            <td class="font-mono text-xs">{{ op.ip_address }}</td>
                            <td>
                                {% if op.resultado == 'EXITOSO' %}
                                    <span class="badge badge-success badge-xs">‚úì</span>
                                {% else %}
                                    <span class="badge badge-error badge-xs">‚úó</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Datos para el gr√°fico
const diasExitosos = {{ dias_exitosos|safe }};
const diasFallidos = {{ dias_fallidos|safe }};

// Obtener todas las fechas √∫nicas
const todasLasFechas = new Set([...Object.keys(diasExitosos), ...Object.keys(diasFallidos)]);
const fechasOrdenadas = Array.from(todasLasFechas).sort();

// Preparar datos
const dataExitosos = fechasOrdenadas.map(fecha => diasExitosos[fecha] || 0);
const dataFallidos = fechasOrdenadas.map(fecha => diasFallidos[fecha] || 0);

// Crear gr√°fico
const ctx = document.getElementById('chartIntentos').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: fechasOrdenadas.map(f => f.substring(5)), // Solo MM-DD
        datasets: [{
            label: 'Exitosos',
            data: dataExitosos,
            borderColor: 'rgb(34, 197, 94)',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            tension: 0.3
        }, {
            label: 'Fallidos',
            data: dataFallidos,
            borderColor: 'rgb(239, 68, 68)',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            tension: 0.3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            },
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});
</script>
{% endblock %}
