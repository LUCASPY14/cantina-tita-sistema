{% extends "base.html" %}
{% load static %}

{% block title %}Recuperar Contraseña - Cantina Tita{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-primary to-orange-600 flex items-center justify-center p-4">
    <div x-data="recuperarPassword()" class="w-full max-w-md">
        
        <!-- Logo y Header -->
        <div class="text-center mb-8">
            <div class="inline-block bg-white rounded-full p-4 mb-4 shadow-lg">
                <i class="fas fa-key text-5xl text-primary"></i>
            </div>
            <h1 class="text-4xl font-bold text-white mb-2">Cantina Tita</h1>
            <p class="text-white text-lg opacity-90">Recuperar Contraseña</p>
        </div>
        
        <!-- Formulario -->
        <div class="bg-white rounded-2xl shadow-2xl p-8">
            
            <!-- Estado: Formulario de Email -->
            <template x-if="!emailEnviado">
                <div>
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-secondary bg-opacity-10 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-envelope text-3xl text-secondary"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">
                            ¿Olvidaste tu contraseña?
                        </h2>
                        <p class="text-gray-600">
                            Ingresa tu email y te enviaremos un enlace para recuperar tu cuenta
                        </p>
                    </div>
                    
                    <!-- Mensajes -->
                    <template x-if="mensaje.texto">
                        <div class="alert mb-6" 
                             :class="{
                                 'alert-success': mensaje.tipo === 'success',
                                 'alert-error': mensaje.tipo === 'error',
                                 'alert-warning': mensaje.tipo === 'warning',
                                 'alert-info': mensaje.tipo === 'info'
                             }">
                            <i class="fas" 
                               :class="{
                                   'fa-check-circle': mensaje.tipo === 'success',
                                   'fa-exclamation-circle': mensaje.tipo === 'error',
                                   'fa-exclamation-triangle': mensaje.tipo === 'warning',
                                   'fa-info-circle': mensaje.tipo === 'info'
                               }"></i>
                            <span x-text="mensaje.texto"></span>
                        </div>
                    </template>
                    
                    <form @submit.prevent="enviarEmail()">
                        <!-- Email -->
                        <div class="form-control mb-6">
                            <label class="label">
                                <span class="label-text font-semibold">
                                    <i class="fas fa-envelope mr-2"></i>
                                    Email
                                </span>
                            </label>
                            <input type="email" 
                                   x-model="form.email"
                                   @input="validarEmail()"
                                   placeholder="correo@ejemplo.com"
                                   class="input input-bordered input-lg"
                                   :class="{'input-error': error}"
                                   required
                                   autofocus>
                            <template x-if="error">
                                <label class="label">
                                    <span class="label-text-alt text-error" x-text="error"></span>
                                </label>
                            </template>
                            <label class="label">
                                <span class="label-text-alt text-gray-600">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Ingresa el email asociado a tu cuenta
                                </span>
                            </label>
                        </div>
                        
                        <!-- Botón Enviar -->
                        <button type="submit" 
                                :disabled="!emailValido || enviando"
                                class="btn btn-secondary btn-lg w-full text-white gap-2 mb-4">
                            <template x-if="!enviando">
                                <i class="fas fa-paper-plane"></i>
                            </template>
                            <template x-if="enviando">
                                <span class="loading loading-spinner loading-sm"></span>
                            </template>
                            <span x-text="enviando ? 'Enviando...' : 'Enviar Enlace de Recuperación'"></span>
                        </button>
                        
                        <!-- Link a Login -->
                        <div class="text-center">
                            <a href="{% url 'login' %}" class="link link-secondary flex items-center justify-center gap-2">
                                <i class="fas fa-arrow-left"></i>
                                Volver al inicio de sesión
                            </a>
                        </div>
                    </form>
                </div>
            </template>
            
            <!-- Estado: Email Enviado -->
            <template x-if="emailEnviado">
                <div>
                    <div class="text-center">
                        <!-- Icono de éxito -->
                        <div class="w-20 h-20 bg-success bg-opacity-10 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-check-circle text-5xl text-success"></i>
                        </div>
                        
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">
                            ¡Email Enviado!
                        </h2>
                        
                        <div class="alert alert-success mb-6">
                            <i class="fas fa-envelope-open-text"></i>
                            <div class="text-left">
                                <p class="font-semibold">Revisa tu bandeja de entrada</p>
                                <p class="text-sm">Te hemos enviado un email a <span class="font-mono font-bold" x-text="form.email"></span></p>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 dark:bg-blue-900 rounded-lg p-6 mb-6 text-left">
                            <h3 class="font-bold mb-3 flex items-center gap-2">
                                <i class="fas fa-lightbulb text-warning"></i>
                                Instrucciones
                            </h3>
                            <ol class="list-decimal list-inside space-y-2 text-sm text-gray-700 dark:text-gray-300">
                                <li>Abre tu correo electrónico</li>
                                <li>Busca el email de Cantina Tita</li>
                                <li>Haz clic en el enlace de recuperación</li>
                                <li>Crea tu nueva contraseña</li>
                            </ol>
                        </div>
                        
                        <!-- Información adicional -->
                        <div class="space-y-3 text-sm text-gray-600">
                            <div class="flex items-start gap-2">
                                <i class="fas fa-clock text-warning mt-1"></i>
                                <p class="text-left">
                                    El enlace es válido por <strong>1 hora</strong>. Después de ese tiempo deberás solicitar uno nuevo.
                                </p>
                            </div>
                            
                            <div class="flex items-start gap-2">
                                <i class="fas fa-shield-alt text-success mt-1"></i>
                                <p class="text-left">
                                    Por seguridad, este enlace solo puede usarse una vez. Si necesitas recuperar tu contraseña nuevamente, deberás solicitar otro enlace.
                                </p>
                            </div>
                            
                            <div class="flex items-start gap-2">
                                <i class="fas fa-spam text-error mt-1"></i>
                                <p class="text-left">
                                    Si no encuentras el email, revisa tu carpeta de spam o correo no deseado.
                                </p>
                            </div>
                        </div>
                        
                        <!-- Reenviar email -->
                        <div class="divider my-6">¿No recibiste el email?</div>
                        
                        <template x-if="!puedeReenviar">
                            <div class="alert alert-info mb-4">
                                <i class="fas fa-clock"></i>
                                <span>Podrás solicitar un nuevo enlace en <strong x-text="tiempoEspera"></strong> segundos</span>
                            </div>
                        </template>
                        
                        <button @click="reenviarEmail()" 
                                :disabled="!puedeReenviar || reenviando"
                                class="btn btn-outline btn-secondary w-full gap-2 mb-4">
                            <template x-if="!reenviando">
                                <i class="fas fa-redo"></i>
                            </template>
                            <template x-if="reenviando">
                                <span class="loading loading-spinner loading-sm"></span>
                            </template>
                            <span x-text="reenviando ? 'Reenviando...' : 'Reenviar Email'"></span>
                        </button>
                        
                        <!-- Botones de navegación -->
                        <div class="flex flex-col gap-2">
                            <a href="{% url 'login' %}" class="btn btn-ghost gap-2">
                                <i class="fas fa-arrow-left"></i>
                                Volver al inicio de sesión
                            </a>
                            <button @click="emailEnviado = false; mensaje = {texto: '', tipo: ''}" 
                                    class="btn btn-ghost btn-sm gap-2">
                                <i class="fas fa-envelope"></i>
                                Usar otro email
                            </button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
        
        <!-- Ayuda adicional -->
        <div class="text-center mt-6">
            <p class="text-white text-sm opacity-90">
                ¿Necesitas ayuda? 
                <a href="#" class="link link-white font-semibold">Contacta con soporte</a>
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
function recuperarPassword() {
    return {
        form: {
            email: ''
        },
        error: '',
        mensaje: {
            texto: '',
            tipo: ''
        },
        emailEnviado: false,
        enviando: false,
        reenviando: false,
        puedeReenviar: false,
        tiempoEspera: 60,
        intervalo: null,
        
        get emailValido() {
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailPattern.test(this.form.email);
        },
        
        validarEmail() {
            this.error = '';
            this.mensaje = { texto: '', tipo: '' };
            
            if (this.form.email && !this.emailValido) {
                this.error = 'Por favor ingresa un email válido';
            }
        },
        
        async enviarEmail() {
            if (!this.emailValido) {
                this.mensaje = {
                    texto: 'Por favor ingresa un email válido',
                    tipo: 'warning'
                };
                return;
            }
            
            this.enviando = true;
            this.mensaje = { texto: '', tipo: '' };
            this.error = '';
            
            try {
                const response = await fetch('/api/auth/recuperar-password/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        email: this.form.email
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.emailEnviado = true;
                    this.iniciarContadorReenvio();
                } else {
                    // Por seguridad, mostramos mensaje genérico incluso si el email no existe
                    if (data.code === 'email_not_found') {
                        this.mensaje = {
                            texto: 'Si el email existe en nuestro sistema, recibirás un enlace de recuperación.',
                            tipo: 'info'
                        };
                        // Aún así mostramos la pantalla de éxito para no revelar si el email existe
                        setTimeout(() => {
                            this.emailEnviado = true;
                            this.iniciarContadorReenvio();
                        }, 1000);
                    } else {
                        this.mensaje = {
                            texto: data.message || 'Error al enviar el email de recuperación',
                            tipo: 'error'
                        };
                    }
                }
            } catch (error) {
                console.error('Error al enviar email:', error);
                this.mensaje = {
                    texto: 'Error de conexión. Por favor intenta nuevamente.',
                    tipo: 'error'
                };
            } finally {
                this.enviando = false;
            }
        },
        
        iniciarContadorReenvio() {
            this.puedeReenviar = false;
            this.tiempoEspera = 60;
            
            if (this.intervalo) {
                clearInterval(this.intervalo);
            }
            
            this.intervalo = setInterval(() => {
                this.tiempoEspera--;
                
                if (this.tiempoEspera <= 0) {
                    this.puedeReenviar = true;
                    clearInterval(this.intervalo);
                    this.intervalo = null;
                }
            }, 1000);
        },
        
        async reenviarEmail() {
            if (!this.puedeReenviar) return;
            
            this.reenviando = true;
            
            try {
                const response = await fetch('/api/auth/recuperar-password/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        email: this.form.email
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.mensaje = {
                        texto: 'Email reenviado correctamente',
                        tipo: 'success'
                    };
                    this.iniciarContadorReenvio();
                } else {
                    this.mensaje = {
                        texto: data.message || 'Error al reenviar el email',
                        tipo: 'error'
                    };
                }
            } catch (error) {
                console.error('Error al reenviar email:', error);
                this.mensaje = {
                    texto: 'Error de conexión. Por favor intenta nuevamente.',
                    tipo: 'error'
                };
            } finally {
                this.reenviando = false;
            }
        },
        
        getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    }
}
</script>
{% endblock %}
