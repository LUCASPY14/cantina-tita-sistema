{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard Unificado - Cantina Tita{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .metric-title {
        font-size: 14px;
        color: #666;
        margin-bottom: 10px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .metric-value {
        font-size: 32px;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .metric-subtitle {
        font-size: 14px;
        color: #7f8c8d;
        margin-top: 5px;
    }
    
    .metric-good { color: #27ae60; }
    .metric-warning { color: #f39c12; }
    .metric-danger { color: #e74c3c; }
    
    .progress-bar-custom {
        height: 8px;
        border-radius: 4px;
        background: #ecf0f1;
        overflow: hidden;
        margin-top: 10px;
    }
    
    .progress-fill {
        height: 100%;
        transition: width 0.3s;
    }
    
    .bg-success { background-color: #27ae60 !important; }
    .bg-warning { background-color: #f39c12 !important; }
    .bg-danger { background-color: #e74c3c !important; }
    
    .alert-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        margin-right: 5px;
    }
    
    .alert-critico { background: #e74c3c; color: white; }
    .alert-importante { background: #f39c12; color: white; }
    .alert-normal { background: #3498db; color: white; }
    
    .stock-item {
        padding: 10px;
        border-bottom: 1px solid #ecf0f1;
    }
    
    .stock-item:last-child {
        border-bottom: none;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 8px;
        margin-bottom: 30px;
    }
    
    .refresh-info {
        font-size: 12px;
        color: #95a5a6;
        text-align: right;
        margin-top: 10px;
    }
    
    .cache-badge {
        display: inline-block;
        background: #3498db;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 10px;
        margin-left: 10px;
    }
    
    .system-status {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }
    
    .status-ok { background: #27ae60; }
    .status-warning { background: #f39c12; }
    .status-error { background: #e74c3c; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1>
        üìä Dashboard Unificado
        {% if from_cache %}
        <span class="cache-badge">CACHED</span>
        {% endif %}
    </h1>
    <p>Monitoreo en tiempo real del sistema Cantina Tita</p>
    <div class="refresh-info">
        √öltima actualizaci√≥n: {{ ultima_actualizacion|date:"d/m/Y H:i:s" }}
        <a href="{% url 'invalidar_cache_dashboard' %}" style="color: white; text-decoration: underline; margin-left: 10px;">
            üîÑ Refrescar
        </a>
    </div>
</div>

<!-- M√âTRICAS DE VENTAS -->
<div class="row">
    <div class="col-md-12">
        <h3>üí∞ Ventas</h3>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-title">Ventas Hoy</div>
            <div class="metric-value metric-good">
                ‚Ç≤ {{ ventas.hoy_total.total|floatformat:0|default:"0"|intcomma }}
            </div>
            <div class="metric-subtitle">
                {{ ventas.hoy_total.cantidad }} transacciones
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-title">Promedio Venta</div>
            <div class="metric-value">
                ‚Ç≤ {{ ventas.promedio_venta|floatformat:0|intcomma }}
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-title">Ventas 7 D√≠as</div>
            <div class="metric-value">
                ‚Ç≤ {{ ventas.semana_total.total|floatformat:0|default:"0"|intcomma }}
            </div>
            <div class="metric-subtitle">
                {{ ventas.semana_total.cantidad }} ventas
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-title">Ventas 30 D√≠as</div>
            <div class="metric-value">
                ‚Ç≤ {{ ventas.mes_total.total|floatformat:0|default:"0"|intcomma }}
            </div>
            <div class="metric-subtitle">
                {{ ventas.mes_total.cantidad }} ventas
            </div>
        </div>
    </div>
</div>

<!-- MEDIOS DE PAGO -->
<div class="row">
    <div class="col-md-12">
        <h4>Medios de Pago (Hoy)</h4>
    </div>
    
    <div class="col-md-4">
        <div class="metric-card">
            <div class="metric-title">üíµ Efectivo</div>
            <div class="metric-value">‚Ç≤ {{ ventas.hoy_efectivo|floatformat:0|intcomma }}</div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="metric-card">
            <div class="metric-title">üí≥ Tarjeta</div>
            <div class="metric-value">‚Ç≤ {{ ventas.hoy_tarjeta|floatformat:0|intcomma }}</div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="metric-card">
            <div class="metric-title">üì± QR/Digital</div>
            <div class="metric-value">‚Ç≤ {{ ventas.hoy_qr|floatformat:0|intcomma }}</div>
        </div>
    </div>
</div>

<!-- M√âTRICAS DE STOCK -->
<div class="row mt-4">
    <div class="col-md-12">
        <h3>üì¶ Inventario</h3>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-title">Total Productos</div>
            <div class="metric-value">{{ stock.total_productos }}</div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-title">Stock Bajo</div>
            <div class="metric-value {% if stock.bajo_stock > 5 %}metric-warning{% endif %}">
                {{ stock.bajo_stock }}
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-title">Stock Cr√≠tico</div>
            <div class="metric-value {% if stock.critico > 0 %}metric-danger{% endif %}">
                {{ stock.critico }}
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-title">Valor Inventario</div>
            <div class="metric-value">
                ‚Ç≤ {{ stock.valor_inventario|floatformat:0|intcomma }}
            </div>
        </div>
    </div>
</div>

<!-- PRODUCTOS CON STOCK BAJO -->
{% if stock.productos_bajo_stock %}
<div class="row mt-3">
    <div class="col-md-12">
        <div class="metric-card">
            <h5>‚ö†Ô∏è Productos con Stock Bajo</h5>
            {% for item in stock.productos_bajo_stock %}
            <div class="stock-item">
                <strong>{{ item.producto.nombre }}</strong>
                <span class="pull-right">
                    Cantidad: <span class="{% if item.cantidad == 0 %}metric-danger{% elif item.cantidad <= item.stock_minimo %}metric-warning{% endif %}">
                        {{ item.cantidad }}
                    </span>
                    / M√≠nimo: {{ item.stock_minimo }}
                </span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- M√âTRICAS DE TARJETAS -->
<div class="row mt-4">
    <div class="col-md-12">
        <h3>üí≥ Tarjetas</h3>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-title">Tarjetas Activas</div>
            <div class="metric-value metric-good">{{ tarjetas.activas }}</div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-title">Saldo Total</div>
            <div class="metric-value">
                ‚Ç≤ {{ tarjetas.saldo_total|floatformat:0|intcomma }}
            </div>
            <div class="metric-subtitle">
                Promedio: ‚Ç≤ {{ tarjetas.promedio_saldo|floatformat:0|intcomma }}
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-title">Recargas Hoy</div>
            <div class="metric-value metric-good">
                ‚Ç≤ {{ tarjetas.recargas_hoy_total.total|floatformat:0|default:"0"|intcomma }}
            </div>
            <div class="metric-subtitle">
                {{ tarjetas.recargas_hoy_total.cantidad }} recargas
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-title">Consumos Hoy</div>
            <div class="metric-value">
                ‚Ç≤ {{ tarjetas.consumos_hoy_total.total|floatformat:0|default:"0"|intcomma }}
            </div>
            <div class="metric-subtitle">
                {{ tarjetas.consumos_hoy_total.cantidad }} consumos
            </div>
        </div>
    </div>
</div>

<!-- ALERTAS -->
<div class="row mt-4">
    <div class="col-md-12">
        <h3>üö® Alertas Activas</h3>
    </div>
    
    <div class="col-md-12">
        <div class="metric-card">
            <div style="margin-bottom: 15px;">
                <span class="alert-badge alert-critico">{{ alertas.criticas }} Cr√≠ticas</span>
                <span class="alert-badge alert-importante">{{ alertas.importantes }} Importantes</span>
                <span class="alert-badge alert-normal">{{ alertas.normales }} Normales</span>
            </div>
            
            {% if alertas.ultimas %}
            <h5>√öltimas Alertas:</h5>
            {% for alerta in alertas.ultimas %}
            <div class="stock-item">
                <span class="alert-badge alert-{{ alerta.nivel }}">{{ alerta.get_nivel_display }}</span>
                <strong>{{ alerta.mensaje }}</strong>
                <span class="pull-right" style="color: #95a5a6; font-size: 12px;">
                    {{ alerta.fecha_creacion|date:"d/m/Y H:i" }}
                </span>
            </div>
            {% endfor %}
            {% else %}
            <p style="color: #27ae60;">‚úÖ No hay alertas activas</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- M√âTRICAS DEL SISTEMA -->
<div class="row mt-4">
    <div class="col-md-12">
        <h3>‚öôÔ∏è Estado del Sistema</h3>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-title">CPU</div>
            <div class="metric-value {% if sistema.cpu_alerta %}metric-danger{% elif sistema.cpu > 60 %}metric-warning{% else %}metric-good{% endif %}">
                {{ sistema.cpu|floatformat:1 }}%
            </div>
            <div class="progress-bar-custom">
                <div class="progress-fill {% if sistema.cpu_alerta %}bg-danger{% elif sistema.cpu > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                     data-width="{{ sistema.cpu }}"></div>
            </div>
            <script>document.currentScript.previousElementSibling.querySelector('.progress-fill').style.width = document.currentScript.previousElementSibling.querySelector('.progress-fill').dataset.width + '%';</script>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-title">Memoria RAM</div>
            <div class="metric-value {% if sistema.memoria_alerta %}metric-danger{% elif sistema.memoria_usada > 70 %}metric-warning{% else %}metric-good{% endif %}">
                {{ sistema.memoria_usada|floatformat:1 }}%
            </div>
            <div class="metric-subtitle">
                {{ sistema.memoria_disponible_gb|floatformat:1 }} GB disponibles
            </div>
            <div class="progress-bar-custom">
                <div class="progress-fill {% if sistema.memoria_alerta %}bg-danger{% elif sistema.memoria_usada > 70 %}bg-warning{% else %}bg-success{% endif %}" 
                     data-width="{{ sistema.memoria_usada }}"></div>
            </div>
            <script>document.currentScript.previousElementSibling.querySelector('.progress-fill').style.width = document.currentScript.previousElementSibling.querySelector('.progress-fill').dataset.width + '%';</script>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-title">Disco</div>
            <div class="metric-value {% if sistema.disco_alerta %}metric-danger{% elif sistema.disco_usado > 75 %}metric-warning{% else %}metric-good{% endif %}">
                {{ sistema.disco_usado|floatformat:1 }}%
            </div>
            <div class="metric-subtitle">
                {{ sistema.disco_libre_gb|floatformat:1 }} GB libres
            </div>
            <div class="progress-bar-custom">
                <div class="progress-fill {% if sistema.disco_alerta %}bg-danger{% elif sistema.disco_usado > 75 %}bg-warning{% else %}bg-success{% endif %}" 
                     data-width="{{ sistema.disco_usado }}"></div>
            </div>
            <script>document.currentScript.previousElementSibling.querySelector('.progress-fill').style.width = document.currentScript.previousElementSibling.querySelector('.progress-fill').dataset.width + '%';</script>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-title">Servicios</div>
            <div class="system-status">
                <div class="status-indicator {% if sistema.redis_activo %}status-ok{% else %}status-error{% endif %}"></div>
                <span>Redis {% if sistema.redis_activo %}Activo{% else %}Inactivo{% endif %}</span>
            </div>
            <div class="system-status">
                <div class="status-indicator {% if sistema.backups.existe %}status-ok{% else %}status-warning{% endif %}"></div>
                <span>Backups ({{ sistema.backups.total }})</span>
            </div>
            {% if sistema.backups.ultimo %}
            <div class="metric-subtitle">
                √öltimo: {{ sistema.backups.ultimo|date:"d/m/Y H:i" }}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- TOP PRODUCTOS -->
{% if top_productos %}
<div class="row mt-4">
    <div class="col-md-12">
        <h3>üèÜ Top Productos (Hoy)</h3>
    </div>
    <div class="col-md-12">
        <div class="metric-card">
            {% for producto in top_productos %}
            <div class="stock-item">
                <strong>{{ forloop.counter }}. {{ producto.nombre }}</strong>
                <span class="pull-right metric-good">
                    {{ producto.vendidos }} unidades vendidas
                </span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- CLIENTES -->
<div class="row mt-4">
    <div class="col-md-12">
        <h3>üë• Clientes</h3>
    </div>
    
    <div class="col-md-4">
        <div class="metric-card">
            <div class="metric-title">Total Clientes</div>
            <div class="metric-value">{{ clientes.total }}</div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="metric-card">
            <div class="metric-title">Con Tarjeta</div>
            <div class="metric-value">{{ clientes.con_tarjeta }}</div>
            <div class="metric-subtitle">
                {{ clientes.con_tarjeta|floatformat:0 }}% del total
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="metric-card">
            <div class="metric-title">Nuevos (30 d√≠as)</div>
            <div class="metric-value metric-good">{{ clientes.nuevos_mes }}</div>
        </div>
    </div>
</div>

<!-- ACCIONES R√ÅPIDAS -->
<div class="row mt-4 mb-4">
    <div class="col-md-12">
        <h3>‚ö° Acciones R√°pidas</h3>
    </div>
    <div class="col-md-12">
        <div class="metric-card">
            <a href="{% url 'dashboard_ventas_detalle' %}" class="btn btn-primary">
                üìà Ver Detalles de Ventas
            </a>
            <a href="{% url 'dashboard_stock_detalle' %}" class="btn btn-info">
                üì¶ Ver Detalles de Stock
            </a>
            <a href="/health/" class="btn btn-success" target="_blank">
                ‚ù§Ô∏è Health Check
            </a>
            <a href="{% url 'invalidar_cache_dashboard' %}" class="btn btn-warning">
                üîÑ Refrescar Datos
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh cada 5 minutos
setTimeout(function() {
    window.location.reload();
}, 300000);

// Mostrar tooltip en hover
$(document).ready(function(){
    $('[data-toggle="tooltip"]').tooltip();
});
</script>
{% endblock %}
