{% extends "base_pos.html" %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard Almuerzos - MetrePay{% endblock %}

{% block extra_styles %}
<style>
    .stat-card {
        @apply rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-2xl hover:scale-105;
    }
    
    .gradient-consumos {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
    }
    
    .gradient-suscripciones {
        background: linear-gradient(135deg, #f97316 0%, #ea580c 100%) !important;
    }
    
    .gradient-ingresos {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%) !important;
    }
    
    .gradient-asistencia {
        background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%) !important;
    }
    
    .attendance-bar {
        @apply h-8 rounded-lg transition-all duration-500;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 space-y-8"
     x-data="dashboardAlmuerzos()" 
     x-init="init()">
    
    <!-- Header -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-4xl font-bold bg-gradient-to-r from-green-600 to-orange-600 bg-clip-text text-transparent flex items-center gap-3">
                    <i class="fas fa-utensils text-green-600"></i>
                    Dashboard de Almuerzos
                </h1>
                <p class="text-gray-600 mt-2">
                    {{ stats.fecha_hoy }} - {{ stats.mes_actual }}
                </p>
            </div>
            <div class="flex gap-3">
                <a href="{% url 'pos:registro_consumo_almuerzo_view' %}" class="btn btn-success gap-2">
                    <i class="fas fa-qrcode"></i>
                    Registrar Consumo
                </a>
                <a href="{% url 'pos:planes_almuerzo_view' %}" class="btn btn-outline btn-primary gap-2">
                    <i class="fas fa-clipboard-list"></i>
                    Gestionar Planes
                </a>
            </div>
        </div>
    </div>

    <!-- KPIs Principales -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        
        <!-- Almuerzos Hoy -->
        <div class="stat-card gradient-consumos text-white">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <p class="text-sm opacity-90 font-medium">Almuerzos Hoy</p>
                    <p class="text-5xl font-bold mt-2">{{ stats.consumos_hoy }}</p>
                </div>
                <div class="bg-white bg-opacity-20 p-4 rounded-full">
                    <i class="fas fa-utensils text-4xl"></i>
                </div>
            </div>
            <div class="flex items-center gap-2 text-sm opacity-90 mt-4 pt-4 border-t border-white border-opacity-30">
                <i class="fas fa-calendar-day"></i>
                <span>Servidos hoy</span>
            </div>
        </div>

        <!-- Suscripciones Activas -->
        <div class="stat-card gradient-suscripciones text-white">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <p class="text-sm opacity-90 font-medium">Suscripciones</p>
                    <p class="text-5xl font-bold mt-2">{{ stats.suscripciones_activas }}</p>
                </div>
                <div class="bg-white bg-opacity-20 p-4 rounded-full">
                    <i class="fas fa-users text-4xl"></i>
                </div>
            </div>
            <div class="flex items-center gap-2 text-sm opacity-90 mt-4 pt-4 border-t border-white border-opacity-30">
                <i class="fas fa-check-circle"></i>
                <span>Activas</span>
            </div>
        </div>

        <!-- Ingresos del Mes -->
        <div class="stat-card gradient-ingresos text-white">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <p class="text-sm opacity-90 font-medium">Ingresos Mes</p>
                    <p class="text-3xl font-bold mt-2">{{ stats.ingresos_mes|floatformat:0|intcomma }} ₲</p>
                </div>
                <div class="bg-white bg-opacity-20 p-4 rounded-full">
                    <i class="fas fa-money-bill-wave text-4xl"></i>
                </div>
            </div>
            <div class="flex items-center gap-2 text-sm opacity-90 mt-4 pt-4 border-t border-white border-opacity-30">
                <i class="fas fa-calendar-alt"></i>
                <span>{{ stats.mes_actual }}</span>
            </div>
        </div>

        <!-- Asistencia Semanal -->
        <div class="stat-card gradient-asistencia text-white">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <p class="text-sm opacity-90 font-medium">Asistencia</p>
                    <p class="text-5xl font-bold mt-2">{{ stats.asistencia_semanal }}%</p>
                </div>
                <div class="bg-white bg-opacity-20 p-4 rounded-full">
                    <i class="fas fa-chart-line text-4xl"></i>
                </div>
            </div>
            <div class="flex items-center gap-2 text-sm opacity-90 mt-4 pt-4 border-t border-white border-opacity-30">
                <i class="fas fa-calendar-week"></i>
                <span>Últimos 7 días</span>
            </div>
        </div>
    </div>

    <!-- Gráfico de Consumo Semanal y Planes Activos -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- Consumo de la Semana -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
                <i class="fas fa-chart-bar text-green-600"></i>
                Consumo Semanal
            </h2>

            <div class="space-y-4">
                {% for dia in consumo_semanal %}
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-gray-800">
                                {{ dia.fecha|date:"l d" }}
                            </span>
                            <div class="flex items-center gap-3">
                                <span class="text-sm text-gray-600">{{ dia.total }} almuerzos</span>
                                <span class="badge {% if dia.porcentaje >= 80 %}badge-success{% elif dia.porcentaje >= 60 %}badge-warning{% else %}badge-error{% endif %}">
                                    {{ dia.porcentaje }}%
                                </span>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-8 overflow-hidden">
                            <div class="attendance-bar {% if dia.porcentaje >= 80 %}bg-green-500{% elif dia.porcentaje >= 60 %}bg-yellow-500{% else %}bg-red-500{% endif %}" 
                                 style="width: {{ dia.porcentaje }}%">
                                <span class="text-white text-xs font-bold px-2 leading-8">
                                    {% if dia.porcentaje > 10 %}{{ dia.total }}{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Planes Activos -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-6 flex items-center justify-between">
                <span class="flex items-center gap-3">
                    <i class="fas fa-clipboard-list text-orange-600"></i>
                    Planes Activos
                </span>
                <a href="{% url 'pos:planes_almuerzo_view' %}" class="text-sm text-primary hover:underline">
                    Ver todos
                </a>
            </h2>

            <div class="space-y-4">
                {% if planes_activos %}
                    {% for plan in planes_activos %}
                        <div class="p-4 bg-gradient-to-r from-orange-50 to-yellow-50 rounded-lg border border-orange-200 hover:shadow-md transition-shadow">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex-1">
                                    <h3 class="font-bold text-gray-800 text-lg">{{ plan.nombre_plan }}</h3>
                                    <p class="text-sm text-gray-600 mt-1">{{ plan.descripcion|truncatewords:15 }}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-2xl font-bold text-orange-600">{{ plan.precio_mensual|floatformat:0|intcomma }} ₲</p>
                                    <p class="text-xs text-gray-500">por mes</p>
                                </div>
                            </div>
                            <div class="flex items-center justify-between mt-3 pt-3 border-t border-orange-200">
                                <span class="badge badge-primary gap-2">
                                    <i class="fas fa-users"></i>
                                    {{ plan.num_suscriptores }} suscriptor{{ plan.num_suscriptores|pluralize:"es" }}
                                </span>
                                <span class="text-xs text-gray-600">
                                    <i class="fas fa-calendar-week mr-1"></i>
                                    {{ plan.dias_semana_incluidos }}
                                </span>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-8">
                        <i class="fas fa-clipboard text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-600">No hay planes activos</p>
                        <a href="{% url 'pos:crear_plan_almuerzo' %}" class="btn btn-primary btn-sm mt-4">
                            <i class="fas fa-plus mr-2"></i>Crear Plan
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Suscripciones Próximas a Vencer -->
    {% if suscripciones_proximas %}
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
                <i class="fas fa-exclamation-triangle text-yellow-500"></i>
                Suscripciones Próximas a Vencer
            </h2>

            <div class="overflow-x-auto">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr>
                            <th>Estudiante</th>
                            <th>Plan</th>
                            <th>Fecha Fin</th>
                            <th>Días Restantes</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for suscripcion in suscripciones_proximas %}
                            <tr class="hover">
                                <td>
                                    <div class="flex items-center gap-3">
                                        <div class="avatar placeholder">
                                            <div class="bg-primary text-white rounded-full w-10">
                                                <span class="text-sm">{{ suscripcion.id_hijo.nombre|first }}{{ suscripcion.id_hijo.apellido|first }}</span>
                                            </div>
                                        </div>
                                        <div>
                                            <p class="font-bold">{{ suscripcion.id_hijo.nombre_completo }}</p>
                                            <p class="text-sm text-gray-500">{{ suscripcion.id_hijo.grado }}</p>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="font-semibold">{{ suscripcion.id_plan_almuerzo.nombre_plan }}</span>
                                </td>
                                <td>{{ suscripcion.fecha_fin|date:"d/m/Y" }}</td>
                                <td>
                                    <span class="badge {% if suscripcion.dias_restantes <= 3 %}badge-error{% elif suscripcion.dias_restantes <= 7 %}badge-warning{% else %}badge-info{% endif %}">
                                        {{ suscripcion.dias_restantes }} día{{ suscripcion.dias_restantes|pluralize }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge badge-success">{{ suscripcion.estado }}</span>
                                </td>
                                <td>
                                    <a href="{% url 'pos:suscripciones_almuerzo_view' %}?hijo={{ suscripcion.id_hijo.id_hijo }}" 
                                       class="btn btn-sm btn-outline btn-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}

    <!-- Acciones Rápidas -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
            <i class="fas fa-bolt text-yellow-500"></i>
            Acciones Rápidas
        </h2>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <a href="{% url 'pos:registro_consumo_almuerzo_view' %}" 
               class="flex flex-col items-center gap-3 p-6 bg-gradient-to-br from-green-50 to-green-100 rounded-lg hover:shadow-lg transition-all hover:scale-105">
                <div class="w-16 h-16 flex items-center justify-center rounded-full bg-green-500 text-white">
                    <i class="fas fa-qrcode text-3xl"></i>
                </div>
                <span class="text-sm font-medium text-gray-800 text-center">Registrar Consumo</span>
            </a>

            <a href="{% url 'pos:suscripciones_almuerzo_view' %}" 
               class="flex flex-col items-center gap-3 p-6 bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg hover:shadow-lg transition-all hover:scale-105">
                <div class="w-16 h-16 flex items-center justify-center rounded-full bg-orange-500 text-white">
                    <i class="fas fa-users text-3xl"></i>
                </div>
                <span class="text-sm font-medium text-gray-800 text-center">Suscripciones</span>
            </a>

            <a href="{% url 'pos:planes_almuerzo_view' %}" 
               class="flex flex-col items-center gap-3 p-6 bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg hover:shadow-lg transition-all hover:scale-105">
                <div class="w-16 h-16 flex items-center justify-center rounded-full bg-purple-500 text-white">
                    <i class="fas fa-clipboard-list text-3xl"></i>
                </div>
                <span class="text-sm font-medium text-gray-800 text-center">Gestionar Planes</span>
            </a>

            <a href="{% url 'pos:reportes_almuerzos_view' %}" 
               class="flex flex-col items-center gap-3 p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg hover:shadow-lg transition-all hover:scale-105">
                <div class="w-16 h-16 flex items-center justify-center rounded-full bg-blue-500 text-white">
                    <i class="fas fa-chart-pie text-3xl"></i>
                </div>
                <span class="text-sm font-medium text-gray-800 text-center">Reportes</span>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
function dashboardAlmuerzos() {
    return {
        init() {
            console.log('Dashboard de Almuerzos cargado');
        }
    }
}
</script>
{% endblock %}
