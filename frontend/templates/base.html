<!DOCTYPE html>
<html lang="es" x-data="{ darkMode: $persist(false) }" :class="{ 'dark': darkMode }">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Cantina Tita - Sistema de Punto de Venta y Gestión">
    <meta name="theme-color" content="#FF6B35">
    
    <title>{% block title %}Cantina Tita{% endblock %}</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{% static 'manifest.json' %}">
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'icons/icon-16x16.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'icons/icon-32x32.png' %}">
    <link rel="apple-touch-icon" sizes="192x192" href="{% static 'icons/icon-192x192.png' %}">
    
    <!-- Tailwind CSS + DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- Howler.js para sonidos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
    
    <!-- PWA Install Handler -->
    <script src="{% static 'js/pwa-install.js' %}" defer></script>
    
    <!-- Performance Optimizations -->
    <script src="{% static 'js/optimizations.js' %}" defer></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <!-- Configuración Tailwind personalizada -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#FF6B35',
                        secondary: '#4ECDC4',
                        accent: '#f59e0b',
                        success: '#2ECC71',
                        warning: '#F39C12',
                        danger: '#E74C3C',
                        'gray-light': '#f8fafc',
                        'gray-dark': '#1e293b'
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                        'heading': ['Poppins', 'system-ui', 'sans-serif']
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-in': 'slideIn 0.3s ease-out',
                        'slide-down': 'slideDown 0.2s ease-out',
                        'pulse-slow': 'pulse 3s infinite',
                        'spin-slow': 'spin 2s linear infinite'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideIn: {
                            '0%': { transform: 'translateY(-10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(-100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        }
                    },
                    screens: {
                        'xs': '375px',
                        'touch': { 'raw': '(hover: none)' },
                        'mouse': { 'raw': '(hover: hover)' }
                    }
                }
            }
        }
    </script>
    
    <!-- Estilos globales -->
    <style>
        /* Reset y base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            scroll-behavior: smooth;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: linear-gradient(135deg, #FF6B35 0%, #FFB199 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #1f2937;
            line-height: 1.6;
        }
        
        /* Dark mode */
        .dark body {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: #f1f5f9;
        }
        
        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #FF6B35, #4ECDC4);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #4ECDC4, #FF6B35);
        }
        
        /* Focus states accesibles */
        :focus-visible {
            outline: 2px solid #FF6B35;
            outline-offset: 2px;
            border-radius: 4px;
        }
        
        /* Botones mejorados */
        .btn-enhanced {
            transform: translateZ(0);
            transition: all 200ms ease;
        }
        .btn-enhanced:hover {
            transform: scale(1.05);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .btn-enhanced:active {
            transform: scale(0.95);
        }
        
        /* Cards interactivas */
        .card-interactive {
            transform: translateZ(0);
            transition: all 300ms ease;
            cursor: pointer;
        }
        .card-interactive:hover {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: translateY(-4px);
        }
        
        /* Loading spinner personalizado */
        .spinner {
            border: 3px solid rgba(255, 107, 53, 0.1);
            border-top-color: #FF6B35;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Skeleton loader */
        .skeleton {
            background-color: #d1d5db;
            border-radius: 0.25rem;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .dark .skeleton {
            background-color: #374151;
        }
        
        /* Toast notifications - posicionamiento */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            max-width: 24rem;
            pointer-events: none;
        }
        
        .toast-item {
            pointer-events: auto;
        }
        
        /* Responsive utilities */
        @media (max-width: 640px) {
            .toast-container {
                right: 0.5rem;
                left: 0.5rem;
                max-width: calc(100% - 1rem);
            }
        }
    </style>
    
    {% block extra_styles %}{% endblock %}
    {% block extra_head %}{% endblock %}
</head>
<body class="{% block body_class %}{% endblock %}">
    <!-- Contenedor principal -->
    <div id="app" class="min-h-screen">
        
        <!-- Header -->
        {% block header %}
        <header class="bg-white dark:bg-gray-800 shadow-lg">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <!-- Logo y título -->
                    <div class="flex items-center space-x-4">
                        <img src="{% static 'images/tita_logotipo.png' %}" 
                             alt="Cantina Tita Logo" 
                             class="h-12 w-12 object-contain"
                             loading="lazy">
                        <div>
                            <h1 class="text-2xl font-heading font-bold text-primary dark:text-orange-400">
                                {% block header_title %}Cantina Tita{% endblock %}
                            </h1>
                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                {% block header_subtitle %}Sistema de Gestión{% endblock %}
                            </p>
                        </div>
                    </div>
                    
                    <!-- Navigation -->
                    <nav class="hidden md:flex items-center space-x-4">
                        {% block navigation %}
                        {% endblock %}
                    </nav>
                    
                    <!-- Mobile menu button -->
                    <button class="md:hidden btn btn-ghost btn-circle"
                            @click="mobileMenuOpen = !mobileMenuOpen"
                            aria-label="Menú">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </header>
        {% endblock %}
        
        <!-- Mobile menu -->
        <div x-show="mobileMenuOpen" 
             x-transition
             @click.away="mobileMenuOpen = false"
             class="md:hidden bg-white dark:bg-gray-800 shadow-lg">
            {% block mobile_navigation %}
            {% endblock %}
        </div>
        
        <!-- Messages de Django -->
        {% if messages %}
        <div class="container mx-auto px-4 py-2">
            {% for message in messages %}
            <div class="alert {% if message.tags == 'error' %}alert-error{% elif message.tags == 'success' %}alert-success{% elif message.tags == 'warning' %}alert-warning{% else %}alert-info{% endif %} shadow-lg mb-2 animate-slide-in"
                 role="alert">
                <i class="fas {% if message.tags == 'error' %}fa-exclamation-circle{% elif message.tags == 'success' %}fa-check-circle{% elif message.tags == 'warning' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %}"></i>
                <span>{{ message }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- Main content -->
        <main class="{% block main_class %}container mx-auto px-4 py-6{% endblock %}">
            {% block content %}{% endblock %}
        </main>
        
        <!-- Footer -->
        {% block footer %}
        <footer class="bg-white dark:bg-gray-800 shadow-lg mt-8">
            <div class="container mx-auto px-4 py-6">
                <div class="text-center text-sm text-gray-600 dark:text-gray-400">
                    <p>&copy; 2026 Cantina Tita - Todos los derechos reservados</p>
                    <p class="mt-1">
                        <i class="fas fa-map-marker-alt"></i> Paraguay | 
                        <i class="fas fa-code"></i> v1.0.0 |
                        <i class="fas fa-utensils"></i> Sistema POS
                    </p>
                </div>
            </div>
        </footer>
        {% endblock %}
    </div>
    
    <!-- Sistema de notificaciones Toast -->
    <div x-data="notifications" class="toast-container">
        <template x-for="item in items" :key="item.id">
            <div class="toast-item alert shadow-lg mb-2 animate-slide-down"
                 :class="{
                     'alert-success': item.type === 'success',
                     'alert-error': item.type === 'error',
                     'alert-warning': item.type === 'warning',
                     'alert-info': item.type === 'info'
                 }"
                 x-show="item.id"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform translate-x-full"
                 x-transition:enter-end="opacity-100 transform translate-x-0"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 transform translate-x-0"
                 x-transition:leave-end="opacity-0 transform translate-x-full">
                
                <div class="flex items-start gap-3 flex-1">
                    <i class="fas text-xl" :class="{
                        'fa-check-circle': item.type === 'success',
                        'fa-exclamation-circle': item.type === 'error',
                        'fa-exclamation-triangle': item.type === 'warning',
                        'fa-info-circle': item.type === 'info'
                    }"></i>
                    <span x-text="item.message" class="flex-1"></span>
                    <button @click="remove(item.id)" 
                            class="btn btn-ghost btn-xs btn-circle"
                            aria-label="Cerrar">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Barra de progreso -->
                <div class="w-full h-1 bg-base-200 rounded-full overflow-hidden mt-2"
                     x-show="item.duration > 0">
                    <div class="h-full bg-current transition-all ease-linear"
                         :style="`width: ${item.progress}%`"></div>
                </div>
            </div>
        </template>
    </div>
    
    <!-- Scripts de Alpine.js Components -->
    <script src="{% static 'js/alpine-components.js' %}"></script>
    
    <!-- Scripts adicionales -->
    {% block extra_scripts %}{% endblock %}
    
    <!-- Script de inicialización global -->
    <script>
        document.addEventListener('alpine:init', () => {
            // Store global de Alpine.js para dark mode
            Alpine.store('darkMode', {
                on: Alpine.$persist(false).as('darkMode'),
                
                toggle() {
                    this.on = !this.on;
                    document.documentElement.classList.toggle('dark', this.on);
                },
                
                init() {
                    // Detectar preferencia del sistema si no hay guardada
                    if (this.on === null || this.on === undefined) {
                        this.on = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    }
                    document.documentElement.classList.toggle('dark', this.on);
                }
            });
            
            // Inicializar dark mode
            Alpine.store('darkMode').init();
            
            // Data global para mobile menu
            Alpine.data('app', () => ({
                mobileMenuOpen: false
            }));
        });
        
        // Soporte para eventos de notificación desde cualquier parte
        document.addEventListener('notify', (event) => {
            const { message, type = 'info', duration = 3000 } = event.detail;
            window.dispatchEvent(new CustomEvent('show-notification', { 
                detail: { message, type, duration } 
            }));
        });
        
        // Keyboard shortcuts globales
        document.addEventListener('keydown', (e) => {
            // ESC - Cerrar modales/menús
            if (e.key === 'Escape') {
                const app = Alpine.$data(document.getElementById('app'));
                if (app) app.mobileMenuOpen = false;
            }
        });
        
        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(registration => {
                        console.log('[PWA] Service Worker registrado:', registration.scope);
                        
                        // Verificar actualizaciones cada hora
                        setInterval(() => {
                            registration.update();
                        }, 60 * 60 * 1000);
                    })
                    .catch(error => {
                        console.error('[PWA] Error al registrar Service Worker:', error);
                    });
                
                // Detectar cuando la app está instalada
                window.addEventListener('appinstalled', () => {
                    console.log('[PWA] App instalada exitosamente');
                    document.dispatchEvent(new CustomEvent('notify', {
                        detail: { 
                            message: '¡App instalada! Ahora puedes usarla offline.', 
                            type: 'success' 
                        }
                    }));
                });
            });
        }
        
        // Detectar estado de conexión
        window.addEventListener('online', () => {
            document.dispatchEvent(new CustomEvent('notify', {
                detail: { message: 'Conexión restaurada', type: 'success' }
            }));
        });
        
        window.addEventListener('offline', () => {
            document.dispatchEvent(new CustomEvent('notify', {
                detail: { message: 'Sin conexión. Modo offline activado.', type: 'warning' }
            }));
        });
    </script>
    
    {% block page_scripts %}{% endblock %}
</body>
</html>