{% extends "base_pos.html" %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block title %}Reportes y Estadísticas - MetrePay{% endblock %}

{% block extra_styles %}
<style>
    .report-card {
        @apply bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-2xl cursor-pointer;
    }
    
    .report-card.active {
        @apply ring-4 ring-primary ring-opacity-50 bg-blue-50;
    }
    
    .stat-box {
        @apply bg-gradient-to-br rounded-lg p-4 text-white shadow-md;
    }
    
    .table-container {
        @apply overflow-x-auto bg-white rounded-xl shadow-lg;
    }
    
    .export-btn {
        @apply btn btn-sm gap-2 transition-all duration-200;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
        animation: fadeIn 0.3s ease-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 space-y-8"
     x-data="reportesData()"
     x-init="init()">
    
    <!-- Header -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent flex items-center gap-3">
                    <i class="fas fa-chart-bar text-blue-600"></i>
                    Reportes y Estadísticas
                </h1>
                <p class="text-gray-600 mt-2">Genera reportes detallados del sistema</p>
            </div>
        </div>
    </div>

    <!-- Selector de Tipo de Reporte -->
    <div class="bg-white rounded-2xl shadow-lg p-4 md:p-6">
        <h2 class="text-xl md:text-2xl font-bold mb-4 md:mb-6 flex items-center gap-2 md:gap-3">
            <i class="fas fa-filter text-purple-600"></i>
            <span class="hidden xs:inline">Selecciona el </span>Tipo de Reporte
        </h2>

        <div class="grid grid-cols-2 xs:grid-cols-3 md:grid-cols-2 lg:grid-cols-5 gap-3 md:gap-4">
            <!-- Reporte de Ventas -->
            <div class="report-card" 
                 :class="{'active': tipoReporte === 'ventas'}"
                 @click="cambiarTipoReporte('ventas')">
                <div class="text-center">
                    <div class="mx-auto w-16 h-16 flex items-center justify-center rounded-full bg-gradient-to-br from-green-400 to-green-600 mb-4">
                        <i class="fas fa-cash-register text-3xl text-white"></i>
                    </div>
                    <h3 class="font-bold text-lg mb-2">Ventas</h3>
                    <p class="text-sm text-gray-600">Reporte detallado de ventas</p>
                </div>
            </div>

            <!-- Reporte de Productos -->
            <div class="report-card"
                 :class="{'active': tipoReporte === 'productos'}"
                 @click="cambiarTipoReporte('productos')">
                <div class="text-center">
                    <div class="mx-auto w-16 h-16 flex items-center justify-center rounded-full bg-gradient-to-br from-orange-400 to-orange-600 mb-4">
                        <i class="fas fa-box text-3xl text-white"></i>
                    </div>
                    <h3 class="font-bold text-lg mb-2">Productos</h3>
                    <p class="text-sm text-gray-600">Productos más vendidos</p>
                </div>
            </div>

            <!-- Reporte de Empleados -->
            <div class="report-card"
                 :class="{'active': tipoReporte === 'empleados'}"
                 @click="cambiarTipoReporte('empleados')">
                <div class="text-center">
                    <div class="mx-auto w-16 h-16 flex items-center justify-center rounded-full bg-gradient-to-br from-blue-400 to-blue-600 mb-4">
                        <i class="fas fa-users text-3xl text-white"></i>
                    </div>
                    <h3 class="font-bold text-lg mb-2">Empleados</h3>
                    <p class="text-sm text-gray-600">Desempeño del equipo</p>
                </div>
            </div>

            <!-- Reporte de Stock -->
            <div class="report-card"
                 :class="{'active': tipoReporte === 'stock'}"
                 @click="cambiarTipoReporte('stock')">
                <div class="text-center">
                    <div class="mx-auto w-16 h-16 flex items-center justify-center rounded-full bg-gradient-to-br from-purple-400 to-purple-600 mb-4">
                        <i class="fas fa-boxes text-3xl text-white"></i>
                    </div>
                    <h3 class="font-bold text-lg mb-2">Stock</h3>
                    <p class="text-sm text-gray-600">Inventario actual</p>
                </div>
            </div>

            <!-- Reporte de Tarjetas -->
            <div class="report-card"
                 :class="{'active': tipoReporte === 'tarjetas'}"
                 @click="cambiarTipoReporte('tarjetas')">
                <div class="text-center">
                    <div class="mx-auto w-16 h-16 flex items-center justify-center rounded-full bg-gradient-to-br from-pink-400 to-pink-600 mb-4">
                        <i class="fas fa-credit-card text-3xl text-white"></i>
                    </div>
                    <h3 class="font-bold text-lg mb-2">Tarjetas</h3>
                    <p class="text-sm text-gray-600">Consumos por tarjeta</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros de Fecha -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
            <i class="fas fa-calendar-alt text-green-600"></i>
            Período del Reporte
        </h2>

        <form method="GET" class="space-y-4">
            <input type="hidden" name="tipo_reporte" :value="tipoReporte">
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Fecha Desde -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">Fecha Desde</span>
                    </label>
                    <input type="date" 
                           name="fecha_desde"
                           :value="fechaDesde"
                           @change="fechaDesde = $event.target.value"
                           class="input input-bordered w-full"
                           required>
                </div>

                <!-- Fecha Hasta -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">Fecha Hasta</span>
                    </label>
                    <input type="date" 
                           name="fecha_hasta"
                           :value="fechaHasta"
                           @change="fechaHasta = $event.target.value"
                           class="input input-bordered w-full"
                           required>
                </div>

                <!-- Botones de Períodos Rápidos -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">Períodos Rápidos</span>
                    </label>
                    <div class="flex gap-2">
                        <button type="button" @click="setPeriodoHoy" class="btn btn-sm btn-outline">Hoy</button>
                        <button type="button" @click="setPeriodoSemana" class="btn btn-sm btn-outline">Semana</button>
                        <button type="button" @click="setPeriodoMes" class="btn btn-sm btn-outline">Mes</button>
                    </div>
                </div>

                <!-- Botón Generar -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">&nbsp;</span>
                    </label>
                    <button type="submit" class="btn btn-primary gap-2 w-full">
                        <i class="fas fa-search"></i>
                        Generar Reporte
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Estadísticas Resumidas -->
    {% if stats %}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 fade-in">
            <div class="stat-box from-green-500 to-green-600">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90 mb-1">Total de Registros</p>
                        <p class="text-4xl font-bold">{{ stats.total|default:0|floatformat:0 }}</p>
                    </div>
                    <i class="fas fa-list text-5xl opacity-20"></i>
                </div>
            </div>

            {% if stats.monto_total %}
                <div class="stat-box from-blue-500 to-blue-600">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90 mb-1">Monto Total</p>
                            <p class="text-4xl font-bold">{{ stats.monto_total|floatformat:0|intcomma }} ₲</p>
                        </div>
                        <i class="fas fa-money-bill-wave text-5xl opacity-20"></i>
                    </div>
                </div>
            {% endif %}

            {% if stats.promedio %}
                <div class="stat-box from-purple-500 to-purple-600">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90 mb-1">Promedio</p>
                            <p class="text-4xl font-bold">{{ stats.promedio|floatformat:0|intcomma }} ₲</p>
                        </div>
                        <i class="fas fa-chart-line text-5xl opacity-20"></i>
                    </div>
                </div>
            {% endif %}
        </div>
    {% endif %}

    <!-- Tabla de Datos -->
    {% if datos %}
        <div class="bg-white rounded-2xl shadow-lg p-4 md:p-6 fade-in">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4 md:mb-6">
                <h2 class="text-xl md:text-2xl font-bold flex items-center gap-2 md:gap-3">
                    <i class="fas fa-table text-orange-600"></i>
                    <span class="hidden sm:inline">{{ titulo_tabla }}</span>
                    <span class="sm:hidden">Resultados</span>
                </h2>
                
                <!-- Botones de Exportación -->
                <div class="flex flex-wrap gap-2">
                    <button @click="exportarPDF" class="export-btn btn-error btn-sm md:btn-md">
                        <i class="fas fa-file-pdf"></i>
                        <span class="hidden sm:inline">PDF</span>
                    </button>
                    <button @click="exportarExcel" class="export-btn btn-success btn-sm md:btn-md">
                        <i class="fas fa-file-excel"></i>
                        <span class="hidden sm:inline">Excel</span>
                    </button>
                    <button @click="exportarCSV" class="export-btn btn-info btn-sm md:btn-md">
                        <i class="fas fa-file-csv"></i>
                        <span class="hidden sm:inline">CSV</span>
                    </button>
                    <button @click="imprimir" class="export-btn btn-outline btn-sm md:btn-md hidden md:inline-flex">
                        <i class="fas fa-print"></i>
                        Imprimir
                    </button>
                </div>
            </div>

            <!-- Búsqueda en Tabla -->
            <div class="mb-4">
                <input type="text" 
                       x-model="busquedaTabla"
                       placeholder="Buscar en la tabla..."
                       class="input input-bordered w-full max-w-md">
            </div>

            <div class="overflow-x-auto">
                <table class="table table-zebra w-full table-mobile-stack">
                    <thead data-mobile="hide">
                        <tr class="bg-base-200">
                            {% for columna in columnas %}
                                <th class="font-bold">{{ columna }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for fila in datos %}
                            <tr class="hover" x-show="filtrarFila({{ forloop.counter0 }})">
                                {% for valor in fila %}
                                    <td data-label="{{ columnas|get_item:forloop.counter0 }}">{{ valor }}</td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Paginación Simple -->
            <div class="flex justify-between items-center mt-6">
                <div class="text-sm text-gray-600">
                    Mostrando {{ datos|length }} registro{{ datos|length|pluralize }}
                </div>
            </div>
        </div>
    {% else %}
        <div class="bg-white rounded-2xl shadow-lg p-8 md:p-16 text-center">
            <i class="fas fa-chart-pie text-6xl md:text-8xl text-gray-300 mb-4 md:mb-6"></i>
            <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-2">No hay datos para mostrar</h3>
            <p class="text-sm md:text-base text-gray-600 mb-4 md:mb-6">Selecciona un tipo de reporte y un período para generar los datos</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block page_scripts %}
<script>
function reportesData() {
    return {
        tipoReporte: '{{ tipo_reporte|default:"ventas" }}',
        fechaDesde: '{{ fecha_desde }}',
        fechaHasta: '{{ fecha_hasta }}',
        busquedaTabla: '',
        datosTabla: {{ datos|safe|default:"[]" }},

        init() {
            console.log('Módulo de reportes cargado');
        },

        cambiarTipoReporte(tipo) {
            this.tipoReporte = tipo;
        },

        setPeriodoHoy() {
            const hoy = new Date().toISOString().split('T')[0];
            this.fechaDesde = hoy;
            this.fechaHasta = hoy;
        },

        setPeriodoSemana() {
            const hoy = new Date();
            const hace7dias = new Date(hoy.getTime() - (7 * 24 * 60 * 60 * 1000));
            this.fechaDesde = hace7dias.toISOString().split('T')[0];
            this.fechaHasta = hoy.toISOString().split('T')[0];
        },

        setPeriodoMes() {
            const hoy = new Date();
            const primerDia = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            this.fechaDesde = primerDia.toISOString().split('T')[0];
            this.fechaHasta = hoy.toISOString().split('T')[0];
        },

        filtrarFila(index) {
            if (!this.busquedaTabla) return true;
            
            const busqueda = this.busquedaTabla.toLowerCase();
            const fila = this.datosTabla[index];
            
            if (!fila) return true;
            
            return fila.some(valor => 
                String(valor).toLowerCase().includes(busqueda)
            );
        },

        async exportarPDF() {
            const url = new URL(window.location.href);
            url.searchParams.set('formato', 'pdf');
            window.open(url.toString(), '_blank');
        },

        async exportarExcel() {
            const url = new URL(window.location.href);
            url.searchParams.set('formato', 'excel');
            window.location.href = url.toString();
        },

        async exportarCSV() {
            const url = new URL(window.location.href);
            url.searchParams.set('formato', 'csv');
            window.location.href = url.toString();
        },

        imprimir() {
            window.print();
        }
    }
}
</script>

<style media="print">
    .no-print {
        display: none !important;
    }
    
    body {
        background: white;
    }
    
    .table {
        font-size: 10pt;
    }
</style>
{% endblock %}
