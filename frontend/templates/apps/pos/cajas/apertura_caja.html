{% extends "base.html" %}
{% load humanize %}

{% block title %}Apertura de Caja{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto" x-data="aperturaApp()">
    <!-- Header -->
    <div class="mb-6">
        <a href="{% url 'pos:cajas_dashboard' %}" class="btn btn-ghost btn-sm mb-2">
            ‚Üê Volver
        </a>
        <h1 class="text-3xl font-bold text-neutral">üîì Apertura de Caja</h1>
        <p class="text-sm text-neutral/70 mt-1">Iniciar turno de caja</p>
    </div>

    <!-- Formulario de Apertura -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title text-2xl mb-4">Datos de Apertura</h2>
            
            <form @submit.prevent="abrirCaja">
                <!-- Seleccionar Caja -->
                <div class="form-control mb-4">
                    <label class="label">
                        <span class="label-text font-bold">Seleccionar Caja *</span>
                    </label>
                    <select 
                        x-model="formData.id_caja" 
                        class="select select-bordered w-full"
                        required
                    >
                        <option value="">-- Seleccione una caja --</option>
                        {% for caja in cajas %}
                        <option value="{{ caja.id_caja }}">{{ caja.descripcion }} - {{ caja.ubicacion }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Monto Inicial -->
                <div class="form-control mb-4">
                    <label class="label">
                        <span class="label-text font-bold">Monto Inicial (Gs.) *</span>
                    </label>
                    <input 
                        type="number" 
                        x-model="formData.monto_inicial"
                        placeholder="Ej: 100000"
                        class="input input-bordered w-full"
                        min="0"
                        step="1000"
                        required
                    >
                    <label class="label">
                        <span class="label-text-alt text-neutral/60">
                            Monto en efectivo con el que inicia la caja
                        </span>
                    </label>
                </div>

                <!-- Fecha y Hora Actual -->
                <div class="alert alert-info mb-4">
                    <div>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current flex-shrink-0 w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <h3 class="font-bold">Fecha y Hora de Apertura</h3>
                            <div class="text-sm" x-text="fechaActual"></div>
                        </div>
                    </div>
                </div>

                <!-- Botones -->
                <div class="flex gap-2 justify-end mt-6">
                    <a href="{% url 'pos:cajas_dashboard' %}" class="btn btn-ghost">
                        Cancelar
                    </a>
                    <button 
                        type="submit" 
                        class="btn btn-primary"
                        :disabled="loading"
                    >
                        <span x-show="!loading">üîì Abrir Caja</span>
                        <span x-show="loading" class="loading loading-spinner"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Alerta de √©xito/error -->
    <div 
        x-show="mensaje.mostrar" 
        x-transition
        class="toast toast-top toast-end"
    >
        <div 
            class="alert"
            :class="mensaje.tipo === 'success' ? 'alert-success' : 'alert-error'"
        >
            <span x-text="mensaje.texto"></span>
        </div>
    </div>
</div>

<script>
function aperturaApp() {
    return {
        formData: {
            id_caja: '',
            monto_inicial: 0
        },
        loading: false,
        mensaje: {
            mostrar: false,
            tipo: '',
            texto: ''
        },
        fechaActual: '',
        
        init() {
            this.actualizarFecha();
            setInterval(() => this.actualizarFecha(), 1000);
        },
        
        actualizarFecha() {
            const ahora = new Date();
            this.fechaActual = ahora.toLocaleString('es-PY', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        },
        
        async abrirCaja() {
            if (!this.formData.id_caja) {
                this.mostrarMensaje('error', 'Debe seleccionar una caja');
                return;
            }
            
            if (this.formData.monto_inicial < 0) {
                this.mostrarMensaje('error', 'El monto inicial no puede ser negativo');
                return;
            }
            
            this.loading = true;
            
            try {
                const response = await fetch('{% url "pos:apertura_caja" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(this.formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.mostrarMensaje('success', data.mensaje);
                    setTimeout(() => {
                        window.location.href = '{% url "pos:cajas_dashboard" %}';
                    }, 1500);
                } else {
                    this.mostrarMensaje('error', data.error || 'Error al abrir caja');
                }
            } catch (error) {
                this.mostrarMensaje('error', 'Error de conexi√≥n');
                console.error(error);
            } finally {
                this.loading = false;
            }
        },
        
        mostrarMensaje(tipo, texto) {
            this.mensaje = { mostrar: true, tipo, texto };
            setTimeout(() => {
                this.mensaje.mostrar = false;
            }, 5000);
        }
    }
}
</script>
{% endblock %}
