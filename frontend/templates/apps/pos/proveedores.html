{% extends 'base.html' %}
{% load static %}

{% block title %}Proveedores | Cantina Tita{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6" x-data="proveedoresApp()">
    
    <!-- Encabezado -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-neutral">üè≠ Gesti√≥n de Proveedores</h1>
            <p class="text-gray-600">Administraci√≥n de proveedores y compras</p>
        </div>
        <button @click="mostrarModalCrear = true" class="btn btn-primary">
            ‚ûï Nuevo Proveedor
        </button>
    </div>
    
    <!-- Filtros -->
    <div class="card bg-white shadow-xl mb-6">
        <div class="card-body">
            <form method="GET" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">Buscar Proveedor</span>
                    </label>
                    <input type="text" name="buscar" class="input input-bordered" 
                           placeholder="Raz√≥n social o RUC..." value="{{ buscar }}">
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">Estado</span>
                    </label>
                    <select name="estado" class="select select-bordered">
                        <option value="">Todos</option>
                        <option value="activo" {% if estado == 'activo' %}selected{% endif %}>Activos</option>
                        <option value="inactivo" {% if estado == 'inactivo' %}selected{% endif %}>Inactivos</option>
                    </select>
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">&nbsp;</span>
                    </label>
                    <button type="submit" class="btn btn-primary w-full">
                        üîç Buscar
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Estad√≠sticas -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div class="card bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow-lg">
            <div class="card-body">
                <h3 class="card-title text-white opacity-90">Total Proveedores</h3>
                <p class="text-4xl font-bold">{{ stats.total_proveedores }}</p>
            </div>
        </div>
        
        <div class="card bg-gradient-to-br from-green-500 to-green-600 text-white shadow-lg">
            <div class="card-body">
                <h3 class="card-title text-white opacity-90">Proveedores Activos</h3>
                <p class="text-4xl font-bold">{{ stats.proveedores_activos }}</p>
            </div>
        </div>
    </div>
    
    <!-- Tabla de proveedores -->
    <div class="card bg-white shadow-xl">
        <div class="card-body">
            <h2 class="card-title mb-4">Listado de Proveedores</h2>
            
            <div class="overflow-x-auto">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr>
                            <th>RUC</th>
                            <th>Raz√≥n Social</th>
                            <th>Tel√©fono</th>
                            <th>Email</th>
                            <th>Ciudad</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for proveedor in proveedores %}
                        <tr>
                            <td>
                                <span class="font-mono text-sm">{{ proveedor.ruc }}</span>
                            </td>
                            <td>
                                <div class="font-bold">{{ proveedor.razon_social }}</div>
                                {% if proveedor.direccion %}
                                <div class="text-sm text-gray-500">{{ proveedor.direccion }}</div>
                                {% endif %}
                            </td>
                            <td>{{ proveedor.telefono|default:"‚Äî" }}</td>
                            <td>{{ proveedor.email|default:"‚Äî" }}</td>
                            <td>{{ proveedor.ciudad|default:"‚Äî" }}</td>
                            <td>
                                {% if proveedor.activo %}
                                    <span class="badge badge-success">Activo</span>
                                {% else %}
                                    <span class="badge badge-error">Inactivo</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="flex gap-1">
                                    <a href="{% url 'pos:proveedor_detalle' proveedor.id_proveedor %}" 
                                       class="btn btn-sm btn-primary" title="Ver detalle">
                                        üëÅÔ∏è
                                    </a>
                                    <button @click="editarProveedor({{ proveedor.id_proveedor }}, '{{ proveedor.razon_social }}', '{{ proveedor.telefono }}', '{{ proveedor.email }}', '{{ proveedor.direccion }}', '{{ proveedor.ciudad }}', {{ proveedor.activo|lower }})" 
                                            class="btn btn-sm btn-warning" title="Editar">
                                        ‚úèÔ∏è
                                    </button>
                                    {% if proveedor.activo %}
                                    <button @click="eliminarProveedor({{ proveedor.id_proveedor }}, '{{ proveedor.razon_social }}')" 
                                            class="btn btn-sm btn-error" title="Desactivar">
                                        üóëÔ∏è
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-gray-500 py-8">
                                No se encontraron proveedores
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Crear Proveedor -->
    <div x-show="mostrarModalCrear" 
         class="modal modal-open" 
         @click.self="mostrarModalCrear = false">
        <div class="modal-box w-11/12 max-w-2xl">
            <h3 class="font-bold text-lg mb-4">‚ûï Nuevo Proveedor</h3>
            
            <form @submit.prevent="crearProveedor()">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">RUC *</span>
                        </label>
                        <input type="text" x-model="nuevoProveedor.ruc" 
                               class="input input-bordered" required>
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Raz√≥n Social *</span>
                        </label>
                        <input type="text" x-model="nuevoProveedor.razon_social" 
                               class="input input-bordered" required>
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Tel√©fono</span>
                        </label>
                        <input type="text" x-model="nuevoProveedor.telefono" 
                               class="input input-bordered">
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Email</span>
                        </label>
                        <input type="email" x-model="nuevoProveedor.email" 
                               class="input input-bordered">
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Direcci√≥n</span>
                        </label>
                        <input type="text" x-model="nuevoProveedor.direccion" 
                               class="input input-bordered">
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Ciudad</span>
                        </label>
                        <input type="text" x-model="nuevoProveedor.ciudad" 
                               class="input input-bordered">
                    </div>
                </div>
                
                <div class="modal-action">
                    <button type="button" @click="mostrarModalCrear = false" 
                            class="btn btn-ghost">Cancelar</button>
                    <button type="submit" class="btn btn-primary" 
                            :disabled="procesando">
                        <span x-show="!procesando">Guardar</span>
                        <span x-show="procesando" class="loading loading-spinner"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Editar Proveedor -->
    <div x-show="mostrarModalEditar" 
         class="modal modal-open" 
         @click.self="mostrarModalEditar = false">
        <div class="modal-box w-11/12 max-w-2xl">
            <h3 class="font-bold text-lg mb-4">‚úèÔ∏è Editar Proveedor</h3>
            
            <form @submit.prevent="actualizarProveedor()">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Raz√≥n Social *</span>
                        </label>
                        <input type="text" x-model="proveedorEditar.razon_social" 
                               class="input input-bordered" required>
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Tel√©fono</span>
                        </label>
                        <input type="text" x-model="proveedorEditar.telefono" 
                               class="input input-bordered">
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Email</span>
                        </label>
                        <input type="email" x-model="proveedorEditar.email" 
                               class="input input-bordered">
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Direcci√≥n</span>
                        </label>
                        <input type="text" x-model="proveedorEditar.direccion" 
                               class="input input-bordered">
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Ciudad</span>
                        </label>
                        <input type="text" x-model="proveedorEditar.ciudad" 
                               class="input input-bordered">
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Estado</span>
                        </label>
                        <select x-model="proveedorEditar.activo" class="select select-bordered">
                            <option :value="true">Activo</option>
                            <option :value="false">Inactivo</option>
                        </select>
                    </div>
                </div>
                
                <div class="modal-action">
                    <button type="button" @click="mostrarModalEditar = false" 
                            class="btn btn-ghost">Cancelar</button>
                    <button type="submit" class="btn btn-primary" 
                            :disabled="procesando">
                        <span x-show="!procesando">Actualizar</span>
                        <span x-show="procesando" class="loading loading-spinner"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
</div>

<!-- Notificaciones -->
<div id="notification-container" 
     class="toast toast-top toast-end"
     style="z-index: 9999;">
</div>

<script>
function proveedoresApp() {
    return {
        mostrarModalCrear: false,
        mostrarModalEditar: false,
        procesando: false,
        nuevoProveedor: {
            ruc: '',
            razon_social: '',
            telefono: '',
            email: '',
            direccion: '',
            ciudad: ''
        },
        proveedorEditar: {
            id: null,
            razon_social: '',
            telefono: '',
            email: '',
            direccion: '',
            ciudad: '',
            activo: true
        },

        async crearProveedor() {
            this.procesando = true;

            try {
                const response = await fetch('{% url "pos:proveedor_crear" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(this.nuevoProveedor)
                });

                const data = await response.json();

                if (data.success) {
                    this.showNotification(data.mensaje, 'success');
                    this.mostrarModalCrear = false;
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    this.showNotification(data.error, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                this.showNotification('Error de conexi√≥n', 'error');
            } finally {
                this.procesando = false;
            }
        },

        editarProveedor(id, razon_social, telefono, email, direccion, ciudad, activo) {
            this.proveedorEditar = {
                id: id,
                razon_social: razon_social,
                telefono: telefono || '',
                email: email || '',
                direccion: direccion || '',
                ciudad: ciudad || '',
                activo: activo
            };
            this.mostrarModalEditar = true;
        },

        async actualizarProveedor() {
            this.procesando = true;

            try {
                const response = await fetch(`/pos/proveedores/editar/${this.proveedorEditar.id}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(this.proveedorEditar)
                });

                const data = await response.json();

                if (data.success) {
                    this.showNotification(data.mensaje, 'success');
                    this.mostrarModalEditar = false;
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    this.showNotification(data.error, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                this.showNotification('Error de conexi√≥n', 'error');
            } finally {
                this.procesando = false;
            }
        },

        async eliminarProveedor(id, nombre) {
            if (!confirm(`¬øDesactivar proveedor ${nombre}?`)) {
                return;
            }

            try {
                const response = await fetch(`/pos/proveedores/eliminar/${id}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    this.showNotification(data.mensaje, 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    this.showNotification(data.error, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                this.showNotification('Error de conexi√≥n', 'error');
            }
        },

        showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const alertClass = type === 'success' ? 'alert-success' : 
                             type === 'error' ? 'alert-error' : 
                             type === 'warning' ? 'alert-warning' : 'alert-info';
            
            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} shadow-lg mb-2`;
            notification.innerHTML = `<span>${message}</span>`;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
    }
}
</script>

{% endblock %}
