{% extends 'pos/pos_bootstrap.html' %}
{% load static %}

{% block title %}Reporte de Autorizaciones de Saldo Negativo{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
    }
    
    .stats-card .card-body {
        color: white;
    }
    
    .stats-card.danger {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .stats-card.success {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .stats-card.warning {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    .stats-card.info {
        background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
    }
    
    .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .chart-container {
        position: relative;
        height: 400px;
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .filter-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .table-container {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .badge-regularizado {
        background-color: #28a745;
    }
    
    .badge-pendiente {
        background-color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-chart-line"></i> Reporte de Autorizaciones de Saldo Negativo</h2>
            <p class="text-muted">Análisis detallado de autorizaciones de crédito</p>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="filter-card">
        <form method="GET" id="filtrosForm" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Fecha Desde</label>
                <input type="date" name="fecha_desde" class="form-control" 
                       value="{{ filtros.fecha_desde|default:'' }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Fecha Hasta</label>
                <input type="date" name="fecha_hasta" class="form-control" 
                       value="{{ filtros.fecha_hasta|default:'' }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Estado</label>
                <select name="regularizado" class="form-select">
                    <option value="">Todos</option>
                    <option value="0" {% if filtros.regularizado == '0' %}selected{% endif %}>Pendientes</option>
                    <option value="1" {% if filtros.regularizado == '1' %}selected{% endif %}>Regularizados</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Supervisor</label>
                <select name="supervisor" class="form-select">
                    <option value="">Todos</option>
                    {% for supervisor in supervisores %}
                    <option value="{{ supervisor.id }}" 
                            {% if filtros.supervisor == supervisor.id|stringformat:"s" %}selected{% endif %}>
                        {{ supervisor.nombre }} {{ supervisor.apellido }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter"></i> Aplicar Filtros
                </button>
                <a href="{% url 'pos_reportes_autorizaciones_saldo' %}" class="btn btn-secondary">
                    <i class="fas fa-redo"></i> Limpiar
                </a>
                <button type="button" class="btn btn-success" onclick="exportarExcel()">
                    <i class="fas fa-file-excel"></i> Exportar Excel
                </button>
            </div>
        </form>
    </div>
    
    <!-- Estadísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <i class="fas fa-list-check fa-2x mb-2"></i>
                    <div class="stat-value">{{ stats.total_autorizaciones }}</div>
                    <div class="stat-label">Total Autorizaciones</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card danger">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <div class="stat-value">{{ stats.pendientes }}</div>
                    <div class="stat-label">Pendientes de Pago</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card success">
                <div class="card-body text-center">
                    <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
                    <div class="stat-value">Gs. {{ stats.monto_total_deuda|floatformat:0 }}</div>
                    <div class="stat-label">Deuda Total Pendiente</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card warning">
                <div class="card-body text-center">
                    <i class="fas fa-calculator fa-2x mb-2"></i>
                    <div class="stat-value">Gs. {{ stats.promedio_deuda|floatformat:0 }}</div>
                    <div class="stat-label">Promedio por Autorización</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stats-card info">
                <div class="card-body text-center">
                    <i class="fas fa-hourglass-half fa-2x mb-2"></i>
                    <div class="stat-value">{{ stats.promedio_dias_regularizacion|floatformat:1 }}</div>
                    <div class="stat-label">Días Promedio Regularización</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                <div class="card-body text-center">
                    <i class="fas fa-percentage fa-2x mb-2"></i>
                    <div class="stat-value">{{ stats.tasa_regularizacion|floatformat:1 }}%</div>
                    <div class="stat-label">Tasa de Regularización</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                <div class="card-body text-center">
                    <i class="fas fa-money-bill-transfer fa-2x mb-2"></i>
                    <div class="stat-value">Gs. {{ stats.monto_total_regularizado|floatformat:0 }}</div>
                    <div class="stat-label">Total Regularizado</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);">
                <div class="card-body text-center">
                    <i class="fas fa-chart-pie fa-2x mb-2"></i>
                    <div class="stat-value">{{ stats.autorizaciones_hoy }}</div>
                    <div class="stat-label">Autorizaciones Hoy</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Gráficos -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="chart-container">
                <h5 class="mb-3"><i class="fas fa-chart-bar"></i> Top 10 Supervisores</h5>
                <canvas id="chartSupervisores"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <h5 class="mb-3"><i class="fas fa-chart-pie"></i> Autorizaciones por Estado</h5>
                <canvas id="chartEstados"></canvas>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="chart-container">
                <h5 class="mb-3"><i class="fas fa-chart-line"></i> Tendencia de Autorizaciones (Últimos 30 días)</h5>
                <canvas id="chartTendencia"></canvas>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="chart-container">
                <h5 class="mb-3"><i class="fas fa-users"></i> Top 10 Estudiantes</h5>
                <canvas id="chartEstudiantes"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-container">
                <h5 class="mb-3"><i class="fas fa-clock"></i> Tiempo de Regularización</h5>
                <canvas id="chartTiempoRegularizacion"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Tabla de Detalles -->
    <div class="table-container">
        <h5 class="mb-3"><i class="fas fa-table"></i> Detalle de Autorizaciones</h5>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>Fecha</th>
                        <th>Tarjeta</th>
                        <th>Estudiante</th>
                        <th>Venta</th>
                        <th>Monto</th>
                        <th>Supervisor</th>
                        <th>Motivo</th>
                        <th>Estado</th>
                        <th>Días Deuda</th>
                    </tr>
                </thead>
                <tbody>
                    {% for auth in autorizaciones %}
                    <tr>
                        <td>{{ auth.id }}</td>
                        <td>{{ auth.fecha_autorizacion|date:"d/m/Y H:i" }}</td>
                        <td><strong>{{ auth.nro_tarjeta }}</strong></td>
                        <td>{{ auth.estudiante_nombre }}</td>
                        <td>
                            <a href="{% url 'detalle_venta' auth.id_venta.id_venta %}" 
                               class="btn btn-sm btn-outline-primary" target="_blank">
                                #{{ auth.id_venta.id_venta }}
                            </a>
                        </td>
                        <td class="text-end"><strong>Gs. {{ auth.monto_autorizado|floatformat:0 }}</strong></td>
                        <td>{{ auth.id_empleado_autoriza.nombre }} {{ auth.id_empleado_autoriza.apellido }}</td>
                        <td>
                            <small>{{ auth.motivo_autorizacion|truncatechars:50 }}</small>
                        </td>
                        <td>
                            {% if auth.regularizado %}
                            <span class="badge badge-regularizado">
                                <i class="fas fa-check-circle"></i> Regularizado
                            </span>
                            <br><small class="text-muted">{{ auth.fecha_regularizacion|date:"d/m/Y" }}</small>
                            {% else %}
                            <span class="badge badge-pendiente">
                                <i class="fas fa-exclamation-triangle"></i> Pendiente
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if not auth.regularizado %}
                            <span class="badge bg-warning text-dark">
                                {{ auth.dias_deuda }} días
                            </span>
                            {% else %}
                            <span class="text-success">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="10" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p>No se encontraron autorizaciones con los filtros aplicados</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Paginación -->
        {% if autorizaciones.has_other_pages %}
        <nav aria-label="Paginación">
            <ul class="pagination justify-content-center">
                {% if autorizaciones.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1{{ filtros_query }}">Primera</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ autorizaciones.previous_page_number }}{{ filtros_query }}">Anterior</a>
                </li>
                {% endif %}
                
                <li class="page-item active">
                    <span class="page-link">
                        Página {{ autorizaciones.number }} de {{ autorizaciones.paginator.num_pages }}
                    </span>
                </li>
                
                {% if autorizaciones.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ autorizaciones.next_page_number }}{{ filtros_query }}">Siguiente</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ autorizaciones.paginator.num_pages }}{{ filtros_query }}">Última</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
// Configuración global de Chart.js
Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
Chart.defaults.font.size = 12;

// Datos desde Django
const chartData = {{ chart_data|safe }};

// Gráfico de Supervisores
const ctxSupervisores = document.getElementById('chartSupervisores').getContext('2d');
new Chart(ctxSupervisores, {
    type: 'bar',
    data: {
        labels: chartData.top_supervisores.labels,
        datasets: [{
            label: 'Autorizaciones',
            data: chartData.top_supervisores.data,
            backgroundColor: 'rgba(102, 126, 234, 0.8)',
            borderColor: 'rgba(102, 126, 234, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    precision: 0
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// Gráfico de Estados
const ctxEstados = document.getElementById('chartEstados').getContext('2d');
new Chart(ctxEstados, {
    type: 'doughnut',
    data: {
        labels: ['Regularizados', 'Pendientes'],
        datasets: [{
            data: [chartData.estados.regularizados, chartData.estados.pendientes],
            backgroundColor: [
                'rgba(40, 167, 69, 0.8)',
                'rgba(220, 53, 69, 0.8)'
            ],
            borderColor: [
                'rgba(40, 167, 69, 1)',
                'rgba(220, 53, 69, 1)'
            ],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Gráfico de Tendencia
const ctxTendencia = document.getElementById('chartTendencia').getContext('2d');
new Chart(ctxTendencia, {
    type: 'line',
    data: {
        labels: chartData.tendencia.labels,
        datasets: [{
            label: 'Autorizaciones por Día',
            data: chartData.tendencia.data,
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    precision: 0
                }
            }
        }
    }
});

// Gráfico de Estudiantes
const ctxEstudiantes = document.getElementById('chartEstudiantes').getContext('2d');
new Chart(ctxEstudiantes, {
    type: 'bar',
    data: {
        labels: chartData.top_estudiantes.labels,
        datasets: [{
            label: 'Autorizaciones',
            data: chartData.top_estudiantes.data,
            backgroundColor: 'rgba(255, 159, 64, 0.8)',
            borderColor: 'rgba(255, 159, 64, 1)',
            borderWidth: 1
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: {
                beginAtZero: true,
                ticks: {
                    precision: 0
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// Gráfico de Tiempo de Regularización
const ctxTiempo = document.getElementById('chartTiempoRegularizacion').getContext('2d');
new Chart(ctxTiempo, {
    type: 'bar',
    data: {
        labels: ['0-3 días', '4-7 días', '8-15 días', '16-30 días', '30+ días'],
        datasets: [{
            label: 'Cantidad',
            data: chartData.tiempo_regularizacion,
            backgroundColor: [
                'rgba(40, 167, 69, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(255, 99, 132, 0.8)',
                'rgba(153, 102, 255, 0.8)'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    precision: 0
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// Exportar a Excel
function exportarExcel() {
    const params = new URLSearchParams(window.location.search);
    params.set('export', 'excel');
    window.location.href = '{% url "pos_reportes_autorizaciones_saldo" %}?' + params.toString();
}
</script>
{% endblock %}
