{% extends "base_gestion.html" %}
{% load static %}

{% block title %}Cambiar Contraseña - Gestión{% endblock %}

{% block content %}
<div x-data="cambiarPassword()" class="container mx-auto px-4 py-8 max-w-2xl">
    
    <!-- Header -->
    <div class="mb-8">
        <a href="{% url 'gestion:dashboard' %}" class="btn btn-ghost mb-4">
            <i class="fas fa-arrow-left mr-2"></i>
            Volver
        </a>
        
        <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">
            <i class="fas fa-key mr-3 text-secondary"></i>
            Cambiar Contraseña
        </h1>
        <p class="text-gray-600 dark:text-gray-400 mt-1">
            Actualiza tu contraseña de acceso al sistema
        </p>
    </div>
    
    <!-- Card Principal -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8">
        
        <!-- Información de Seguridad -->
        <div class="alert alert-info mb-6">
            <i class="fas fa-info-circle"></i>
            <div>
                <h3 class="font-bold">Recomendaciones de seguridad</h3>
                <ul class="text-sm mt-2 space-y-1 list-disc list-inside">
                    <li>Usa al menos 8 caracteres</li>
                    <li>Combina letras mayúsculas y minúsculas</li>
                    <li>Incluye números y símbolos especiales</li>
                    <li>No uses información personal obvia</li>
                    <li>Cambia tu contraseña periódicamente</li>
                </ul>
            </div>
        </div>
        
        <!-- Mensajes de Alerta -->
        <template x-if="mensaje.texto">
            <div class="alert mb-6" 
                 :class="{
                     'alert-success': mensaje.tipo === 'success',
                     'alert-error': mensaje.tipo === 'error',
                     'alert-warning': mensaje.tipo === 'warning'
                 }">
                <i class="fas" 
                   :class="{
                       'fa-check-circle': mensaje.tipo === 'success',
                       'fa-exclamation-circle': mensaje.tipo === 'error',
                       'fa-exclamation-triangle': mensaje.tipo === 'warning'
                   }"></i>
                <span x-text="mensaje.texto"></span>
            </div>
        </template>
        
        <!-- Formulario -->
        <form @submit.prevent="cambiar()">
            
            <!-- Contraseña Actual -->
            <div class="form-control mb-6">
                <label class="label">
                    <span class="label-text font-semibold">
                        <i class="fas fa-lock mr-2 text-gray-500"></i>
                        Contraseña Actual *
                    </span>
                </label>
                <div class="relative">
                    <input :type="mostrar.actual ? 'text' : 'password'" 
                           x-model="form.password_actual" 
                           placeholder="Ingresa tu contraseña actual"
                           class="input input-bordered w-full pr-12"
                           :class="{'input-error': errores.password_actual}"
                           required
                           autocomplete="current-password">
                    <button type="button" 
                            @click="mostrar.actual = !mostrar.actual"
                            class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700">
                        <i class="fas" :class="mostrar.actual ? 'fa-eye-slash' : 'fa-eye'"></i>
                    </button>
                </div>
                <template x-if="errores.password_actual">
                    <label class="label">
                        <span class="label-text-alt text-error" x-text="errores.password_actual"></span>
                    </label>
                </template>
            </div>
            
            <div class="divider my-6">Nueva Contraseña</div>
            
            <!-- Nueva Contraseña -->
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text font-semibold">
                        <i class="fas fa-shield-alt mr-2 text-gray-500"></i>
                        Nueva Contraseña *
                    </span>
                </label>
                <div class="relative">
                    <input :type="mostrar.nueva ? 'text' : 'password'" 
                           x-model="form.password_nueva" 
                           @input="validarFortaleza()"
                           placeholder="Mínimo 8 caracteres"
                           class="input input-bordered w-full pr-12"
                           :class="{'input-error': errores.password_nueva}"
                           required
                           minlength="8"
                           autocomplete="new-password">
                    <button type="button" 
                            @click="mostrar.nueva = !mostrar.nueva"
                            class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700">
                        <i class="fas" :class="mostrar.nueva ? 'fa-eye-slash' : 'fa-eye'"></i>
                    </button>
                </div>
                <template x-if="errores.password_nueva">
                    <label class="label">
                        <span class="label-text-alt text-error" x-text="errores.password_nueva"></span>
                    </label>
                </template>
                
                <!-- Indicador de Fortaleza -->
                <template x-if="form.password_nueva">
                    <div class="mt-3">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-sm text-gray-600">Fortaleza:</span>
                            <span class="font-semibold text-sm"
                                  :class="{
                                      'text-error': fortaleza.nivel === 'Débil',
                                      'text-warning': fortaleza.nivel === 'Media',
                                      'text-success': fortaleza.nivel === 'Fuerte'
                                  }"
                                  x-text="fortaleza.nivel"></span>
                        </div>
                        <progress class="progress w-full" 
                                  :class="{
                                      'progress-error': fortaleza.nivel === 'Débil',
                                      'progress-warning': fortaleza.nivel === 'Media',
                                      'progress-success': fortaleza.nivel === 'Fuerte'
                                  }"
                                  :value="fortaleza.porcentaje" 
                                  max="100"></progress>
                        
                        <!-- Requisitos -->
                        <div class="mt-3 space-y-1 text-sm">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-check text-xs" 
                                   :class="requisitos.longitud ? 'text-success' : 'text-gray-300'"></i>
                                <span :class="requisitos.longitud ? 'text-gray-700' : 'text-gray-400'">
                                    Al menos 8 caracteres
                                </span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-check text-xs" 
                                   :class="requisitos.mayuscula ? 'text-success' : 'text-gray-300'"></i>
                                <span :class="requisitos.mayuscula ? 'text-gray-700' : 'text-gray-400'">
                                    Una letra mayúscula
                                </span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-check text-xs" 
                                   :class="requisitos.minuscula ? 'text-success' : 'text-gray-300'"></i>
                                <span :class="requisitos.minuscula ? 'text-gray-700' : 'text-gray-400'">
                                    Una letra minúscula
                                </span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-check text-xs" 
                                   :class="requisitos.numero ? 'text-success' : 'text-gray-300'"></i>
                                <span :class="requisitos.numero ? 'text-gray-700' : 'text-gray-400'">
                                    Un número
                                </span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-check text-xs" 
                                   :class="requisitos.especial ? 'text-success' : 'text-gray-300'"></i>
                                <span :class="requisitos.especial ? 'text-gray-700' : 'text-gray-400'">
                                    Un carácter especial (@$!%*?&)
                                </span>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            
            <!-- Confirmar Nueva Contraseña -->
            <div class="form-control mb-6">
                <label class="label">
                    <span class="label-text font-semibold">
                        <i class="fas fa-check-circle mr-2 text-gray-500"></i>
                        Confirmar Nueva Contraseña *
                    </span>
                </label>
                <div class="relative">
                    <input :type="mostrar.confirmar ? 'text' : 'password'" 
                           x-model="form.password_confirmar" 
                           placeholder="Repite la nueva contraseña"
                           class="input input-bordered w-full pr-12"
                           :class="{'input-error': errores.password_confirmar}"
                           required
                           autocomplete="new-password">
                    <button type="button" 
                            @click="mostrar.confirmar = !mostrar.confirmar"
                            class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700">
                        <i class="fas" :class="mostrar.confirmar ? 'fa-eye-slash' : 'fa-eye'"></i>
                    </button>
                </div>
                <template x-if="errores.password_confirmar">
                    <label class="label">
                        <span class="label-text-alt text-error" x-text="errores.password_confirmar"></span>
                    </label>
                </template>
                
                <!-- Indicador de coincidencia -->
                <template x-if="form.password_confirmar && form.password_nueva">
                    <label class="label">
                        <span class="label-text-alt"
                              :class="form.password_nueva === form.password_confirmar ? 'text-success' : 'text-error'">
                            <i class="fas" 
                               :class="form.password_nueva === form.password_confirmar ? 'fa-check-circle' : 'fa-times-circle'"></i>
                            <span x-text="form.password_nueva === form.password_confirmar ? 'Las contraseñas coinciden' : 'Las contraseñas no coinciden'"></span>
                        </span>
                    </label>
                </template>
            </div>
            
            <!-- Botones -->
            <div class="flex gap-4">
                <button type="button" 
                        @click="window.history.back()"
                        class="btn btn-ghost flex-1">
                    <i class="fas fa-times mr-2"></i>
                    Cancelar
                </button>
                <button type="submit" 
                        class="btn btn-secondary text-white flex-1"
                        :class="{'loading': guardando}"
                        :disabled="guardando || !formularioValido()">
                    <template x-if="!guardando">
                        <i class="fas fa-save mr-2"></i>
                    </template>
                    <span x-text="guardando ? 'Cambiando...' : 'Cambiar Contraseña'"></span>
                </button>
            </div>
        </form>
        
        <!-- Información adicional -->
        <div class="mt-6 p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
            <div class="flex gap-3">
                <i class="fas fa-exclamation-triangle text-warning text-lg mt-1"></i>
                <div class="text-sm">
                    <p class="font-semibold text-gray-800 dark:text-gray-200">¿Olvidaste tu contraseña actual?</p>
                    <p class="text-gray-600 dark:text-gray-400 mt-1">
                        Contacta con un administrador para que pueda restablecerla por ti.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
function cambiarPassword() {
    return {
        form: {
            password_actual: '',
            password_nueva: '',
            password_confirmar: ''
        },
        errores: {},
        mensaje: {
            texto: '',
            tipo: ''
        },
        mostrar: {
            actual: false,
            nueva: false,
            confirmar: false
        },
        requisitos: {
            longitud: false,
            mayuscula: false,
            minuscula: false,
            numero: false,
            especial: false
        },
        fortaleza: {
            nivel: '',
            porcentaje: 0
        },
        guardando: false,
        
        validarFortaleza() {
            const password = this.form.password_nueva;
            
            // Validar requisitos
            this.requisitos.longitud = password.length >= 8;
            this.requisitos.mayuscula = /[A-Z]/.test(password);
            this.requisitos.minuscula = /[a-z]/.test(password);
            this.requisitos.numero = /[0-9]/.test(password);
            this.requisitos.especial = /[@$!%*?&]/.test(password);
            
            // Calcular fortaleza
            let puntos = 0;
            if (this.requisitos.longitud) puntos += 20;
            if (this.requisitos.mayuscula) puntos += 20;
            if (this.requisitos.minuscula) puntos += 20;
            if (this.requisitos.numero) puntos += 20;
            if (this.requisitos.especial) puntos += 20;
            
            this.fortaleza.porcentaje = puntos;
            
            if (puntos <= 40) {
                this.fortaleza.nivel = 'Débil';
            } else if (puntos <= 80) {
                this.fortaleza.nivel = 'Media';
            } else {
                this.fortaleza.nivel = 'Fuerte';
            }
        },
        
        formularioValido() {
            return this.form.password_actual && 
                   this.form.password_nueva && 
                   this.form.password_confirmar &&
                   this.form.password_nueva === this.form.password_confirmar &&
                   this.form.password_nueva.length >= 8;
        },
        
        async cambiar() {
            // Limpiar errores previos
            this.errores = {};
            this.mensaje = { texto: '', tipo: '' };
            
            // Validaciones
            if (!this.form.password_actual) {
                this.errores.password_actual = 'La contraseña actual es requerida';
                return;
            }
            
            if (!this.form.password_nueva) {
                this.errores.password_nueva = 'La nueva contraseña es requerida';
                return;
            }
            
            if (this.form.password_nueva.length < 8) {
                this.errores.password_nueva = 'La contraseña debe tener al menos 8 caracteres';
                return;
            }
            
            if (this.form.password_nueva !== this.form.password_confirmar) {
                this.errores.password_confirmar = 'Las contraseñas no coinciden';
                return;
            }
            
            if (this.form.password_actual === this.form.password_nueva) {
                this.errores.password_nueva = 'La nueva contraseña debe ser diferente a la actual';
                return;
            }
            
            this.guardando = true;
            
            try {
                const response = await fetch('{% url "gestion:cambiar_password" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCookie('csrftoken')
                    },
                    body: JSON.stringify(this.form)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.mensaje = {
                        texto: '¡Contraseña cambiada exitosamente! Serás redirigido...',
                        tipo: 'success'
                    };
                    
                    // Limpiar formulario
                    this.form = {
                        password_actual: '',
                        password_nueva: '',
                        password_confirmar: ''
                    };
                    
                    // Redirigir al dashboard
                    setTimeout(() => {
                        window.location.href = '{% url "gestion:dashboard" %}';
                    }, 2000);
                } else {
                    this.mensaje = {
                        texto: data.message || 'Error al cambiar la contraseña',
                        tipo: 'error'
                    };
                    
                    if (data.errors) {
                        this.errores = data.errors;
                    }
                }
            } catch (error) {
                console.error('Error al cambiar contraseña:', error);
                this.mensaje = {
                    texto: 'Error al conectar con el servidor. Intenta nuevamente.',
                    tipo: 'error'
                };
            } finally {
                this.guardando = false;
            }
        },
        
        getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    }
}
</script>
{% endblock %}
