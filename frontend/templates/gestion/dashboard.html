{% extends "base_gestion.html" %}
{% load static %}

{% block title %}Dashboard - Gestión{% endblock %}

{% block content %}
<div x-data="dashboardGestion()" x-init="init()" class="space-y-6">
    
    <!-- Header -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">
                    <i class="fas fa-chart-line mr-3 text-secondary"></i>Dashboard Administrativo
                </h1>
                <p class="text-gray-600 dark:text-gray-400 mt-1" x-text="fechaActual"></p>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-600 dark:text-gray-400">Administrador</p>
                <p class="font-semibold text-lg">{{ user.get_full_name|default:user.username }}</p>
            </div>
        </div>
    </div>
    
    <!-- Cards de Estadísticas Principales -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        
        <!-- Ventas Hoy -->
        <div class="stat-card bg-gradient-to-br from-success to-green-600 text-white">
            <template x-if="cargando">
                <div class="skeleton h-24 w-full bg-white bg-opacity-20"></div>
            </template>
            <template x-if="!cargando">
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-sm opacity-90">Ventas Hoy</p>
                        <i class="fas fa-cash-register text-2xl opacity-80"></i>
                    </div>
                    <p class="text-3xl font-bold mb-1" x-text="stats.ventas_hoy"></p>
                    <p class="text-sm opacity-80" x-text="formatearPrecio(stats.monto_ventas_hoy)"></p>
                </div>
            </template>
        </div>
        
        <!-- Productos Activos -->
        <div class="stat-card bg-gradient-to-br from-primary to-orange-600 text-white">
            <template x-if="cargando">
                <div class="skeleton h-24 w-full bg-white bg-opacity-20"></div>
            </template>
            <template x-if="!cargando">
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-sm opacity-90">Productos Activos</p>
                        <i class="fas fa-box text-2xl opacity-80"></i>
                    </div>
                    <p class="text-3xl font-bold mb-1" x-text="stats.productos_activos"></p>
                    <p class="text-sm opacity-80">
                        <span x-text="stats.productos_stock_bajo"></span> con stock bajo
                    </p>
                </div>
            </template>
        </div>
        
        <!-- Clientes/Estudiantes -->
        <div class="stat-card bg-gradient-to-br from-secondary to-teal-600 text-white">
            <template x-if="cargando">
                <div class="skeleton h-24 w-full bg-white bg-opacity-20"></div>
            </template>
            <template x-if="!cargando">
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-sm opacity-90">Estudiantes</p>
                        <i class="fas fa-users text-2xl opacity-80"></i>
                    </div>
                    <p class="text-3xl font-bold mb-1" x-text="stats.total_estudiantes"></p>
                    <p class="text-sm opacity-80">
                        <span x-text="stats.tarjetas_activas"></span> tarjetas activas
                    </p>
                </div>
            </template>
        </div>
        
        <!-- Recargas Hoy -->
        <div class="stat-card bg-gradient-to-br from-purple-500 to-pink-600 text-white">
            <template x-if="cargando">
                <div class="skeleton h-24 w-full bg-white bg-opacity-20"></div>
            </template>
            <template x-if="!cargando">
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-sm opacity-90">Recargas Hoy</p>
                        <i class="fas fa-credit-card text-2xl opacity-80"></i>
                    </div>
                    <p class="text-3xl font-bold mb-1" x-text="stats.recargas_hoy"></p>
                    <p class="text-sm opacity-80" x-text="formatearPrecio(stats.monto_recargas_hoy)"></p>
                </div>
            </template>
        </div>
    </div>
    
    <!-- Gráficos y Tablas -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- Ventas de la Semana -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">
                <i class="fas fa-chart-bar mr-2 text-secondary"></i>
                Ventas de la Semana
            </h2>
            
            <template x-if="cargando">
                <div class="skeleton h-64 w-full"></div>
            </template>
            
            <template x-if="!cargando">
                <div class="space-y-3">
                    <template x-for="(dia, index) in ventasSemana" :key="index">
                        <div>
                            <div class="flex items-center justify-between text-sm mb-1">
                                <span class="font-semibold" x-text="dia.dia"></span>
                                <span class="text-primary font-bold" x-text="formatearPrecio(dia.total)"></span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
                                <div class="bg-gradient-to-r from-secondary to-primary h-full transition-all duration-500"
                                     :style="`width: ${(dia.total / maxVentaSemana * 100)}%`"></div>
                            </div>
                        </div>
                    </template>
                </div>
            </template>
        </div>
        
        <!-- Productos Más Vendidos -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4 flex items-center justify-between">
                <span>
                    <i class="fas fa-fire mr-2 text-danger"></i>
                    Top 5 Productos
                </span>
                <a href="{% url 'gestion:reportes_productos' %}" class="text-sm text-primary hover:underline">
                    Ver todos
                </a>
            </h2>
            
            <template x-if="cargando">
                <div class="space-y-3">
                    <template x-for="i in 5" :key="i">
                        <div class="skeleton h-16 w-full"></div>
                    </template>
                </div>
            </template>
            
            <template x-if="!cargando">
                <div class="space-y-3">
                    <template x-for="(producto, index) in productosMasVendidos" :key="producto.id">
                        <div class="flex items-center gap-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <!-- Ranking -->
                            <div class="w-8 h-8 flex items-center justify-center rounded-full font-bold text-white"
                                 :class="{
                                     'bg-yellow-500': index === 0,
                                     'bg-gray-400': index === 1,
                                     'bg-orange-600': index === 2,
                                     'bg-gray-300 text-gray-700': index > 2
                                 }">
                                <span x-text="index + 1"></span>
                            </div>
                            
                            <!-- Producto -->
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold truncate" x-text="producto.nombre"></p>
                                <p class="text-sm text-gray-500">
                                    <span x-text="producto.cantidad"></span> unidades
                                </p>
                            </div>
                            
                            <!-- Total -->
                            <div class="text-right">
                                <p class="font-bold text-primary" x-text="formatearPrecio(producto.total)"></p>
                            </div>
                        </div>
                    </template>
                </div>
            </template>
        </div>
    </div>
    
    <!-- Alertas y Acciones Rápidas -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Alertas (2/3 ancho) -->
        <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">
                <i class="fas fa-bell mr-2 text-warning"></i>
                Alertas y Notificaciones
            </h2>
            
            <div class="space-y-3">
                <!-- Stock Bajo -->
                <template x-if="stats.productos_stock_bajo > 0">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle text-xl"></i>
                        <div class="flex-1">
                            <h3 class="font-bold">Productos con Stock Bajo</h3>
                            <p class="text-sm">
                                <span x-text="stats.productos_stock_bajo"></span> productos necesitan reposición.
                                <a href="{% url 'gestion:productos' %}?filtro=stock_bajo" class="link">Ver productos</a>
                            </p>
                        </div>
                    </div>
                </template>
                
                <!-- Tarjetas por vencer -->
                <template x-if="stats.tarjetas_por_vencer > 0">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle text-xl"></i>
                        <div class="flex-1">
                            <h3 class="font-bold">Tarjetas por Vencer</h3>
                            <p class="text-sm">
                                <span x-text="stats.tarjetas_por_vencer"></span> tarjetas vencen en 30 días.
                                <a href="{% url 'gestion:tarjetas' %}?filtro=por_vencer" class="link">Ver tarjetas</a>
                            </p>
                        </div>
                    </div>
                </template>
                
                <!-- Todo OK -->
                <template x-if="!cargando && stats.productos_stock_bajo === 0 && stats.tarjetas_por_vencer === 0">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle text-xl"></i>
                        <span>Todo en orden. No hay alertas pendientes.</span>
                    </div>
                </template>
            </div>
        </div>
        
        <!-- Acciones Rápidas (1/3 ancho) -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">
                <i class="fas fa-bolt mr-2 text-warning"></i>
                Acciones Rápidas
            </h2>
            
            <div class="space-y-3">
                <a href="{% url 'gestion:productos_crear' %}" 
                   class="btn btn-primary btn-sm w-full justify-start">
                    <i class="fas fa-plus-circle mr-2"></i>
                    Nuevo Producto
                </a>
                
                <a href="{% url 'gestion:clientes_crear' %}" 
                   class="btn btn-secondary btn-sm w-full justify-start">
                    <i class="fas fa-user-plus mr-2"></i>
                    Nuevo Cliente
                </a>
                
                <a href="{% url 'gestion:reportes_ventas' %}" 
                   class="btn btn-outline btn-sm w-full justify-start">
                    <i class="fas fa-file-download mr-2"></i>
                    Exportar Ventas
                </a>
                
                <a href="{% url 'gestion:inventario' %}" 
                   class="btn btn-outline btn-sm w-full justify-start">
                    <i class="fas fa-boxes mr-2"></i>
                    Gestionar Inventario
                </a>
            </div>
        </div>
    </div>
    
    <!-- Últimas Transacciones -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-bold mb-4 flex items-center justify-between">
            <span>
                <i class="fas fa-history mr-2 text-primary"></i>
                Últimas Transacciones
            </span>
            <a href="{% url 'gestion:transacciones' %}" class="text-sm text-primary hover:underline">
                Ver todas
            </a>
        </h2>
        
        <template x-if="cargando">
            <div class="overflow-x-auto">
                <table class="table w-full">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>Tipo</th>
                            <th>Cliente</th>
                            <th>Detalle</th>
                            <th class="text-right">Monto</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="i in 5" :key="i">
                            <tr>
                                <td><div class="skeleton h-4 w-16"></div></td>
                                <td><div class="skeleton h-4 w-20"></div></td>
                                <td><div class="skeleton h-4 w-32"></div></td>
                                <td><div class="skeleton h-4 w-40"></div></td>
                                <td><div class="skeleton h-4 w-24"></div></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </template>
        
        <template x-if="!cargando">
            <div class="overflow-x-auto">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>Tipo</th>
                            <th>Cliente</th>
                            <th>Detalle</th>
                            <th class="text-right">Monto</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="tx in transacciones" :key="tx.id">
                            <tr class="hover">
                                <td class="font-mono text-sm" x-text="tx.hora"></td>
                                <td>
                                    <span class="badge badge-sm" 
                                          :class="{
                                              'badge-success': tx.tipo === 'recarga',
                                              'badge-primary': tx.tipo === 'venta',
                                              'badge-error': tx.tipo === 'ajuste'
                                          }">
                                        <span x-text="tx.tipo"></span>
                                    </span>
                                </td>
                                <td x-text="tx.cliente"></td>
                                <td class="text-sm text-gray-600 dark:text-gray-400" x-text="tx.detalle"></td>
                                <td class="text-right font-bold" 
                                    :class="tx.tipo === 'recarga' ? 'text-success' : 'text-primary'"
                                    x-text="formatearPrecio(tx.monto)"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </template>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
function dashboardGestion() {
    return {
        cargando: true,
        fechaActual: '',
        stats: {
            ventas_hoy: 0,
            monto_ventas_hoy: 0,
            productos_activos: 0,
            productos_stock_bajo: 0,
            total_estudiantes: 0,
            tarjetas_activas: 0,
            recargas_hoy: 0,
            monto_recargas_hoy: 0,
            tarjetas_por_vencer: 0
        },
        ventasSemana: [],
        maxVentaSemana: 0,
        productosMasVendidos: [],
        transacciones: [],
        
        async init() {
            this.actualizarFecha();
            await this.cargarDatos();
            this.cargando = false;
            
            // Auto-refresh cada 60 segundos
            setInterval(() => this.cargarDatos(), 60000);
        },
        
        actualizarFecha() {
            const ahora = new Date();
            const opciones = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            this.fechaActual = ahora.toLocaleDateString('es-PY', opciones);
        },
        
        async cargarDatos() {
            try {
                const response = await fetch('/api/gestion/dashboard/stats/');
                const data = await response.json();
                
                if (data.success) {
                    this.stats = data.stats;
                    this.ventasSemana = data.ventas_semana || [];
                    this.productosMasVendidos = data.productos_mas_vendidos || [];
                    this.transacciones = data.transacciones || [];
                    
                    // Calcular máximo para gráfico
                    if (this.ventasSemana.length > 0) {
                        this.maxVentaSemana = Math.max(...this.ventasSemana.map(d => d.total));
                    }
                }
            } catch (error) {
                console.error('Error al cargar datos:', error);
            }
        },
        
        formatearPrecio(monto) {
            return gestionHelpers.formatPrice(monto);
        }
    }
}
</script>
{% endblock %}
