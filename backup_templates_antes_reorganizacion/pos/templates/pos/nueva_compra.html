{% extends "base.html" %}
{% load humanize %}

{% block title %}Nueva Compra{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto" x-data="nuevaCompraApp()">
    <div class="mb-6">
        <a href="{% url 'pos:compras_dashboard' %}" class="btn btn-ghost btn-sm mb-2">‚Üê Volver</a>
        <h1 class="text-3xl font-bold text-neutral">üìù Nueva Orden de Compra</h1>
    </div>

    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <form @submit.prevent="registrarCompra">
                <!-- Proveedor -->
                <div class="form-control mb-4">
                    <label class="label"><span class="label-text font-bold">Proveedor *</span></label>
                    <select x-model="formData.id_proveedor" class="select select-bordered" required>
                        <option value="">-- Seleccione --</option>
                        {% for proveedor in proveedores %}
                        <option value="{{ proveedor.id_proveedor }}">{{ proveedor.razon_social }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Nro Factura -->
                <div class="form-control mb-4">
                    <label class="label"><span class="label-text font-bold">Nro. Factura</span></label>
                    <input type="text" x-model="formData.nro_factura" class="input input-bordered" placeholder="001-001-0000123">
                </div>

                <!-- Items -->
                <div class="mb-6">
                    <h3 class="text-xl font-bold mb-4">Productos</h3>
                    <template x-for="(item, index) in formData.items" :key="index">
                        <div class="grid grid-cols-12 gap-2 mb-2">
                            <div class="col-span-5">
                                <select x-model="item.id_producto" class="select select-bordered select-sm w-full" required>
                                    <option value="">-- Producto --</option>
                                    {% for producto in productos %}
                                    <option value="{{ producto.id_producto }}">{{ producto.descripcion }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-span-2">
                                <input type="number" x-model="item.cantidad" @input="calcularSubtotal(item)" class="input input-bordered input-sm w-full" placeholder="Cant" min="1" required>
                            </div>
                            <div class="col-span-3">
                                <input type="number" x-model="item.precio_compra" @input="calcularSubtotal(item)" class="input input-bordered input-sm w-full" placeholder="Precio" min="0" required>
                            </div>
                            <div class="col-span-2 flex items-center">
                                <span class="font-mono text-sm" x-text="formatearMoneda(item.subtotal)"></span>
                                <button type="button" @click="eliminarItem(index)" class="btn btn-ghost btn-xs ml-2">üóëÔ∏è</button>
                            </div>
                        </div>
                    </template>
                    <button type="button" @click="agregarItem" class="btn btn-sm btn-outline mt-2">‚ûï Agregar Producto</button>
                </div>

                <!-- Totales -->
                <div class="bg-base-200 p-4 rounded-lg mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold">Subtotal:</span>
                        <span class="font-mono text-lg" x-text="formatearMoneda(calcularTotal())"></span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold">IVA (10%):</span>
                        <span class="font-mono text-lg" x-text="formatearMoneda(calcularIVA())"></span>
                    </div>
                    <div class="divider my-2"></div>
                    <div class="flex justify-between items-center">
                        <span class="text-xl font-bold">TOTAL:</span>
                        <span class="font-mono text-2xl font-bold text-primary" x-text="formatearMoneda(calcularTotalFinal())"></span>
                    </div>
                </div>

                <!-- Observaciones -->
                <div class="form-control mb-4">
                    <label class="label"><span class="label-text font-bold">Observaciones</span></label>
                    <textarea x-model="formData.observaciones" class="textarea textarea-bordered" rows="3"></textarea>
                </div>

                <div class="flex justify-end gap-2">
                    <a href="{% url 'pos:compras_dashboard' %}" class="btn btn-ghost">Cancelar</a>
                    <button type="submit" class="btn btn-primary" :disabled="loading">
                        <span x-show="!loading">üíæ Guardar Compra</span>
                        <span x-show="loading" class="loading loading-spinner"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function nuevaCompraApp() {
    return {
        formData: {
            id_proveedor: '',
            nro_factura: '',
            items: [{id_producto: '', cantidad: 1, precio_compra: 0, subtotal: 0}],
            observaciones: '',
            subtotal: 0,
            iva: 0,
            total: 0
        },
        loading: false,
        
        agregarItem() {
            this.formData.items.push({id_producto: '', cantidad: 1, precio_compra: 0, subtotal: 0});
        },
        
        eliminarItem(index) {
            this.formData.items.splice(index, 1);
        },
        
        calcularSubtotal(item) {
            item.subtotal = (parseFloat(item.cantidad) || 0) * (parseFloat(item.precio_compra) || 0);
        },
        
        calcularTotal() {
            return this.formData.items.reduce((sum, item) => sum + (item.subtotal || 0), 0);
        },
        
        calcularIVA() {
            return this.calcularTotal() * 0.1;
        },
        
        calcularTotalFinal() {
            return this.calcularTotal() + this.calcularIVA();
        },
        
        formatearMoneda(valor) {
            return 'Gs. ' + (valor || 0).toLocaleString('es-PY');
        },
        
        async registrarCompra() {
            if (!this.formData.id_proveedor) {
                alert('Debe seleccionar un proveedor');
                return;
            }
            
            if (this.formData.items.length === 0 || !this.formData.items[0].id_producto) {
                alert('Debe agregar al menos un producto');
                return;
            }
            
            this.loading = true;
            
            const data = {
                ...this.formData,
                subtotal: this.calcularTotal(),
                iva: this.calcularIVA(),
                total: this.calcularTotalFinal()
            };
            
            try {
                const response = await fetch('{% url "pos:nueva_compra" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(result.mensaje);
                    window.location.href = '{% url "pos:compras_dashboard" %}';
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error de conexi√≥n');
                console.error(error);
            } finally {
                this.loading = false;
            }
        }
    }
}
</script>
{% endblock %}
