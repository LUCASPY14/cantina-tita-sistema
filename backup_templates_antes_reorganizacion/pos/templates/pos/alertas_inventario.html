{% extends 'base.html' %}
{% load static %}

{% block title %}Alertas de Inventario{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold flex items-center gap-2">
                üîî Alertas de Inventario
                <span class="badge badge-error badge-lg">{{ total_alertas }}</span>
            </h1>
            <p class="text-base-content/70">Productos que requieren atenci√≥n</p>
        </div>
        
        <div class="flex gap-2">
            <a href="{% url 'pos:inventario_dashboard' %}" class="btn btn-ghost">
                ‚Üê Dashboard
            </a>
            <a href="{% url 'pos:ajuste_inventario' %}" class="btn btn-primary">
                ‚öôÔ∏è Ajustar Stock
            </a>
        </div>
    </div>

    <!-- Estad√≠sticas de Alertas -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="stat bg-error text-error-content shadow-lg rounded-lg">
            <div class="stat-figure text-4xl opacity-50">‚ùå</div>
            <div class="stat-title text-error-content/80">Sin Stock</div>
            <div class="stat-value">{{ productos_sin_stock.count }}</div>
            <div class="stat-desc text-error-content/70">Cr√≠tico - Requiere reposici√≥n inmediata</div>
        </div>

        <div class="stat bg-warning text-warning-content shadow-lg rounded-lg">
            <div class="stat-figure text-4xl opacity-50">‚ö†Ô∏è</div>
            <div class="stat-title text-warning-content/80">Stock Bajo</div>
            <div class="stat-value">{{ productos_stock_bajo.count }}</div>
            <div class="stat-desc text-warning-content/70">Menor al stock m√≠nimo</div>
        </div>

        <div class="stat bg-error text-error-content shadow-lg rounded-lg animate-pulse">
            <div class="stat-figure text-4xl opacity-50">üö®</div>
            <div class="stat-title text-error-content/80">Cr√≠ticos</div>
            <div class="stat-value">{{ productos_criticos.count }}</div>
            <div class="stat-desc text-error-content/70">Menos del 50% del m√≠nimo</div>
        </div>
    </div>

    <!-- Productos Cr√≠ticos (Menos del 50% del m√≠nimo) -->
    {% if productos_criticos %}
    <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
            <h2 class="card-title text-error">
                üö® Productos en Estado Cr√≠tico
                <span class="badge badge-error">{{ productos_criticos.count }}</span>
            </h2>
            <p class="text-sm text-base-content/70 mb-4">
                Estos productos tienen menos del 50% del stock m√≠nimo requerido
            </p>
            
            <div class="overflow-x-auto">
                <table class="table table-zebra">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Descripci√≥n</th>
                            <th>Categor√≠a</th>
                            <th>Stock Actual</th>
                            <th>Stock M√≠nimo</th>
                            <th>% del M√≠nimo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for producto in productos_criticos %}
                        <tr class="hover">
                            <td class="font-mono text-xs">{{ producto.codigo }}</td>
                            <td class="font-semibold">{{ producto.descripcion }}</td>
                            <td>
                                <span class="badge badge-outline">
                                    {{ producto.id_categoria.descripcion|default:"Sin categor√≠a" }}
                                </span>
                            </td>
                            <td>
                                <span class="badge badge-error font-bold">
                                    {{ producto.stock.stock_actual }} {{ producto.id_unidad.simbolo }}
                                </span>
                            </td>
                            <td>{{ producto.stock_minimo }} {{ producto.id_unidad.simbolo }}</td>
                            <td>
                                {% widthratio producto.stock.stock_actual producto.stock_minimo 100 as porcentaje %}
                                <div class="badge badge-error">{{ porcentaje }}%</div>
                            </td>
                            <td>
                                <div class="flex gap-1">
                                    <a href="{% url 'pos:kardex_producto' producto.id_producto %}" 
                                       class="btn btn-xs btn-ghost"
                                       title="Ver Kardex">
                                        üìã
                                    </a>
                                    <a href="{% url 'pos:ajuste_inventario' %}?producto={{ producto.id_producto }}" 
                                       class="btn btn-xs btn-primary"
                                       title="Ajustar Stock">
                                        ‚öôÔ∏è
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Productos Sin Stock -->
    {% if productos_sin_stock %}
    <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
            <h2 class="card-title text-error">
                ‚ùå Productos Sin Stock
                <span class="badge badge-error">{{ productos_sin_stock.count }}</span>
            </h2>
            <p class="text-sm text-base-content/70 mb-4">
                Productos agotados que necesitan reposici√≥n urgente
            </p>
            
            <div class="overflow-x-auto">
                <table class="table table-zebra">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Descripci√≥n</th>
                            <th>Categor√≠a</th>
                            <th>Stock M√≠nimo</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for producto in productos_sin_stock %}
                        <tr class="hover">
                            <td class="font-mono text-xs">{{ producto.codigo }}</td>
                            <td class="font-semibold">{{ producto.descripcion }}</td>
                            <td>
                                <span class="badge badge-outline">
                                    {{ producto.id_categoria.descripcion|default:"Sin categor√≠a" }}
                                </span>
                            </td>
                            <td>
                                {% if producto.stock_minimo %}
                                {{ producto.stock_minimo }} {{ producto.id_unidad.simbolo }}
                                {% else %}
                                <span class="text-base-content/50">No definido</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge badge-error">
                                    {{ producto.stock.stock_actual }} {{ producto.id_unidad.simbolo }}
                                </span>
                            </td>
                            <td>
                                <div class="flex gap-1">
                                    <a href="{% url 'pos:kardex_producto' producto.id_producto %}" 
                                       class="btn btn-xs btn-ghost"
                                       title="Ver Kardex">
                                        üìã
                                    </a>
                                    <a href="{% url 'pos:ajuste_inventario' %}?producto={{ producto.id_producto }}" 
                                       class="btn btn-xs btn-primary"
                                       title="Ajustar Stock">
                                        ‚öôÔ∏è
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Productos con Stock Bajo -->
    {% if productos_stock_bajo %}
    <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
            <h2 class="card-title text-warning">
                ‚ö†Ô∏è Productos con Stock Bajo
                <span class="badge badge-warning">{{ productos_stock_bajo.count }}</span>
            </h2>
            <p class="text-sm text-base-content/70 mb-4">
                Productos por debajo del stock m√≠nimo configurado
            </p>
            
            <div class="overflow-x-auto">
                <table class="table table-zebra">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Descripci√≥n</th>
                            <th>Categor√≠a</th>
                            <th>Stock Actual</th>
                            <th>Stock M√≠nimo</th>
                            <th>Diferencia</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for producto in productos_stock_bajo %}
                        <tr class="hover">
                            <td class="font-mono text-xs">{{ producto.codigo }}</td>
                            <td class="font-semibold">{{ producto.descripcion }}</td>
                            <td>
                                <span class="badge badge-outline">
                                    {{ producto.id_categoria.descripcion|default:"Sin categor√≠a" }}
                                </span>
                            </td>
                            <td>
                                <span class="badge badge-warning font-bold">
                                    {{ producto.stock.stock_actual }} {{ producto.id_unidad.simbolo }}
                                </span>
                            </td>
                            <td>{{ producto.stock_minimo }} {{ producto.id_unidad.simbolo }}</td>
                            <td>
                                {% widthratio producto.stock_minimo 1 1 as minimo %}
                                {% widthratio producto.stock.stock_actual 1 1 as actual %}
                                <span class="text-error font-bold">
                                    -{{ minimo|add:"-"|add:actual|floatformat:0 }} {{ producto.id_unidad.simbolo }}
                                </span>
                            </td>
                            <td>
                                <div class="flex gap-1">
                                    <a href="{% url 'pos:kardex_producto' producto.id_producto %}" 
                                       class="btn btn-xs btn-ghost"
                                       title="Ver Kardex">
                                        üìã
                                    </a>
                                    <a href="{% url 'pos:ajuste_inventario' %}?producto={{ producto.id_producto }}" 
                                       class="btn btn-xs btn-primary"
                                       title="Ajustar Stock">
                                        ‚öôÔ∏è
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Sin Alertas -->
    {% if total_alertas == 0 %}
    <div class="card bg-success text-success-content shadow-xl">
        <div class="card-body text-center py-12">
            <p class="text-6xl mb-4">‚úÖ</p>
            <h2 class="text-2xl font-bold mb-2">¬°Todo en orden!</h2>
            <p>No hay productos con alertas de stock</p>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
