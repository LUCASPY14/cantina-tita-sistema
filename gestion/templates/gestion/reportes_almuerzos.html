{% extends 'base.html' %}
{% load static %}

{% block title %}Reportes de Almuerzos{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6" x-data="reportesAlmuerzos()">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800">
            <i class="fas fa-chart-bar text-purple-500 mr-2"></i>
            Reportes y Estadísticas de Almuerzos
        </h1>
        <p class="text-gray-600 mt-2">Análisis detallado del servicio de almuerzos</p>
    </div>

    <!-- Filtros de Período -->
    <div class="card bg-base-100 shadow-md mb-6">
        <div class="card-body">
            <h3 class="text-lg font-semibold mb-4">Filtros de Período</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Fecha Desde</span>
                    </label>
                    <input type="date" x-model="filtros.fechaDesde" class="input input-bordered" />
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Fecha Hasta</span>
                    </label>
                    <input type="date" x-model="filtros.fechaHasta" class="input input-bordered" />
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Tipo de Reporte</span>
                    </label>
                    <select x-model="filtros.tipoReporte" class="select select-bordered">
                        <option value="general">General</option>
                        <option value="consumo">Por Consumo</option>
                        <option value="ingresos">Por Ingresos</option>
                        <option value="asistencia">Por Asistencia</option>
                        <option value="planes">Por Planes</option>
                    </select>
                </div>
                <div class="form-control">
                    <label class="label invisible">Acción</label>
                    <button @click="generarReporte()" class="btn btn-primary w-full">
                        <i class="fas fa-sync mr-2"></i>Actualizar
                    </button>
                </div>
            </div>

            <div class="flex gap-2 mt-4">
                <button @click="setearMesActual()" class="btn btn-sm btn-outline">
                    <i class="fas fa-calendar-alt mr-2"></i>Mes Actual
                </button>
                <button @click="setearUltimos30Dias()" class="btn btn-sm btn-outline">
                    <i class="fas fa-calendar-week mr-2"></i>Últimos 30 días
                </button>
                <button @click="setearAnioActual()" class="btn btn-sm btn-outline">
                    <i class="fas fa-calendar mr-2"></i>Año Actual
                </button>
            </div>
        </div>
    </div>

    <!-- Estadísticas Principales -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-figure text-primary">
                    <i class="fas fa-utensils text-3xl"></i>
                </div>
                <div class="stat-title">Total Consumos</div>
                <div class="stat-value text-primary">{{ estadisticas.total_consumos }}</div>
                <div class="stat-desc">En el período</div>
            </div>
        </div>

        <div class="stats shadow">
            <div class="stat">
                <div class="stat-figure text-success">
                    <i class="fas fa-dollar-sign text-3xl"></i>
                </div>
                <div class="stat-title">Ingresos Totales</div>
                <div class="stat-value text-success">${{ estadisticas.ingresos_totales|floatformat:0 }}</div>
                <div class="stat-desc">Facturado</div>
            </div>
        </div>

        <div class="stats shadow">
            <div class="stat">
                <div class="stat-figure text-info">
                    <i class="fas fa-percentage text-3xl"></i>
                </div>
                <div class="stat-title">Tasa de Asistencia</div>
                <div class="stat-value text-info">{{ estadisticas.tasa_asistencia|floatformat:1 }}%</div>
                <div class="stat-desc">Promedio</div>
            </div>
        </div>

        <div class="stats shadow">
            <div class="stat">
                <div class="stat-figure text-warning">
                    <i class="fas fa-users text-3xl"></i>
                </div>
                <div class="stat-title">Promedio Diario</div>
                <div class="stat-value text-warning">{{ estadisticas.promedio_diario|floatformat:0 }}</div>
                <div class="stat-desc">Almuerzos/día</div>
            </div>
        </div>
    </div>

    <!-- Tabs de Reportes -->
    <div role="tablist" class="tabs tabs-lifted mb-4">
        <!-- Tab: Consumo por Día -->
        <input type="radio" name="reporte_tabs" role="tab" class="tab" aria-label="Consumo Diario" checked />
        <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Consumo por Día</h2>
                <button @click="exportarExcel('consumo')" class="btn btn-sm btn-success">
                    <i class="fas fa-file-excel mr-2"></i>Exportar
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="table table-zebra">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Día Semana</th>
                            <th>Suscripciones Activas</th>
                            <th>Consumos Registrados</th>
                            <th>Tasa Asistencia</th>
                            <th>Ingreso del Día</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dia in reporte_consumo_diario %}
                        <tr>
                            <td class="font-semibold">{{ dia.fecha|date:"d/m/Y" }}</td>
                            <td>{{ dia.dia_semana }}</td>
                            <td>
                                <div class="badge badge-ghost">{{ dia.suscripciones_activas }}</div>
                            </td>
                            <td>
                                <div class="badge badge-primary">{{ dia.consumos }}</div>
                            </td>
                            <td>
                                <div class="flex items-center gap-2">
                                    <progress class="progress progress-success w-24" 
                                              value="{{ dia.tasa_asistencia }}" max="100"></progress>
                                    <span>{{ dia.tasa_asistencia|floatformat:1 }}%</span>
                                </div>
                            </td>
                            <td class="font-bold">${{ dia.ingreso|floatformat:0 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-gray-500">No hay datos disponibles</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="font-bold">
                            <td colspan="3">TOTALES</td>
                            <td><div class="badge badge-primary badge-lg">{{ estadisticas.total_consumos }}</div></td>
                            <td>{{ estadisticas.tasa_asistencia|floatformat:1 }}%</td>
                            <td>${{ estadisticas.ingresos_totales|floatformat:0 }}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Tab: Reporte por Planes -->
        <input type="radio" name="reporte_tabs" role="tab" class="tab" aria-label="Por Planes" />
        <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Análisis por Planes</h2>
                <button @click="exportarExcel('planes')" class="btn btn-sm btn-success">
                    <i class="fas fa-file-excel mr-2"></i>Exportar
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 mb-6">
                {% for plan in reporte_por_planes %}
                <div class="card bg-gradient-to-br from-blue-50 to-blue-100 shadow">
                    <div class="card-body">
                        <h3 class="card-title">{{ plan.nombre_plan }}</h3>
                        <div class="badge badge-primary">{{ plan.tipo_plan }}</div>
                        
                        <div class="space-y-2 mt-4">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Suscripciones:</span>
                                <span class="font-bold">{{ plan.total_suscripciones }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Activas:</span>
                                <span class="font-bold text-success">{{ plan.activas }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Total Consumos:</span>
                                <span class="font-bold">{{ plan.total_consumos }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Precio Plan:</span>
                                <span class="font-semibold">${{ plan.precio|floatformat:0 }}</span>
                            </div>
                            <div class="divider my-1"></div>
                            <div class="flex justify-between text-lg">
                                <span class="font-semibold">Total Ingresos:</span>
                                <span class="font-bold text-primary">${{ plan.total_ingresos|floatformat:0 }}</span>
                            </div>
                        </div>

                        <div class="card-actions justify-end mt-4">
                            <button @click="verDetallePlan({{ plan.id_plan }})" class="btn btn-sm btn-primary">
                                Ver Detalle
                            </button>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-span-3 text-center text-gray-500">
                    No hay datos de planes
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Tab: Top Consumidores -->
        <input type="radio" name="reporte_tabs" role="tab" class="tab" aria-label="Top Estudiantes" />
        <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6">
            <h2 class="text-xl font-bold mb-4">Top Estudiantes por Consumo</h2>

            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Ranking</th>
                            <th>Estudiante</th>
                            <th>Grado</th>
                            <th>Plan</th>
                            <th>Días Consumidos</th>
                            <th>% Asistencia</th>
                            <th>Total Pagado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for est in top_estudiantes %}
                        <tr>
                            <td>
                                <div class="avatar placeholder">
                                    <div class="bg-primary text-white rounded-full w-10">
                                        <span>{{ forloop.counter }}</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="font-bold">{{ est.estudiante.nombres }} {{ est.estudiante.apellidos }}</div>
                                <div class="text-sm opacity-50">{{ est.estudiante.codigo }}</div>
                            </td>
                            <td>
                                <span class="badge badge-ghost">{{ est.estudiante.grado }}</span>
                            </td>
                            <td>{{ est.plan }}</td>
                            <td>
                                <div class="badge badge-primary badge-lg">{{ est.dias_consumidos }}</div>
                            </td>
                            <td>
                                <div class="flex items-center gap-2">
                                    <progress class="progress progress-success w-20" 
                                              value="{{ est.porcentaje_asistencia }}" max="100"></progress>
                                    <span>{{ est.porcentaje_asistencia|floatformat:0 }}%</span>
                                </div>
                            </td>
                            <td class="font-bold">${{ est.total_pagado|floatformat:0 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-gray-500">No hay datos</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Análisis de Ingresos -->
        <input type="radio" name="reporte_tabs" role="tab" class="tab" aria-label="Ingresos" />
        <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-6">
            <h2 class="text-xl font-bold mb-4">Análisis de Ingresos</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Ingresos Mensuales -->
                <div class="card bg-base-100 border shadow">
                    <div class="card-body">
                        <h3 class="card-title">Ingresos Mensuales</h3>
                        <div class="h-64 flex items-center justify-center text-gray-400">
                            <div class="text-center">
                                <i class="fas fa-chart-line text-5xl mb-4"></i>
                                <p>Gráfico de ingresos mensuales</p>
                                <p class="text-sm">(Implementación con Chart.js)</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Distribución por Plan -->
                <div class="card bg-base-100 border shadow">
                    <div class="card-body">
                        <h3 class="card-title">Distribución por Plan</h3>
                        <div class="h-64 flex items-center justify-center text-gray-400">
                            <div class="text-center">
                                <i class="fas fa-chart-pie text-5xl mb-4"></i>
                                <p>Gráfico de distribución</p>
                                <p class="text-sm">(Implementación con Chart.js)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla de Ingresos Mensuales -->
            <div class="overflow-x-auto">
                <table class="table table-zebra">
                    <thead>
                        <tr>
                            <th>Mes</th>
                            <th>Suscripciones</th>
                            <th>Total Facturado</th>
                            <th>Total Cobrado</th>
                            <th>Pendiente</th>
                            <th>% Efectividad</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mes in ingresos_mensuales %}
                        <tr>
                            <td class="font-semibold">{{ mes.mes_nombre }} {{ mes.anio }}</td>
                            <td>{{ mes.suscripciones }}</td>
                            <td class="font-bold">${{ mes.facturado|floatformat:0 }}</td>
                            <td class="text-success">${{ mes.cobrado|floatformat:0 }}</td>
                            <td class="text-warning">${{ mes.pendiente|floatformat:0 }}</td>
                            <td>
                                <div class="flex items-center gap-2">
                                    <progress class="progress progress-primary w-24" 
                                              value="{{ mes.efectividad }}" max="100"></progress>
                                    <span>{{ mes.efectividad|floatformat:1 }}%</span>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center text-gray-500">No hay datos</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Botones de Exportación -->
    <div class="card bg-base-100 shadow-md">
        <div class="card-body">
            <h3 class="text-lg font-semibold mb-4">Exportar Reportes</h3>
            <div class="flex flex-wrap gap-2">
                <button @click="exportarPDF()" class="btn btn-error">
                    <i class="fas fa-file-pdf mr-2"></i>Exportar a PDF
                </button>
                <button @click="exportarExcel('completo')" class="btn btn-success">
                    <i class="fas fa-file-excel mr-2"></i>Exportar a Excel
                </button>
                <button @click="exportarCSV()" class="btn btn-info">
                    <i class="fas fa-file-csv mr-2"></i>Exportar a CSV
                </button>
                <button @click="imprimirReporte()" class="btn btn-ghost">
                    <i class="fas fa-print mr-2"></i>Imprimir
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function reportesAlmuerzos() {
    return {
        filtros: {
            fechaDesde: '',
            fechaHasta: '',
            tipoReporte: 'general'
        },

        init() {
            this.setearMesActual();
        },

        setearMesActual() {
            const hoy = new Date();
            const primerDia = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            const ultimoDia = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
            
            this.filtros.fechaDesde = primerDia.toISOString().split('T')[0];
            this.filtros.fechaHasta = ultimoDia.toISOString().split('T')[0];
        },

        setearUltimos30Dias() {
            const hoy = new Date();
            const hace30 = new Date();
            hace30.setDate(hace30.getDate() - 30);
            
            this.filtros.fechaDesde = hace30.toISOString().split('T')[0];
            this.filtros.fechaHasta = hoy.toISOString().split('T')[0];
        },

        setearAnioActual() {
            const hoy = new Date();
            this.filtros.fechaDesde = `${hoy.getFullYear()}-01-01`;
            this.filtros.fechaHasta = `${hoy.getFullYear()}-12-31`;
        },

        generarReporte() {
            const params = new URLSearchParams(this.filtros);
            window.location.href = '{% url "pos:reportes_almuerzos" %}?' + params.toString();
        },

        async exportarPDF() {
            alert('Exportación a PDF en desarrollo');
        },

        async exportarExcel(tipo) {
            alert(`Exportación a Excel (${tipo}) en desarrollo`);
        },

        async exportarCSV() {
            alert('Exportación a CSV en desarrollo');
        },

        imprimirReporte() {
            window.print();
        },

        verDetallePlan(planId) {
            alert(`Ver detalle del plan ${planId} - En desarrollo`);
        }
    }
}
</script>

<style>
@media print {
    .btn, .tabs, nav, footer {
        display: none !important;
    }
}
</style>
{% endblock %}
