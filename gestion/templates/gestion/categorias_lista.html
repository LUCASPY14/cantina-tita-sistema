{% extends 'base.html' %}
{% load static %}

{% block title %}Gestión de Categorías - Sistema de Gestión{% endblock %}

{% block extra_css %}
<style>
    .categoria-card {
        @apply bg-base-100 rounded-lg p-4 shadow hover:shadow-lg transition-shadow;
    }
    .categoria-principal {
        @apply border-l-4 border-primary;
    }
    .categoria-hijo {
        @apply ml-8 border-l-4 border-secondary;
    }
    .categoria-badge {
        @apply badge badge-sm;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Breadcrumb -->
    <div class="text-sm breadcrumbs mb-4">
        <ul>
            <li><a href="{% url 'dashboard' %}">Dashboard</a></li>
            <li>Categorías</li>
        </ul>
    </div>

    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">
            <i class="fas fa-folder-tree mr-2"></i>Gestión de Categorías
        </h1>
        
        <a href="{% url 'crear_categoria' %}" class="btn btn-primary">
            <i class="fas fa-plus mr-2"></i>
            Nueva Categoría
        </a>
    </div>

    <!-- Estadísticas -->
    <div class="stats shadow mb-6 w-full">
        <div class="stat">
            <div class="stat-figure text-primary">
                <i class="fas fa-folder text-3xl"></i>
            </div>
            <div class="stat-title">Total Categorías</div>
            <div class="stat-value text-primary">{{ categorias.count }}</div>
        </div>
        
        <div class="stat">
            <div class="stat-figure text-secondary">
                <i class="fas fa-layer-group text-3xl"></i>
            </div>
            <div class="stat-title">Categorías Principales</div>
            <div class="stat-value text-secondary">{{ categorias_principales.count }}</div>
        </div>
    </div>

    <!-- Lista de Categorías -->
    {% if categorias_principales %}
        <div class="space-y-4">
            {% for categoria in categorias_principales %}
                <!-- Categoría Principal -->
                <div class="categoria-card categoria-principal">
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold">
                                <i class="fas fa-folder-open text-primary mr-2"></i>
                                {{ categoria.nombre }}
                            </h3>
                            <div class="text-sm text-base-content/70 mt-1">
                                {{ categoria.productos.count }} producto(s)
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <a href="{% url 'editar_categoria' categoria.id_categoria %}" 
                               class="btn btn-sm btn-ghost">
                                <i class="fas fa-edit"></i>
                            </a>
                            
                            <button onclick="confirmarEliminar('{{ categoria.nombre }}', '{% url 'eliminar_categoria' categoria.id_categoria %}')"
                                    class="btn btn-sm btn-ghost text-error">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Subcategorías -->
                    {% if categoria.subcategorias.all %}
                        <div class="mt-4 space-y-2">
                            {% for subcategoria in categoria.subcategorias.all %}
                                <div class="categoria-card categoria-hijo">
                                    <div class="flex justify-between items-center">
                                        <div class="flex-1">
                                            <h4 class="font-medium">
                                                <i class="fas fa-folder text-secondary mr-2"></i>
                                                {{ subcategoria.nombre }}
                                                <span class="categoria-badge badge-secondary ml-2">Subcategoría</span>
                                            </h4>
                                            <div class="text-sm text-base-content/70 mt-1">
                                                {{ subcategoria.productos.count }} producto(s)
                                            </div>
                                        </div>
                                        
                                        <div class="flex gap-2">
                                            <a href="{% url 'editar_categoria' subcategoria.id_categoria %}" 
                                               class="btn btn-sm btn-ghost">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            
                                            <button onclick="confirmarEliminar('{{ subcategoria.nombre }}', '{% url 'eliminar_categoria' subcategoria.id_categoria %}')"
                                                    class="btn btn-sm btn-ghost text-error">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- Estado vacío -->
        <div class="hero min-h-[400px] bg-base-200 rounded-lg">
            <div class="hero-content text-center">
                <div class="max-w-md">
                    <i class="fas fa-folder-open text-6xl text-base-content/30 mb-4"></i>
                    <h2 class="text-2xl font-bold mb-4">No hay categorías registradas</h2>
                    <p class="mb-6">Comienza creando tu primera categoría para organizar los productos.</p>
                    <a href="{% url 'crear_categoria' %}" class="btn btn-primary">
                        <i class="fas fa-plus mr-2"></i>
                        Crear Primera Categoría
                    </a>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Modal de Confirmación -->
<dialog id="modalEliminar" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">
            <i class="fas fa-triangle-exclamation text-warning mr-2"></i>
            Confirmar Eliminación
        </h3>
        <p class="py-4">
            ¿Estás seguro de que deseas eliminar la categoría <strong id="nombreCategoria"></strong>?
        </p>
        <p class="text-sm text-warning">
            <i class="fas fa-info-circle mr-1"></i>
            Esta acción no se puede deshacer. Si la categoría tiene productos asociados, no podrá eliminarse.
        </p>
        <div class="modal-action">
            <form id="formEliminar" method="post">
                {% csrf_token %}
                <button type="submit" class="btn btn-error">
                    <i class="fas fa-trash mr-2"></i>
                    Eliminar
                </button>
            </form>
            <button type="button" class="btn" onclick="modalEliminar.close()">Cancelar</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

{% endblock %}

{% block extra_js %}
<script>
function confirmarEliminar(nombre, url) {
    document.getElementById('nombreCategoria').textContent = nombre;
    document.getElementById('formEliminar').action = url;
    modalEliminar.showModal();
}
</script>
{% endblock %}
