{% extends 'base.html' %}
{% load static %}

{% block title %}Gesti√≥n de Grados - Estudiantes{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-7xl">
    
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">üéì Gesti√≥n de Grados</h1>
            <p class="text-gray-600 mt-2">Asignar grados y promocionar estudiantes</p>
        </div>
        <div class="flex gap-2">
            <a href="{% url 'pos:historial_grados' %}" class="btn btn-outline">
                üìú Ver Historial
            </a>
            <a href="{% url 'pos:venta' %}" class="btn btn-outline">
                ‚Üê Volver al POS
            </a>
        </div>
    </div>

    <!-- Estad√≠sticas -->
    <div class="stats stats-vertical lg:stats-horizontal shadow mb-8 w-full">
        <div class="stat">
            <div class="stat-title">Total Estudiantes</div>
            <div class="stat-value text-primary">{{ hijos.count }}</div>
        </div>
        
        <div class="stat">
            <div class="stat-title">Sin Grado Asignado</div>
            <div class="stat-value text-warning">{{ sin_grado }}</div>
        </div>
        
        <div class="stat">
            <div class="stat-title">A√±o Escolar</div>
            <div class="stat-value text-secondary">{{ anio_actual }}</div>
        </div>
    </div>

    <!-- Promoci√≥n Masiva -->
    <div class="card bg-base-100 shadow-lg mb-6">
        <div class="card-body">
            <h2 class="card-title">üìà Promoci√≥n Masiva</h2>
            <p class="text-sm text-gray-600">Promocionar todos los estudiantes de un grado al siguiente nivel</p>
            
            <div class="flex gap-4 items-end mt-4">
                <div class="form-control flex-1">
                    <label class="label">
                        <span class="label-text">Seleccionar grado a promocionar</span>
                    </label>
                    <select id="gradoPromocion" class="select select-bordered w-full">
                        <option value="">-- Seleccione --</option>
                        {% for grado in grados %}
                        <option value="{{ grado.nombre_grado }}">{{ grado.nombre_grado }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <button onclick="promocionarGrado()" class="btn btn-primary">
                    üöÄ Promocionar Grado
                </button>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card bg-base-100 shadow-lg mb-6">
        <div class="card-body">
            <form method="get" class="flex flex-wrap gap-4 items-end">
                <div class="form-control flex-1 min-w-[200px]">
                    <label class="label">
                        <span class="label-text">üîç Buscar estudiante</span>
                    </label>
                    <input type="text" name="buscar" value="{{ buscar }}" 
                           placeholder="Nombre, apellido o tarjeta..." 
                           class="input input-bordered w-full">
                </div>
                
                <div class="form-control min-w-[200px]">
                    <label class="label">
                        <span class="label-text">üìö Filtrar por grado</span>
                    </label>
                    <select name="grado" class="select select-bordered w-full">
                        <option value="">Todos los grados</option>
                        <option value="__sin_grado__" {% if grado_filtro == '__sin_grado__' %}selected{% endif %}>Sin grado asignado</option>
                        {% for grado in grados %}
                        <option value="{{ grado.nombre_grado }}" {% if grado_filtro == grado.nombre_grado %}selected{% endif %}>
                            {{ grado.nombre_grado }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    Buscar
                </button>
                
                {% if buscar or grado_filtro %}
                <a href="{% url 'pos:gestionar_grados' %}" class="btn btn-ghost">
                    Limpiar
                </a>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Lista de Estudiantes -->
    <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
            <h2 class="card-title mb-4">üë• Estudiantes ({{ hijos.count }})</h2>
            
            <div class="overflow-x-auto">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr>
                            <th>Estudiante</th>
                            <th>Tarjeta</th>
                            <th>Grado Actual</th>
                            <th>Responsable</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for hijo in hijos %}
                        <tr>
                            <td>
                                <div class="font-bold">{{ hijo.nombre_completo }}</div>
                                {% if hijo.fecha_nacimiento %}
                                <div class="text-sm text-gray-500">{{ hijo.fecha_nacimiento|date:"d/m/Y" }}</div>
                                {% endif %}
                            </td>
                            <td>
                                {% if hijo.tarjeta %}
                                <span class="badge badge-outline">{{ hijo.tarjeta.nro_tarjeta }}</span>
                                {% else %}
                                <span class="text-gray-400">Sin tarjeta</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if hijo.grado %}
                                <span class="badge badge-primary">{{ hijo.grado }}</span>
                                {% else %}
                                <span class="badge badge-warning">Sin asignar</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="text-sm">
                                    {{ hijo.id_cliente_responsable.nombres }} {{ hijo.id_cliente_responsable.apellidos }}
                                </div>
                            </td>
                            <td>
                                <button onclick="abrirModalAsignar({{ hijo.id_hijo }}, '{{ hijo.nombre_completo|escapejs }}', '{{ hijo.grado|default:'' }}')" 
                                        class="btn btn-sm btn-primary">
                                    Asignar Grado
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center text-gray-500 py-8">
                                No se encontraron estudiantes
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- Modal Asignar Grado -->
<dialog id="modalAsignarGrado" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-2xl mb-4">üìö Asignar Grado</h3>
        <p class="mb-4">Estudiante: <span id="nombreHijoModal" class="font-semibold"></span></p>
        
        <form id="formAsignarGrado">
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Seleccionar grado</span>
                </label>
                <select id="gradoSelect" class="select select-bordered w-full" required>
                    <option value="">-- Seleccione un grado --</option>
                    {% for grado in grados %}
                    <option value="{{ grado.nombre_grado }}">{{ grado.nombre_grado }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Observaciones (opcional)</span>
                </label>
                <textarea id="observaciones" class="textarea textarea-bordered" 
                          placeholder="Motivo del cambio..."></textarea>
            </div>
            
            <div class="flex gap-4">
                <button type="submit" class="btn btn-primary flex-1">
                    Guardar
                </button>
                <button type="button" onclick="cerrarModalAsignar()" class="btn btn-outline">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

{% endblock %}

{% block extra_js %}
<script>
let hijoIdActual = null;

function abrirModalAsignar(hijoId, nombreCompleto, gradoActual) {
    hijoIdActual = hijoId;
    document.getElementById('nombreHijoModal').textContent = nombreCompleto;
    document.getElementById('gradoSelect').value = gradoActual || '';
    document.getElementById('observaciones').value = '';
    document.getElementById('modalAsignarGrado').showModal();
}

function cerrarModalAsignar() {
    document.getElementById('modalAsignarGrado').close();
}

document.getElementById('formAsignarGrado').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const grado = document.getElementById('gradoSelect').value;
    const observaciones = document.getElementById('observaciones').value;
    
    if (!grado) {
        alert('Debe seleccionar un grado');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('grado', grado);
        formData.append('observaciones', observaciones);
        
        const response = await fetch(`/pos/hijo/${hijoIdActual}/asignar-grado/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ ' + data.message);
            cerrarModalAsignar();
            location.reload();
        } else {
            alert('‚ùå ' + data.message);
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al asignar grado');
    }
});

async function promocionarGrado() {
    const grado = document.getElementById('gradoPromocion').value;
    
    if (!grado) {
        alert('Debe seleccionar un grado');
        return;
    }
    
    if (!confirm(`¬øPromocionar TODOS los estudiantes de ${grado} al siguiente grado?`)) {
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('grado_actual', grado);
        
        const response = await fetch('/pos/admin/grados/promocionar/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ ' + data.message);
            location.reload();
        } else {
            alert('‚ùå ' + data.message);
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al promocionar grado');
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
