<!-- Modal de Autorización de Saldo Negativo -->
<div class="modal fade" id="modalAutorizarSaldoNegativo" tabindex="-1" aria-labelledby="modalAutorizarSaldoNegativoLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalAutorizarSaldoNegativoLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Autorización Requerida - Saldo Insuficiente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            
            <div class="modal-body">
                <!-- Información de la tarjeta y deuda -->
                <div class="alert alert-warning border-warning" role="alert">
                    <div class="row mb-2">
                        <div class="col-6">
                            <strong>Tarjeta:</strong>
                        </div>
                        <div class="col-6 text-end">
                            <span id="auth-tarjeta-numero"></span>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <strong>Estudiante:</strong>
                        </div>
                        <div class="col-6 text-end">
                            <span id="auth-estudiante-nombre"></span>
                        </div>
                    </div>
                    <hr class="my-2">
                    <div class="row mb-2">
                        <div class="col-6">
                            <strong>Saldo Actual:</strong>
                        </div>
                        <div class="col-6 text-end">
                            <span class="text-success" id="auth-saldo-actual"></span>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <strong>Total de Venta:</strong>
                        </div>
                        <div class="col-6 text-end">
                            <span class="text-primary" id="auth-total-venta"></span>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <strong class="text-danger">Faltante:</strong>
                        </div>
                        <div class="col-6 text-end">
                            <span class="text-danger fw-bold" id="auth-faltante"></span>
                        </div>
                    </div>
                    <hr class="my-2">
                    <div class="row">
                        <div class="col-6">
                            <strong class="text-danger">Saldo Resultante:</strong>
                        </div>
                        <div class="col-6 text-end">
                            <span class="text-danger fw-bold fs-5" id="auth-saldo-resultante"></span>
                        </div>
                    </div>
                </div>

                <!-- Mensaje sobre límite de crédito -->
                <div class="alert alert-info border-info mb-3" id="auth-limite-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="auth-mensaje-limite"></span>
                </div>

                <!-- Formulario de autorización -->
                <form id="formAutorizacionSaldo">
                    <div class="mb-3">
                        <label for="supervisor-select" class="form-label">
                            <i class="fas fa-user-shield me-2"></i>
                            <strong>Supervisor que Autoriza</strong>
                        </label>
                        <select class="form-select" id="supervisor-select" required>
                            <option value="">Seleccione un supervisor...</option>
                            {% for supervisor in supervisores %}
                            <option value="{{ supervisor.id_empleado }}" data-nombre="{{ supervisor.nombre }} {{ supervisor.apellido }}">
                                {{ supervisor.nombre }} {{ supervisor.apellido }} - {{ supervisor.id_rol.nombre_rol }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="supervisor-password" class="form-label">
                            <i class="fas fa-lock me-2"></i>
                            <strong>Contraseña del Supervisor</strong>
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="supervisor-password" placeholder="Ingrese contraseña" required>
                            <button class="btn btn-outline-secondary" type="button" id="toggle-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <small class="text-muted">Por seguridad, se requiere validación de identidad</small>
                    </div>

                    <div class="mb-3">
                        <label for="motivo-autorizacion" class="form-label">
                            <i class="fas fa-comment-dots me-2"></i>
                            <strong>Motivo de la Autorización</strong>
                        </label>
                        <textarea class="form-control" id="motivo-autorizacion" rows="3" placeholder="Ejemplo: Padre autoriza compra vía telefónica" required minlength="10"></textarea>
                        <div class="form-text">Mínimo 10 caracteres. Será registrado en el sistema.</div>
                    </div>

                    <!-- Mensaje de error -->
                    <div class="alert alert-danger d-none" id="auth-error-message" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <span id="auth-error-text"></span>
                    </div>

                    <!-- Mensaje de éxito -->
                    <div class="alert alert-success d-none" id="auth-success-message" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        <span id="auth-success-text"></span>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btn-cancelar-auth">
                    <i class="fas fa-times me-2"></i>
                    Cancelar Venta
                </button>
                <button type="button" class="btn btn-warning" id="btn-autorizar-venta">
                    <i class="fas fa-check-circle me-2"></i>
                    Autorizar Venta con Saldo Negativo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript del Modal -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('modalAutorizarSaldoNegativo');
    const modalInstance = new bootstrap.Modal(modal);
    
    // Toggle mostrar/ocultar contraseña
    document.getElementById('toggle-password').addEventListener('click', function() {
        const passwordInput = document.getElementById('supervisor-password');
        const icon = this.querySelector('i');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            passwordInput.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    });

    // Limpiar formulario al cerrar
    modal.addEventListener('hidden.bs.modal', function() {
        document.getElementById('formAutorizacionSaldo').reset();
        document.getElementById('auth-error-message').classList.add('d-none');
        document.getElementById('auth-success-message').classList.add('d-none');
    });

    // Función global para abrir el modal (será llamada desde el POS)
    window.abrirModalAutorizacion = function(datosVenta) {
        // Llenar información de la venta
        document.getElementById('auth-tarjeta-numero').textContent = datosVenta.nro_tarjeta;
        document.getElementById('auth-estudiante-nombre').textContent = datosVenta.estudiante_nombre || 'N/A';
        document.getElementById('auth-saldo-actual').textContent = formatearGuaranies(datosVenta.saldo_actual);
        document.getElementById('auth-total-venta').textContent = formatearGuaranies(datosVenta.total_venta);
        document.getElementById('auth-faltante').textContent = formatearGuaranies(datosVenta.faltante);
        
        const saldoResultante = datosVenta.saldo_actual - datosVenta.total_venta;
        document.getElementById('auth-saldo-resultante').textContent = formatearGuaranies(saldoResultante);
        
        // Mostrar mensaje de límite
        document.getElementById('auth-mensaje-limite').textContent = datosVenta.mensaje_limite || '';
        
        // Guardar datos para usar al autorizar
        modal.dataset.datosVenta = JSON.stringify(datosVenta);
        
        // Mostrar modal
        modalInstance.show();
    };

    // Función global para cerrar el modal
    window.cerrarModalAutorizacion = function() {
        modalInstance.hide();
    };

    // Evento de autorizar venta
    document.getElementById('btn-autorizar-venta').addEventListener('click', async function() {
        const form = document.getElementById('formAutorizacionSaldo');
        
        // Validar formulario
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const datosVenta = JSON.parse(modal.dataset.datosVenta);
        const supervisorSelect = document.getElementById('supervisor-select');
        const supervisorId = supervisorSelect.value;
        const supervisorNombre = supervisorSelect.options[supervisorSelect.selectedIndex].dataset.nombre;
        const password = document.getElementById('supervisor-password').value;
        const motivo = document.getElementById('motivo-autorizacion').value;

        // Ocultar mensajes previos
        document.getElementById('auth-error-message').classList.add('d-none');
        document.getElementById('auth-success-message').classList.add('d-none');

        // Deshabilitar botón mientras procesa
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Autorizando...';

        try {
            // Llamar API de autorización
            const response = await fetch('{% url "pos:autorizar_saldo_negativo" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    nro_tarjeta: datosVenta.nro_tarjeta,
                    total: datosVenta.total_venta,
                    motivo: motivo,
                    id_supervisor: supervisorId,
                    password_supervisor: password
                })
            });

            const data = await response.json();

            if (data.success && data.autorizado) {
                // Mostrar mensaje de éxito
                document.getElementById('auth-success-text').textContent = 
                    `Venta autorizada por ${supervisorNombre}. Procesando venta...`;
                document.getElementById('auth-success-message').classList.remove('d-none');

                // Guardar datos de autorización para enviar con la venta
                window.datosAutorizacion = {
                    id_supervisor: supervisorId,
                    motivo: motivo,
                    timestamp: new Date().toISOString()
                };

                // Esperar 1 segundo y cerrar modal
                setTimeout(() => {
                    modalInstance.hide();
                    // Llamar función del POS para procesar venta con autorización
                    if (window.procesarVentaConAutorizacion) {
                        window.procesarVentaConAutorizacion(window.datosAutorizacion);
                    }
                }, 1500);

            } else {
                // Mostrar error
                document.getElementById('auth-error-text').textContent = 
                    data.error || 'Error al autorizar la venta';
                document.getElementById('auth-error-message').classList.remove('d-none');
                
                // Habilitar botón nuevamente
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-check-circle me-2"></i>Autorizar Venta con Saldo Negativo';
            }

        } catch (error) {
            console.error('Error:', error);
            document.getElementById('auth-error-text').textContent = 
                'Error de conexión. Intente nuevamente.';
            document.getElementById('auth-error-message').classList.remove('d-none');
            
            // Habilitar botón nuevamente
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-check-circle me-2"></i>Autorizar Venta con Saldo Negativo';
        }
    });

    // Función auxiliar para formatear guaraníes
    function formatearGuaranies(valor) {
        const numero = parseInt(valor);
        if (numero < 0) {
            return '-Gs. ' + Math.abs(numero).toLocaleString('es-PY');
        }
        return 'Gs. ' + numero.toLocaleString('es-PY');
    }

    // Función para obtener cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
