{% extends 'base.html' %}

{% block title %}Administraci√≥n de Autorizaciones | Cantina Tita{% endblock %}

{% block content %}
<div class="space-y-4">
    
    <!-- Encabezado -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-neutral">üîê Administraci√≥n de Autorizaciones</h1>
            <p class="text-gray-600">Gesti√≥n de tarjetas de autorizaci√≥n y logs de operaciones</p>
        </div>
        <div class="flex gap-2">
            <a href="{% url 'pos:logs_autorizaciones' %}" class="btn btn-outline">
                üìä Ver Logs Completos
            </a>
            <button class="btn btn-primary" onclick="modalCrearTarjeta.showModal()">
                ‚ûï Nueva Tarjeta
            </button>
        </div>
    </div>
    
    <!-- Estad√≠sticas -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-figure text-primary">
                    üé´
                </div>
                <div class="stat-title">Total Tarjetas</div>
                <div class="stat-value text-primary">{{ total_tarjetas }}</div>
            </div>
        </div>
        
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-figure text-success">
                    ‚úÖ
                </div>
                <div class="stat-title">Activas</div>
                <div class="stat-value text-success">{{ tarjetas_activas }}</div>
            </div>
        </div>
        
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-figure text-secondary">
                    üëë
                </div>
                <div class="stat-title">Administradores</div>
                <div class="stat-value text-secondary">{{ tarjetas_admin }}</div>
            </div>
        </div>
        
        <div class="stats shadow">
            <div class="stat">
                <div class="stat-figure text-info">
                    üë§
                </div>
                <div class="stat-title">Supervisores</div>
                <div class="stat-value text-info">{{ tarjetas_supervisor }}</div>
            </div>
        </div>
    </div>
    
    <!-- Lista de Tarjetas -->
    <div class="card bg-white shadow-xl">
        <div class="card-body">
            <h3 class="card-title text-lg mb-4">üé´ Tarjetas de Autorizaci√≥n</h3>
            
            <div class="overflow-x-auto">
                <table class="table table-zebra">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Tipo</th>
                            <th>Empleado</th>
                            <th>Permisos</th>
                            <th>Vencimiento</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tarjeta in tarjetas %}
                        <tr class="{% if not tarjeta.activo %}opacity-50{% endif %}">
                            <td class="font-mono font-bold">{{ tarjeta.codigo_barra }}</td>
                            <td>
                                {% if tarjeta.tipo_autorizacion == 'ADMIN' %}
                                    <span class="badge badge-error">üëë Admin</span>
                                {% elif tarjeta.tipo_autorizacion == 'SUPERVISOR' %}
                                    <span class="badge badge-warning">üë§ Supervisor</span>
                                {% else %}
                                    <span class="badge badge-ghost">{{ tarjeta.tipo_autorizacion }}</span>
                                {% endif %}
                            </td>
                            <td class="text-sm">
                                {% if tarjeta.id_empleado %}
                                    {{ tarjeta.id_empleado.nombre }} {{ tarjeta.id_empleado.apellido }}
                                {% else %}
                                    <span class="text-gray-400">Sin asignar</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="flex gap-1">
                                    {% if tarjeta.puede_anular_almuerzos %}
                                        <span class="badge badge-xs badge-success" title="Anular Almuerzos">üçΩÔ∏è</span>
                                    {% endif %}
                                    {% if tarjeta.puede_anular_ventas %}
                                        <span class="badge badge-xs badge-info" title="Anular Ventas">üõí</span>
                                    {% endif %}
                                    {% if tarjeta.puede_anular_recargas %}
                                        <span class="badge badge-xs badge-warning" title="Anular Recargas">üí≥</span>
                                    {% endif %}
                                    {% if tarjeta.puede_modificar_precios %}
                                        <span class="badge badge-xs badge-error" title="Modificar Precios">üí∞</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="text-sm">
                                {% if tarjeta.fecha_vencimiento %}
                                    {{ tarjeta.fecha_vencimiento|date:"d/m/Y" }}
                                {% else %}
                                    <span class="text-gray-400">Sin vencimiento</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if tarjeta.activo %}
                                    <span class="badge badge-success">Activa</span>
                                {% else %}
                                    <span class="badge badge-error">Inactiva</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="flex gap-1">
                                    <button class="btn btn-xs btn-outline" 
                                            onclick="editarTarjeta({{ tarjeta.id_tarjeta_autorizacion }}, '{{ tarjeta.codigo_barra }}', '{{ tarjeta.tipo_autorizacion }}', {{ tarjeta.puede_anular_almuerzos|yesno:'true,false' }}, {{ tarjeta.puede_anular_ventas|yesno:'true,false' }}, {{ tarjeta.puede_anular_recargas|yesno:'true,false' }}, {{ tarjeta.puede_modificar_precios|yesno:'true,false' }}, '{{ tarjeta.observaciones|default:'' }}', '{{ tarjeta.fecha_vencimiento|date:'Y-m-d'|default:'' }}')">
                                        ‚úèÔ∏è
                                    </button>
                                    <button class="btn btn-xs {% if tarjeta.activo %}btn-error{% else %}btn-success{% endif %}" 
                                            onclick="toggleTarjeta({{ tarjeta.id_tarjeta_autorizacion }}, '{{ tarjeta.codigo_barra }}', {{ tarjeta.activo|yesno:'true,false' }})">
                                        {% if tarjeta.activo %}‚ùå{% else %}‚úÖ{% endif %}
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-gray-400 py-8">
                                No hay tarjetas registradas
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- √öltimas Autorizaciones -->
    <div class="card bg-white shadow-xl">
        <div class="card-body">
            <h3 class="card-title text-lg mb-4">üìã √öltimas Autorizaciones (50)</h3>
            
            <div class="overflow-x-auto">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Fecha/Hora</th>
                            <th>Tarjeta</th>
                            <th>Operaci√≥n</th>
                            <th>Resultado</th>
                            <th>Descripci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in ultimos_logs %}
                        <tr>
                            <td class="text-xs">{{ log.fecha_hora|date:"d/m/Y H:i:s" }}</td>
                            <td class="font-mono text-xs">
                                {% if log.id_tarjeta_autorizacion %}
                                    {{ log.id_tarjeta_autorizacion.codigo_barra }}
                                {% else %}
                                    {{ log.codigo_barra }}
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge badge-xs">{{ log.get_tipo_operacion_display }}</span>
                            </td>
                            <td>
                                {% if log.resultado == 'EXITOSO' %}
                                    <span class="badge badge-xs badge-success">‚úÖ Exitoso</span>
                                {% elif log.resultado == 'RECHAZADO' %}
                                    <span class="badge badge-xs badge-error">‚ùå Rechazado</span>
                                {% else %}
                                    <span class="badge badge-xs badge-warning">‚ö†Ô∏è Error</span>
                                {% endif %}
                            </td>
                            <td class="text-xs max-w-md truncate">{{ log.descripcion }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center text-gray-400 py-4">
                                No hay logs registrados
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
</div>

<!-- Modal Crear Tarjeta -->
<dialog id="modalCrearTarjeta" class="modal">
    <div class="modal-box max-w-2xl">
        <h3 class="font-bold text-lg mb-4">‚ûï Nueva Tarjeta de Autorizaci√≥n</h3>
        
        <form id="formCrearTarjeta" class="space-y-4">
            {% csrf_token %}
            
            <div class="grid grid-cols-2 gap-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">C√≥digo de Barra *</span>
                    </label>
                    <input type="text" name="codigo_barra" class="input input-bordered" required 
                           placeholder="Ej: ADMIN001">
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">Tipo de Autorizaci√≥n *</span>
                    </label>
                    <select name="tipo_autorizacion" class="select select-bordered">
                        <option value="ADMIN">üëë Administrador</option>
                        <option value="SUPERVISOR" selected>üë§ Supervisor</option>
                        <option value="CAJERO">üíº Cajero</option>
                    </select>
                </div>
            </div>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-semibold">Permisos</span>
                </label>
                <div class="grid grid-cols-2 gap-2">
                    <label class="label cursor-pointer justify-start gap-2">
                        <input type="checkbox" name="puede_anular_almuerzos" class="checkbox checkbox-sm" checked>
                        <span class="label-text">üçΩÔ∏è Anular Almuerzos</span>
                    </label>
                    <label class="label cursor-pointer justify-start gap-2">
                        <input type="checkbox" name="puede_anular_ventas" class="checkbox checkbox-sm" checked>
                        <span class="label-text">üõí Anular Ventas</span>
                    </label>
                    <label class="label cursor-pointer justify-start gap-2">
                        <input type="checkbox" name="puede_anular_recargas" class="checkbox checkbox-sm" checked>
                        <span class="label-text">üí≥ Anular Recargas</span>
                    </label>
                    <label class="label cursor-pointer justify-start gap-2">
                        <input type="checkbox" name="puede_modificar_precios" class="checkbox checkbox-sm">
                        <span class="label-text">üí∞ Modificar Precios</span>
                    </label>
                </div>
            </div>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-semibold">Fecha de Vencimiento (Opcional)</span>
                </label>
                <input type="date" name="fecha_vencimiento" class="input input-bordered">
            </div>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-semibold">Observaciones</span>
                </label>
                <textarea name="observaciones" class="textarea textarea-bordered" rows="2"
                          placeholder="Informaci√≥n adicional sobre esta tarjeta..."></textarea>
            </div>
            
            <div id="mensajeCrear" class="hidden"></div>
            
            <div class="modal-action">
                <button type="button" class="btn" onclick="modalCrearTarjeta.close()">
                    Cancelar
                </button>
                <button type="submit" class="btn btn-primary">
                    ‚úÖ Crear Tarjeta
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Modal Editar Tarjeta -->
<dialog id="modalEditarTarjeta" class="modal">
    <div class="modal-box max-w-2xl">
        <h3 class="font-bold text-lg mb-4">‚úèÔ∏è Editar Tarjeta de Autorizaci√≥n</h3>
        
        <form id="formEditarTarjeta" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" id="editTarjetaId" value="">
            
            <div class="alert alert-info">
                <span>C√≥digo: <strong id="editCodigoBarra"></strong></span>
            </div>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-semibold">Tipo de Autorizaci√≥n</span>
                </label>
                <select id="editTipoAutorizacion" name="tipo_autorizacion" class="select select-bordered">
                    <option value="ADMIN">üëë Administrador</option>
                    <option value="SUPERVISOR">üë§ Supervisor</option>
                    <option value="CAJERO">üíº Cajero</option>
                </select>
            </div>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-semibold">Permisos</span>
                </label>
                <div class="grid grid-cols-2 gap-2">
                    <label class="label cursor-pointer justify-start gap-2">
                        <input type="checkbox" id="editAnularAlmuerzos" name="puede_anular_almuerzos" class="checkbox checkbox-sm">
                        <span class="label-text">üçΩÔ∏è Anular Almuerzos</span>
                    </label>
                    <label class="label cursor-pointer justify-start gap-2">
                        <input type="checkbox" id="editAnularVentas" name="puede_anular_ventas" class="checkbox checkbox-sm">
                        <span class="label-text">üõí Anular Ventas</span>
                    </label>
                    <label class="label cursor-pointer justify-start gap-2">
                        <input type="checkbox" id="editAnularRecargas" name="puede_anular_recargas" class="checkbox checkbox-sm">
                        <span class="label-text">üí≥ Anular Recargas</span>
                    </label>
                    <label class="label cursor-pointer justify-start gap-2">
                        <input type="checkbox" id="editModificarPrecios" name="puede_modificar_precios" class="checkbox checkbox-sm">
                        <span class="label-text">üí∞ Modificar Precios</span>
                    </label>
                </div>
            </div>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-semibold">Fecha de Vencimiento</span>
                </label>
                <input type="date" id="editFechaVencimiento" name="fecha_vencimiento" class="input input-bordered">
            </div>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-semibold">Observaciones</span>
                </label>
                <textarea id="editObservaciones" name="observaciones" class="textarea textarea-bordered" rows="2"></textarea>
            </div>
            
            <div id="mensajeEditar" class="hidden"></div>
            
            <div class="modal-action">
                <button type="button" class="btn" onclick="modalEditarTarjeta.close()">
                    Cancelar
                </button>
                <button type="submit" class="btn btn-primary">
                    üíæ Guardar Cambios
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
// Crear tarjeta
document.getElementById('formCrearTarjeta').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const mensajeDiv = document.getElementById('mensajeCrear');
    
    try {
        const response = await fetch('{% url "pos:crear_tarjeta_autorizacion" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            mensajeDiv.className = 'alert alert-success';
            mensajeDiv.textContent = '‚úÖ ' + data.message;
            mensajeDiv.classList.remove('hidden');
            
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            mensajeDiv.className = 'alert alert-error';
            mensajeDiv.textContent = '‚ùå ' + data.message;
            mensajeDiv.classList.remove('hidden');
        }
    } catch (error) {
        mensajeDiv.className = 'alert alert-error';
        mensajeDiv.textContent = '‚ùå Error al crear tarjeta';
        mensajeDiv.classList.remove('hidden');
        console.error(error);
    }
});

// Editar tarjeta
function editarTarjeta(id, codigo, tipo, almuerzos, ventas, recargas, precios, obs, venc) {
    document.getElementById('editTarjetaId').value = id;
    document.getElementById('editCodigoBarra').textContent = codigo;
    document.getElementById('editTipoAutorizacion').value = tipo;
    document.getElementById('editAnularAlmuerzos').checked = almuerzos;
    document.getElementById('editAnularVentas').checked = ventas;
    document.getElementById('editAnularRecargas').checked = recargas;
    document.getElementById('editModificarPrecios').checked = precios;
    document.getElementById('editObservaciones').value = obs;
    document.getElementById('editFechaVencimiento').value = venc;
    
    modalEditarTarjeta.showModal();
}

document.getElementById('formEditarTarjeta').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const tarjetaId = document.getElementById('editTarjetaId').value;
    const formData = new FormData(this);
    const mensajeDiv = document.getElementById('mensajeEditar');
    
    try {
        const response = await fetch(`/pos/admin/autorizaciones/editar/${tarjetaId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            mensajeDiv.className = 'alert alert-success';
            mensajeDiv.textContent = '‚úÖ ' + data.message;
            mensajeDiv.classList.remove('hidden');
            
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            mensajeDiv.className = 'alert alert-error';
            mensajeDiv.textContent = '‚ùå ' + data.message;
            mensajeDiv.classList.remove('hidden');
        }
    } catch (error) {
        mensajeDiv.className = 'alert alert-error';
        mensajeDiv.textContent = '‚ùå Error al editar tarjeta';
        mensajeDiv.classList.remove('hidden');
        console.error(error);
    }
});

// Toggle tarjeta
async function toggleTarjeta(id, codigo, activo) {
    const accion = activo ? 'desactivar' : 'activar';
    
    if (!confirm(`¬øEst√° seguro de ${accion} la tarjeta ${codigo}?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/pos/admin/autorizaciones/toggle/${id}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            location.reload();
        } else {
            alert('‚ùå ' + data.message);
        }
    } catch (error) {
        alert('‚ùå Error al cambiar estado de tarjeta');
        console.error(error);
    }
}
</script>

{% endblock %}
