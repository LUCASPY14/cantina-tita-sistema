{% extends 'base_portal.html' %}

{% block title %}T√©rminos y Condiciones - Saldo Negativo{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3><i class="fas fa-file-contract"></i> T√©rminos y Condiciones - Uso de Saldo Negativo</h3>
                </div>
                
                <div class="card-body">
                    {% if ya_acepto %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> <strong>Usted ya acept√≥ estos t√©rminos</strong><br>
                        Fecha de aceptaci√≥n: {{ aceptacion.fecha_aceptacion|date:"d/m/Y H:i" }}<br>
                        Versi√≥n: {{ aceptacion.version_terminos }}
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Por favor lea atentamente los siguientes t√©rminos antes de activar el saldo negativo.
                    </div>
                    {% endif %}
                    
                    <div id="terminos-contenido" style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; padding: 20px; background: #f9f9f9;">
                        <h4>T√âRMINOS Y CONDICIONES PARA USO DE SALDO NEGATIVO</h4>
                        <p><strong>Versi√≥n:</strong> 1.0 | <strong>Vigencia:</strong> Enero 2026</p>
                        
                        <hr>
                        
                        <h5>1. DEFINICIONES</h5>
                        <p>
                            <strong>Saldo Negativo:</strong> Es el cr√©dito otorgado por Cantina Tita que permite al hijo realizar compras 
                            cuando el saldo de su tarjeta es insuficiente, generando una deuda que debe ser regularizada mediante recarga posterior.
                        </p>
                        <p>
                            <strong>L√≠mite de Cr√©dito:</strong> Es el monto m√°ximo que el hijo puede deber (saldo negativo m√°ximo permitido).
                        </p>
                        <p>
                            <strong>Regularizaci√≥n:</strong> Acci√≥n de recargar saldo para cubrir la deuda pendiente.
                        </p>
                        
                        <h5>2. CONDICIONES DE USO</h5>
                        <ol>
                            <li>El saldo negativo debe ser autorizado por un supervisor de la cantina en cada ocasi√≥n.</li>
                            <li>El l√≠mite de cr√©dito es de <strong>Gs. {{ limite_credito|default:"50.000" }}</strong> por tarjeta.</li>
                            <li>La deuda debe ser regularizada en un plazo m√°ximo de <strong>15 d√≠as</strong> desde la autorizaci√≥n.</li>
                            <li>El padre/madre responsable se compromete a recargar la tarjeta dentro del plazo establecido.</li>
                        </ol>
                        
                        <h5>3. PROCESO DE AUTORIZACI√ìN</h5>
                        <ol>
                            <li>Cuando el hijo no tiene saldo suficiente, el cajero solicita autorizaci√≥n a un supervisor.</li>
                            <li>El supervisor eval√∫a la situaci√≥n y, si corresponde, autoriza la venta con saldo negativo.</li>
                            <li>Se registra la autorizaci√≥n con motivo, fecha, hora y datos del supervisor.</li>
                            <li>El padre/madre recibe una notificaci√≥n autom√°tica por email y/o WhatsApp.</li>
                        </ol>
                        
                        <h5>4. REGULARIZACI√ìN DE DEUDA</h5>
                        <ol>
                            <li>Al realizar una recarga, el sistema aplica autom√°ticamente el monto a la deuda pendiente.</li>
                            <li>El saldo sobrante despu√©s de pagar la deuda queda disponible para futuras compras.</li>
                            <li>Si la recarga no cubre la deuda completa, se aplica parcialmente y la deuda restante persiste.</li>
                            <li>Recibir√° una notificaci√≥n confirmando la regularizaci√≥n del saldo.</li>
                        </ol>
                        
                        <h5>5. NOTIFICACIONES</h5>
                        <p>El padre/madre responsable recibir√° notificaciones autom√°ticas en las siguientes situaciones:</p>
                        <ul>
                            <li><strong>Saldo bajo:</strong> Cuando el saldo es menor al umbral configurado.</li>
                            <li><strong>Saldo negativo:</strong> Inmediatamente despu√©s de cada autorizaci√≥n de compra con saldo negativo.</li>
                            <li><strong>Recordatorios:</strong> A los 3, 7 y 15 d√≠as de tener deuda pendiente.</li>
                            <li><strong>Bloqueo:</strong> Si la tarjeta es bloqueada por morosidad.</li>
                            <li><strong>Regularizaci√≥n:</strong> Cuando se regulariza la deuda mediante recarga.</li>
                        </ul>
                        
                        <h5>6. CONSECUENCIAS DE INCUMPLIMIENTO</h5>
                        <p>En caso de no regularizar la deuda en el plazo de 15 d√≠as:</p>
                        <ul>
                            <li>‚ùå La tarjeta ser√° <strong>bloqueada autom√°ticamente</strong></li>
                            <li>‚ùå El hijo NO podr√° realizar compras en la cantina</li>
                            <li>‚ùå La tarjeta permanecer√° bloqueada hasta regularizar la deuda completa</li>
                            <li>‚ö†Ô∏è Podr√°n aplicarse restricciones adicionales seg√∫n el reglamento interno</li>
                        </ul>
                        
                        <h5>7. DESBLOQUEO DE TARJETA</h5>
                        <ol>
                            <li>Para desbloquear la tarjeta, debe realizar una recarga que cubra el monto total adeudado.</li>
                            <li>El desbloqueo es autom√°tico una vez regularizada la deuda.</li>
                            <li>No se cobran costos adicionales por el desbloqueo.</li>
                        </ol>
                        
                        <h5>8. REVOCACI√ìN DE AUTORIZACI√ìN</h5>
                        <p>
                            El padre/madre puede revocar la autorizaci√≥n de saldo negativo en cualquier momento desde el portal web.
                            Una vez revocada, la tarjeta no podr√° generar nuevas deudas, pero deber√° regularizar las deudas pendientes.
                        </p>
                        
                        <h5>9. MODIFICACI√ìN DE T√âRMINOS</h5>
                        <p>
                            Cantina Tita se reserva el derecho de modificar estos t√©rminos en cualquier momento.
                            Los cambios se notificar√°n con al menos 15 d√≠as de anticipaci√≥n por email y/o portal web.
                        </p>
                        
                        <h5>10. DATOS PERSONALES</h5>
                        <p>
                            Los datos proporcionados ser√°n utilizados √∫nicamente para la gesti√≥n del servicio de saldo negativo
                            y notificaciones asociadas. No se compartir√°n con terceros.
                        </p>
                        
                        <h5>11. CONSULTAS</h5>
                        <p>
                            Para consultas sobre estos t√©rminos o el funcionamiento del sistema, puede contactarse con:
                        </p>
                        <ul>
                            <li>üìß Email: cantina@colegio.edu.py</li>
                            <li>üìû Tel√©fono: +595 981 234567</li>
                            <li>üïê Horario de atenci√≥n: Lunes a Viernes, 07:00 - 16:00</li>
                        </ul>
                        
                        <hr>
                        
                        <p><strong>DECLARACI√ìN DE ACEPTACI√ìN:</strong></p>
                        <p>
                            Al marcar la casilla de aceptaci√≥n y confirmar, declaro que:
                        </p>
                        <ul>
                            <li>‚úÖ He le√≠do y comprendido completamente estos t√©rminos y condiciones</li>
                            <li>‚úÖ Acepto las condiciones de uso del saldo negativo</li>
                            <li>‚úÖ Me comprometo a regularizar las deudas en los plazos establecidos</li>
                            <li>‚úÖ Entiendo las consecuencias del incumplimiento (bloqueo de tarjeta)</li>
                            <li>‚úÖ Autorizo el env√≠o de notificaciones por email y WhatsApp</li>
                        </ul>
                    </div>
                    
                    {% if not ya_acepto %}
                    <form method="POST" id="formAceptacion">
                        {% csrf_token %}
                        
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" id="checkbox-acepto" name="acepto" required>
                            <label class="form-check-label" for="checkbox-acepto">
                                <strong>He le√≠do y acepto los t√©rminos y condiciones</strong>
                            </label>
                        </div>
                        
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="checkbox-notificaciones" name="acepto_notificaciones" required>
                            <label class="form-check-label" for="checkbox-notificaciones">
                                Autorizo el env√≠o de notificaciones por email y WhatsApp
                            </label>
                        </div>
                        
                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-exclamation-triangle"></i> 
                            <strong>Importante:</strong> Esta aceptaci√≥n quedar√° registrada con su IP, fecha y hora como constancia legal.
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'portal_dashboard' %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg" id="btnAceptar" disabled>
                                <i class="fas fa-check-circle"></i> Aceptar T√©rminos y Activar Saldo Negativo
                            </button>
                        </div>
                    </form>
                    {% else %}
                    <div class="mt-4">
                        <a href="{% url 'portal_dashboard' %}" class="btn btn-primary">
                            <i class="fas fa-arrow-left"></i> Volver al Dashboard
                        </a>
                        {% if puede_revocar %}
                        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalRevocar">
                            <i class="fas fa-ban"></i> Revocar Autorizaci√≥n
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                
                <div class="card-footer text-muted">
                    <small>
                        Documento legal - Cantina Tita | Versi√≥n 1.0 | Enero 2026
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Revocar -->
{% if ya_acepto and puede_revocar %}
<div class="modal fade" id="modalRevocar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Revocar Autorizaci√≥n de Saldo Negativo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>¬øEst√° seguro que desea revocar la autorizaci√≥n?</strong></p>
                <p>Al revocar:</p>
                <ul>
                    <li>‚ùå La tarjeta NO podr√° generar nuevas deudas</li>
                    <li>‚ö†Ô∏è Deber√° regularizar las deudas pendientes existentes</li>
                    <li>üîÑ Podr√° volver a aceptar los t√©rminos en el futuro si lo desea</li>
                </ul>
            </div>
            <div class="modal-footer">
                <form method="POST" action="{% url 'portal_revocar_terminos' %}">
                    {% csrf_token %}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Confirmar Revocaci√≥n</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Habilitar bot√≥n solo si acepta ambos checkboxes
document.addEventListener('DOMContentLoaded', function() {
    const checkboxAcepto = document.getElementById('checkbox-acepto');
    const checkboxNotif = document.getElementById('checkbox-notificaciones');
    const btnAceptar = document.getElementById('btnAceptar');
    
    if (checkboxAcepto && checkboxNotif && btnAceptar) {
        function verificarCheckboxes() {
            btnAceptar.disabled = !(checkboxAcepto.checked && checkboxNotif.checked);
        }
        
        checkboxAcepto.addEventListener('change', verificarCheckboxes);
        checkboxNotif.addEventListener('change', verificarCheckboxes);
    }
});
</script>
{% endblock %}
