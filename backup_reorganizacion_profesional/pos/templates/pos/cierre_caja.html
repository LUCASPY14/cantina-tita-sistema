{% extends "base.html" %}
{% load humanize %}

{% block title %}Cierre de Caja{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto" x-data="cierreApp()">
    <div class="mb-6">
        <a href="{% url 'pos:cajas_dashboard' %}" class="btn btn-ghost btn-sm mb-2">‚Üê Volver</a>
        <h1 class="text-3xl font-bold text-neutral">üîí Cierre de Caja</h1>
    </div>

    {% if error %}
    <div class="alert alert-error shadow-lg mb-6">
        <span>{{ error }}</span>
    </div>
    {% else %}
    
    <!-- Informaci√≥n de la Caja -->
    <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
            <h2 class="card-title">Informaci√≥n del Turno</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p class="text-sm text-neutral/70">Caja</p>
                    <p class="font-bold">{{ caja_abierta.id_caja.descripcion }}</p>
                </div>
                <div>
                    <p class="text-sm text-neutral/70">Cajero</p>
                    <p class="font-bold">{{ caja_abierta.id_empleado.descripcion }}</p>
                </div>
                <div>
                    <p class="text-sm text-neutral/70">Apertura</p>
                    <p class="font-bold">{{ caja_abierta.fecha_apertura|date:"d/m/Y H:i" }}</p>
                </div>
                <div>
                    <p class="text-sm text-neutral/70">Monto Inicial</p>
                    <p class="font-bold text-lg">Gs. {{ caja_abierta.monto_inicial|floatformat:0|intcomma }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumen de Ventas -->
    <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
            <h2 class="card-title">Resumen de Ventas del Turno</h2>
            <div class="stats stats-vertical lg:stats-horizontal shadow w-full">
                <div class="stat">
                    <div class="stat-title">Cantidad de Ventas</div>
                    <div class="stat-value text-primary">{{ cantidad_ventas }}</div>
                </div>
                <div class="stat">
                    <div class="stat-title">Total Ventas</div>
                    <div class="stat-value text-success text-2xl">Gs. {{ total_ventas|floatformat:0|intcomma }}</div>
                </div>
                <div class="stat">
                    <div class="stat-title">Monto Esperado</div>
                    <div class="stat-value text-info text-2xl">Gs. {{ monto_esperado|floatformat:0|intcomma }}</div>
                    <div class="stat-desc">(Inicial + Ventas)</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario de Cierre -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">Conteo Final</h2>
            
            <form @submit.prevent="cerrarCaja">
                <div class="form-control mb-4">
                    <label class="label">
                        <span class="label-text font-bold">Monto Final en Caja (Gs.) *</span>
                    </label>
                    <input 
                        type="number" 
                        x-model="formData.monto_final"
                        @input="calcularDiferencia"
                        placeholder="Ingrese el monto contado"
                        class="input input-bordered input-lg w-full text-2xl"
                        min="0"
                        step="1000"
                        required
                    >
                </div>

                <!-- Diferencia Calculada -->
                <div 
                    x-show="diferencia !== null"
                    class="alert mb-4"
                    :class="{
                        'alert-success': diferencia === 0,
                        'alert-warning': diferencia > 0,
                        'alert-error': diferencia < 0
                    }"
                >
                    <div>
                        <h3 class="font-bold">Diferencia</h3>
                        <p x-text="formatearDiferencia()"></p>
                    </div>
                </div>

                <div class="form-control mb-4">
                    <label class="label">
                        <span class="label-text font-bold">Observaciones</span>
                    </label>
                    <textarea 
                        x-model="formData.observaciones"
                        class="textarea textarea-bordered h-24"
                        placeholder="Notas adicionales sobre el cierre..."
                    ></textarea>
                </div>

                <div class="flex gap-2 justify-end mt-6">
                    <a href="{% url 'pos:arqueo_caja' %}" class="btn btn-info">üíµ Ir a Arqueo</a>
                    <button type="submit" class="btn btn-warning" :disabled="loading">
                        <span x-show="!loading">üîí Cerrar Caja</span>
                        <span x-show="loading" class="loading loading-spinner"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<script>
function cierreApp() {
    return {
        formData: {
            monto_final: 0,
            observaciones: ''
        },
        loading: false,
        diferencia: null,
        montoEsperado: {{ monto_esperado|default:0 }},
        
        calcularDiferencia() {
            const final = parseFloat(this.formData.monto_final) || 0;
            this.diferencia = final - this.montoEsperado;
        },
        
        formatearDiferencia() {
            if (this.diferencia === 0) return 'Caja cuadrada ‚úì';
            if (this.diferencia > 0) return `Sobrante: Gs. ${this.diferencia.toLocaleString('es-PY')}`;
            return `Faltante: Gs. ${Math.abs(this.diferencia).toLocaleString('es-PY')}`;
        },
        
        async cerrarCaja() {
            if (!confirm('¬øConfirma el cierre de caja?')) return;
            
            this.loading = true;
            
            try {
                const response = await fetch('{% url "pos:cierre_caja" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(this.formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.mensaje + '\nDiferencia: Gs. ' + data.diferencia.toLocaleString('es-PY'));
                    window.location.href = '{% url "pos:cajas_dashboard" %}';
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error de conexi√≥n');
                console.error(error);
            } finally {
                this.loading = false;
            }
        }
    }
}
</script>
{% endblock %}
