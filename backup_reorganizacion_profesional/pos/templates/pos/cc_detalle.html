{% extends "base.html" %}
{% load static %}

{% block title %}Detalle Cuenta Corriente - {{ cliente.descripcion }}{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        @apply bg-white rounded-lg shadow-md p-6;
    }
    .stat-value {
        @apply text-3xl font-bold;
    }
    .tab-content {
        @apply hidden;
    }
    .tab-content.active {
        @apply block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6" x-data="cuentaCorrienteApp()">
    
    <!-- Header con informaci√≥n del cliente -->
    <div class="mb-6">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">
                    Cuenta Corriente
                </h1>
                <h2 class="text-xl text-gray-600">{{ cliente.descripcions }} {{ cliente.apellidos }}</h2>
                <p class="text-gray-500">RUC/CI: {{ cliente.ruc_ci|default:"No registrado" }}</p>
                {% if cliente.razon_social %}
                <p class="text-gray-500">Raz√≥n Social: {{ cliente.razon_social }}</p>
                {% endif %}
            </div>
            <div class="text-right">
                <a href="{% url 'pos:cc_estado_cuenta' cliente.id_cliente %}" 
                   class="btn btn-outline btn-sm" target="_blank">
                    üìÑ Estado de Cuenta
                </a>
                <a href="{% url 'pos:cuenta_corriente' %}" class="btn btn-ghost btn-sm">
                    ‚Üê Volver
                </a>
            </div>
        </div>
    </div>

    <!-- Estad√≠sticas principales -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        
        <!-- L√≠mite de cr√©dito -->
        <div class="stat-card">
            <div class="stat-title text-gray-600">L√≠mite de Cr√©dito</div>
            <div class="stat-value text-blue-600">
                Gs. {{ cliente.limite_credito|floatformat:0|default:"0" }}
            </div>
        </div>

        <!-- Total ventas -->
        <div class="stat-card">
            <div class="stat-title text-gray-600">Total Ventas</div>
            <div class="stat-value text-orange-600">
                Gs. {{ total_ventas|floatformat:0 }}
            </div>
        </div>

        <!-- Total recargas -->
        <div class="stat-card">
            <div class="stat-title text-gray-600">Total Recargas</div>
            <div class="stat-value text-green-600">
                Gs. {{ total_recargas|floatformat:0 }}
            </div>
        </div>

    </div>

    <!-- Registrar Pago (Recarga) -->
    {% if hijos %}
    <div class="card bg-white shadow-lg mb-6">
        <div class="card-body">
            <h3 class="card-title text-lg mb-4">üí∞ Registrar Recarga</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Tarjeta del Hijo</span>
                    </label>
                    <select x-model="pago.tarjeta_id" class="select select-bordered w-full">
                        <option value="">Seleccione...</option>
                        {% for hijo in hijos %}
                        {% if hijo.nro_tarjeta %}
                        <option value="{{ hijo.nro_tarjeta.nro_tarjeta }}">
                            {{ hijo.descripcion }} - {{ hijo.nro_tarjeta.nro_tarjeta }}
                        </option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Monto a Recargar</span>
                    </label>
                    <input type="number" 
                           x-model="pago.monto"
                           class="input input-bordered w-full"
                           placeholder="Ingrese el monto"
                           min="1000"
                           step="1000">
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Forma de Pago</span>
                    </label>
                    <select x-model="pago.forma_pago" class="select select-bordered w-full">
                        <option value="efectivo">üíµ Efectivo</option>
                        <option value="transferencia">üè¶ Transferencia</option>
                        <option value="tarjeta_credito">üí≥ Tarjeta</option>
                    </select>
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Observaciones</span>
                    </label>
                    <input type="text" 
                           x-model="pago.observaciones"
                           class="input input-bordered w-full"
                           placeholder="Opcional"
                           value="Pago del responsable">
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text">&nbsp;</span>
                    </label>
                    <button @click="registrarPago()" 
                            class="btn btn-success w-full"
                            :disabled="!pago.monto || !pago.tarjeta_id || pago.monto < 1000">
                        <span x-show="!procesando">‚úì Recargar</span>
                        <span x-show="procesando" class="loading loading-spinner"></span>
                    </button>
                </div>
            </div>

            <!-- Botones de monto r√°pido -->
            <div class="flex gap-2 mt-4">
                <span class="text-sm text-gray-600 mr-2">Montos r√°pidos:</span>
                <template x-for="monto in [10000, 20000, 50000, 100000, 200000]" :key="monto">
                    <button @click="pago.monto = monto" 
                            class="btn btn-xs btn-outline">
                        Gs. <span x-text="monto.toLocaleString('es-PY')"></span>
                    </button>
                </template>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Tabs de informaci√≥n -->
    <div class="card bg-white shadow-lg">
        <div class="card-body">
            
            <!-- Tabs -->
            <div class="tabs tabs-boxed mb-4">
                <a class="tab tab-active" @click="activeTab = 'hijos'">
                    üë®‚Äçüë©‚Äçüëß Hijos ({{ hijos.count }})
                </a>
                <a class="tab" @click="activeTab = 'ventas'">
                    üõí Ventas ({{ ventas.count }})
                </a>
                <a class="tab" @click="activeTab = 'recargas'">
                    üí≥ Recargas ({{ recargas.count }})
                </a>
            </div>

            <!-- Tab: Hijos -->
            <div class="tab-content" :class="{ 'active': activeTab === 'hijos' }">
                <div class="overflow-x-auto">
                    <table class="table table-zebra w-full">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Grado/Curso</th>
                                <th>Tarjeta</th>
                                <th>Saldo</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for hijo in hijos %}
                            <tr>
                                <td>{{ hijo.descripcion }}</td>
                                <td>{{ hijo.grado_curso|default:"No especificado" }}</td>
                                <td>
                                    {% if hijo.nro_tarjeta %}
                                        <span class="font-mono">{{ hijo.nro_tarjeta.nro_tarjeta }}</span>
                                    {% else %}
                                        <span class="text-gray-400">Sin tarjeta</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if hijo.nro_tarjeta %}
                                        <span class="font-bold text-green-600">
                                            Gs. {{ hijo.nro_tarjeta.saldo_actual|floatformat:0 }}
                                        </span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if hijo.nro_tarjeta %}
                                        {% if hijo.nro_tarjeta.estado == 'activa' %}
                                            <span class="badge badge-success badge-sm">Activa</span>
                                        {% else %}
                                            <span class="badge badge-error badge-sm">{{ hijo.nro_tarjeta.estado }}</span>
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-gray-500">
                                    No hay hijos registrados
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: Ventas -->
            <div class="tab-content" :class="{ 'active': activeTab === 'ventas' }">
                <div class="overflow-x-auto">
                    <table class="table table-zebra w-full table-sm">
                        <thead>
                            <tr>
                                <th>Fecha/Hora</th>
                                <th>Venta #</th>
                                <th>Tarjeta</th>
                                <th>Total</th>
                                <th>Cajero</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for venta in ventas %}
                            <tr>
                                <td>
                                    {{ venta.fecha|date:"d/m/Y" }}<br>
                                    <small class="text-gray-500">{{ venta.hora|time:"H:i" }}</small>
                                </td>
                                <td>
                                    <span class="font-mono text-xs">#{{ venta.id_venta }}</span>
                                </td>
                                <td>
                                    <span class="font-mono text-xs">{{ venta.nro_tarjeta.nro_tarjeta }}</span>
                                </td>
                                <td>
                                    <span class="font-bold text-blue-600">
                                        Gs. {{ venta.total|floatformat:0 }}
                                    </span>
                                </td>
                                <td>
                                    <span class="text-xs">{{ venta.id_empleado.descripcion|default:"N/A" }}</span>
                                </td>
                                <td>
                                    <a href="{% url 'pos:ticket' venta.id_venta %}" 
                                       class="btn btn-xs btn-ghost" target="_blank">
                                        üßæ Ticket
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center text-gray-500">
                                    No hay ventas registradas
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: Recargas -->
            <div class="tab-content" :class="{ 'active': activeTab === 'recargas' }">
                <div class="overflow-x-auto">
                    <table class="table table-zebra w-full table-sm">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tarjeta</th>
                                <th>Monto</th>
                                <th>Forma de Pago</th>
                                <th>Cajero</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for recarga in recargas %}
                            <tr>
                                <td>{{ recarga.fecha|date:"d/m/Y H:i" }}</td>
                                <td>
                                    <span class="font-mono text-xs">{{ recarga.nro_tarjeta.nro_tarjeta }}</span>
                                </td>
                                <td>
                                    <span class="font-bold text-green-600">
                                        Gs. {{ recarga.monto|floatformat:0 }}
                                    </span>
                                </td>
                                <td>
                                    {% if recarga.forma_pago == 'efectivo' %}üíµ Efectivo
                                    {% elif recarga.forma_pago == 'transferencia' %}üè¶ Transferencia
                                    {% elif recarga.forma_pago == 'tarjeta_credito' %}üí≥ Tarjeta
                                    {% else %}{{ recarga.forma_pago }}
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="text-xs">{{ recarga.id_empleado.descripcion|default:"N/A" }}</span>
                                </td>
                                <td>
                                    <a href="{% url 'pos:comprobante_recarga' recarga.id_carga_saldo %}" 
                                       class="btn btn-xs btn-ghost" target="_blank">
                                        üßæ Comprobante
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center text-gray-500">
                                    No hay recargas registradas
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

</div>

<!-- Notificaciones -->
<div id="notification-container" 
     class="toast toast-top toast-end"
     style="z-index: 9999;">
</div>

<script>
function cuentaCorrienteApp() {
    return {
        activeTab: 'hijos',
        procesando: false,
        pago: {
            tarjeta_id: '',
            monto: null,
            forma_pago: 'efectivo',
            observaciones: 'Pago del responsable'
        },

        async registrarPago() {
            if (!this.pago.monto || this.pago.monto < 1000) {
                this.showNotification('El monto m√≠nimo es Gs. 1,000', 'error');
                return;
            }

            if (!this.pago.tarjeta_id) {
                this.showNotification('Seleccione una tarjeta', 'error');
                return;
            }

            if (!confirm(`¬øConfirmar recarga de Gs. ${this.pago.monto.toLocaleString('es-PY')}?`)) {
                return;
            }

            this.procesando = true;

            try {
                const response = await fetch('{% url "pos:cc_registrar_pago" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        cliente_id: {{ cliente.id_cliente }},
                        tarjeta_id: this.pago.tarjeta_id,
                        monto: this.pago.monto,
                        forma_pago: this.pago.forma_pago,
                        observaciones: this.pago.observaciones
                    })
                });

                const data = await response.json();

                if (data.success) {
                    this.showNotification(data.mensaje, 'success');
                    
                    // Reproducir sonido de √©xito
                    if (window.soundManager) {
                        window.soundManager.playSuccess();
                    }

                    // Recargar p√°gina despu√©s de 1 segundo
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    this.showNotification(data.error || 'Error al procesar la recarga', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                this.showNotification('Error de conexi√≥n', 'error');
            } finally {
                this.procesando = false;
            }
        },

        showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const alertClass = type === 'success' ? 'alert-success' : 
                             type === 'error' ? 'alert-error' : 
                             type === 'warning' ? 'alert-warning' : 'alert-info';
            
            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} shadow-lg mb-2`;
            notification.innerHTML = `<span>${message}</span>`;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
    }
}
</script>

{% endblock %}
